<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Comprehensive Knowledge of C++(V18.03)</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #cccccc; background-color: #303030; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffcfaf; } /* Alert */
    code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bn { color: #dca3a3; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #f0dfaf; } /* ControlFlow */
    code span.ch { color: #dca3a3; } /* Char */
    code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
    code span.co { color: #7f9f7f; } /* Comment */
    code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
    code span.do { color: #7f9f7f; } /* Documentation */
    code span.dt { color: #dfdfbf; } /* DataType */
    code span.dv { color: #dcdccc; } /* DecVal */
    code span.er { color: #c3bf9f; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #c0bed1; } /* Float */
    code span.fu { color: #efef8f; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
    code span.kw { color: #f0dfaf; } /* Keyword */
    code span.op { color: #f0efd0; } /* Operator */
    code span.ot { color: #efef8f; } /* Other */
    code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
    code span.sc { color: #dca3a3; } /* SpecialChar */
    code span.ss { color: #cc9393; } /* SpecialString */
    code span.st { color: #cc9393; } /* String */
    code span.va { } /* Variable */
    code span.vs { color: #cc9393; } /* VerbatimString */
    code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */

    body {
        margin: 0 auto;
        max-width: none;
        width: 1000px;
        padding-left: 50px;
        padding-right: 50px;
        padding-top: 50px;
        padding-bottom: 50px;
        hyphens: auto;
        overflow-wrap: break-word;
        text-rendering: optimizeLegibility;
        font-kerning: normal;
    }

    table {
        border-collapse: collapse;
    }

    table, th, td {
        border: 2px solid black;
    }

    header {
        margin-bottom: 4em;
        text-align: center;
        color: white;
        background-color: lightblue;
    }

    h1:not(:first-of-type) {
        page-break-before: always;
    }

  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Comprehensive Knowledge of C++(V18.03)</h1>
<p class="author">autor:ichiroprogrammer</p>
</header>
<!-- ./md/exercise_a.md -->
<h1 id="解答">解答 <a id="SS_20"></a></h1>
<h2 id="プログラミング規約型">プログラミング規約(型) <a id="SS_20_1"></a></h2>
<h3 id="解答-汎整数型の選択">解答-汎整数型の選択 <a id="SS_20_1_1"></a></h3>
<ul>
<li><p>選択肢3</p></li>
<li><p>参照 <a href="programming_convention.html#SS_3_1_1">算術型</a></p></li>
<li><p>解説<br />
代入する小さい整数に合わせて8ビット型や16ビット型を使うと、 それら同士の演算時にint昇格が起こり、わかりづらいバグを生むことがある。<br />
int32_tを使うことは、 ほとんどのコンパイラでint32_tの実際の型がintであることを利用しているため、 その前提を避けるべきと考えるのであれば、int32_tの代わりにint、 uint32_tの代わりにunsigned intを使用すればよい。</p></li>
<li><p><a href="exercise_q.html#SS_19_1_1">演習-汎整数型の選択</a>へ戻る。</p></li>
</ul>
<h3 id="解答例-汎整数型の演算">解答例-汎整数型の演算 <a id="SS_20_1_2"></a></h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 14</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, GeneralInteger)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>    {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>        <span class="co">// 以下の組み込み型の使用方法は、その下のテストコードを(環境依存で)パスするが、</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>        <span class="co">// 適切であるとは言えない。適切な型に修正せよ。</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>        <span class="dt">int32_t</span> b{<span class="dv">1</span>};</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>        <span class="dt">int32_t</span> i{b};</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>        <span class="dt">int32_t</span> c{-<span class="dv">1</span>};</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>        ASSERT_EQ(i * c, -<span class="dv">1</span>);</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_2">演習-汎整数型の演算</a>へ戻る。</li>
</ul>
<h3 id="解答例-浮動小数点型">解答例-浮動小数点型 <a id="SS_20_1_3"></a></h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 28</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>    <span class="dt">double</span> f(<span class="dt">double</span> a) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">1</span> / a; }</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> FLOAT_0, <span class="kw">typename</span> FLOAT_1&gt;</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    <span class="dt">bool</span> is_equal(FLOAT_0 lhs, FLOAT_1 rhs)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    {</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>        <span class="kw">static_assert</span>(<span class="bu">std::</span>is_floating_point_v&lt;FLOAT_0&gt;, <span class="st">&quot;FLOAT_0 shoud be float or double.&quot;</span>);</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>        <span class="kw">static_assert</span>(<span class="bu">std::</span>is_same_v&lt;FLOAT_0, FLOAT_1&gt;, <span class="st">&quot;FLOAT_0 and FLOAT_1 shoud be a same type.&quot;</span>);</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">std::</span>abs(lhs - rhs) &lt;= <span class="bu">std::</span>numeric_limits&lt;FLOAT_0&gt;::epsilon();</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    }</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, Float)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>    {</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>        <span class="co">// 以下の両辺を同一と判定するための関数を作り、その関数の単体テストを行え。</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>        ASSERT_TRUE(is_equal(<span class="fl">1.0</span>, <span class="dv">1</span> + <span class="fl">0.001</span> - <span class="fl">0.001</span>));</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>        <span class="co">// 以下の0除算を捕捉するためのコードを書け。</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>        <span class="bu">std::</span>feclearexcept(FE_ALL_EXCEPT);  <span class="co">// エラーをクリア</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>        f(<span class="fl">0.0</span>);</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>        ASSERT_TRUE(<span class="bu">std::</span>fetestexcept(FE_ALL_EXCEPT) &amp; FE_DIVBYZERO);</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>        <span class="bu">std::</span>feclearexcept(FE_ALL_EXCEPT);  <span class="co">// エラーをクリア</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_3">演習-浮動小数点型</a>へ戻る。</li>
</ul>
<h3 id="解答-定数列挙">解答-定数列挙 <a id="SS_20_1_4"></a></h3>
<ul>
<li>選択肢4</li>
<li>参照 <a href="programming_convention.html#SS_3_1_2">enum</a></li>
<li><a href="exercise_q.html#SS_19_1_4">演習-定数列挙</a>へ戻る。</li>
</ul>
<h3 id="解答例-enum">解答例-enum <a id="SS_20_1_5"></a></h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 55</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    <span class="co">// 以下のマクロ引数を型安全なenumに修正せよ</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>    <span class="kw">enum</span> <span class="kw">class</span> Color { Red, Green, Blue };</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>    <span class="bu">std::</span>string GetString(Color color)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>    {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>        <span class="cf">switch</span> (color) {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>        <span class="cf">case</span> Color::Red:</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&quot;Red&quot;</span>;</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>        <span class="cf">case</span> Color::Green:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&quot;Green&quot;</span>;</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>        <span class="cf">case</span> Color::Blue:</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&quot;Blue&quot;</span>;</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>        <span class="cf">default</span>:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>            <span class="ot">assert</span>(<span class="kw">false</span>);</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&quot;&quot;</span>;</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>        }</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>    }</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, Enum)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>    {</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>        ASSERT_EQ(<span class="bu">std::</span>string{<span class="st">&quot;Red&quot;</span>}, GetString(Color::Red));</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>        ASSERT_EQ(<span class="bu">std::</span>string{<span class="st">&quot;Green&quot;</span>}, GetString(Color::Green));</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>        ASSERT_EQ(<span class="bu">std::</span>string{<span class="st">&quot;Blue&quot;</span>}, GetString(Color::Blue));</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_5">演習-enum</a>へ戻る。</li>
</ul>
<h3 id="解答例-配列の範囲for文">解答例-配列の範囲for文 <a id="SS_20_1_6"></a></h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 84</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="dt">int32_t</span> array_value() <span class="kw">noexcept</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>        <span class="at">static</span> <span class="dt">int32_t</span> i;</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>        <span class="cf">return</span> i++;</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>    }</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, Array)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>    {</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>        <span class="co">// 以下の配列の値の設定を範囲for文を使って書き直せ</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>        <span class="dt">int32_t</span> array[<span class="dv">10</span>];</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span>&amp; a : array) {</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>            a = array_value();</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>        }</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, array[<span class="dv">0</span>]);</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, array[<span class="dv">3</span>]);</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">9</span>, array[<span class="dv">9</span>]);</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_6">演習-配列の範囲for文</a>へ戻る。</li>
</ul>
<h3 id="解答例-エイリアス">解答例-エイリアス <a id="SS_20_1_7"></a></h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 108</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>    <span class="co">// 以下のtypedefをC++11から導入された新しい形式のエイリアスに直せ。</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>    <span class="kw">using</span> <span class="ex">uchar</span>     = <span class="dt">unsigned</span> <span class="dt">char</span>;</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>    <span class="kw">using</span> <span class="dt">func_type</span> = <span class="dt">bool</span> (*)(<span class="dt">int32_t</span>);</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>    <span class="co">// template引数で与えられた型のオブジェクトをstd::vectorで保持するエイリアスtemplateを</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>    <span class="co">// 定義し、その単体テストを行え。</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">class</span> T&gt;</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>    <span class="kw">using</span> TypeVector = <span class="bu">std::</span>vector&lt;T&gt;;</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, Alias)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>    {</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>        <span class="kw">auto</span> a = TypeVector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;de&quot;</span>, <span class="st">&quot;f&quot;</span>};</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;de&quot;</span>, <span class="st">&quot;f&quot;</span>}), a);</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, a.size());</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_7">演習-エイリアス</a>へ戻る。</li>
</ul>
<h3 id="解答-constの意味">解答-constの意味 <a id="SS_20_1_8"></a></h3>
<ul>
<li>選択肢1</li>
<li>参照 <a href="programming_convention.html#SS_3_1_9">const/constexprインスタンス</a></li>
<li><a href="exercise_q.html#SS_19_1_8">演習-constの意味</a>へ戻る。</li>
</ul>
<h3 id="解答例-constconstexpr">解答例-const/constexpr <a id="SS_20_1_9"></a></h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 129</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>    <span class="co">// 下記のStringHolderに「const/constexprを付加する」等を行い、より良いコードに修正せよ。</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>    <span class="kw">class</span> StringHolder {</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>        StringHolder() = <span class="cf">default</span>;</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>        <span class="dt">void</span> Add(<span class="bu">std::</span>string <span class="at">const</span>&amp; str)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>        {</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="va">vector_len_max_</span> &gt; <span class="va">strings_</span>.size()) {</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>                <span class="va">strings_</span>.push_back(str);</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>            }</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>        }</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; GetStrings() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">strings_</span>; }</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">size_t</span>  <span class="va">vector_len_max_</span>{<span class="dv">3</span>};</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="va">strings_</span>{};</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a>    };</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, ConstConstexpr)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a>    {</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a>        <span class="kw">auto</span> sh = StringHolder{};</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a>        ASSERT_EQ(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{}, sh.GetStrings());</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a>        sh.Add(<span class="st">&quot;a&quot;</span>);</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a>        sh.Add(<span class="bu">std::</span>string{<span class="st">&quot;bc&quot;</span>});</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;a&quot;</span>, <span class="st">&quot;bc&quot;</span>}), sh.GetStrings());</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a>        sh.Add(<span class="st">&quot;def&quot;</span>);</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a>        sh.Add(<span class="bu">std::</span>string{<span class="st">&quot;g&quot;</span>});</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;a&quot;</span>, <span class="st">&quot;bc&quot;</span>, <span class="st">&quot;def&quot;</span>}), sh.GetStrings());</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_9">演習-const/constexpr</a>へ戻る。</li>
</ul>
<h3 id="解答例-危険なconst_cast">解答例-危険なconst_cast <a id="SS_20_1_10"></a></h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 166</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>    <span class="co">// 下記の&quot;DISABLED_&quot;を削除し、何が起こるのか、なぜそうなるのかを確かめた上で、</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>    <span class="co">// nameの型やその初期化を行っているコードを修正せよ。</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, ConstConstexpr2)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>    {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>        <span class="dt">char</span> name[] = <span class="st">&quot;abcdef&quot;</span>;</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span>&amp; n : name) {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>            n = <span class="bu">std::</span>toupper(n);</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>        }</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;ABCDEF&quot;</span>, name);</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;ABCDEF&quot;</span>, <span class="bu">std::</span>string{name});</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_10">演習-危険なconst_cast</a>へ戻る。</li>
</ul>
<h3 id="解答例-リテラル">解答例-リテラル <a id="SS_20_1_11"></a></h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 186</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    <span class="dt">int32_t</span> literal_test(<span class="dt">int64_t</span>) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">0</span>; }</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>    <span class="dt">int32_t</span> literal_test(<span class="dt">int32_t</span>*) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">1</span>; }</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    <span class="co">// 下記変数の初期化コードをコメントに基づき適切に修正せよ。</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, Literal)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>    {</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>        <span class="dt">int32_t</span>* p{<span class="kw">nullptr</span>};                <span class="co">// NULLは使用不可</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>        <span class="dt">uint64_t</span> a{<span class="bn">0x1234&#39;5678&#39;90ab&#39;cdef</span>};  <span class="co">// 適切なセパレータを挿入</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>        <span class="dt">int32_t</span>  b{<span class="bn">0b0111&#39;0001&#39;0101</span>};       <span class="co">// ビット表現に修正</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a>        <span class="co">// 下記resultはfalseになるが、その理由を述べ、trueになるようにコードを修正せよ。</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a>        <span class="dt">bool</span> <span class="at">const</span> result{(literal_test(<span class="kw">nullptr</span>) == literal_test(p))};</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a>        ASSERT_TRUE(result);</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a>        ASSERT_EQ(<span class="bn">0x1234567890abcdef</span>, a);</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a>        ASSERT_EQ(b, <span class="bn">0x715</span>);</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_11">演習-リテラル</a>へ戻る。</li>
</ul>
<h3 id="解答-適切なautoの使い方">解答-適切なautoの使い方 <a id="SS_20_1_12"></a></h3>
<ul>
<li>選択肢4</li>
<li>参照 <a href="programming_convention.html#SS_3_1_11_1">auto</a></li>
<li><a href="exercise_q.html#SS_19_1_12">演習-適切なautoの使い方</a>へ戻る。</li>
</ul>
<h3 id="解答-ポインタの初期化">解答-ポインタの初期化 <a id="SS_20_1_13"></a></h3>
<ul>
<li>選択肢3</li>
<li>参照 <a href="programming_convention.html#SS_3_1_10">リテラル</a></li>
<li><a href="exercise_q.html#SS_19_1_13">演習-ポインタの初期化</a>へ戻る。</li>
</ul>
<h3 id="解答-vector初期化">解答-vector初期化 <a id="SS_20_1_14"></a></h3>
<ul>
<li>選択肢1</li>
<li>参照 <a href="programming_convention.html#SS_3_1_12">インスタンスの初期化</a></li>
<li><a href="exercise_q.html#SS_19_1_14">演習-vector初期化</a>へ戻る。</li>
</ul>
<h3 id="解答例-インスタンスの初期化">解答例-インスタンスの初期化 <a id="SS_20_1_15"></a></h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/type.cpp 209</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>    TEST(ProgrammingConventionTypeA, Initialization)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>        <span class="co">// 変数a、b、v、wの定義と初期化を1文で行え。</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>        {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>            <span class="dt">int32_t</span> a[<span class="dv">3</span>]{<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>};</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, a[<span class="dv">0</span>]);</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, a[<span class="dv">1</span>]);</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, a[<span class="dv">2</span>]);</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>        }</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a>        {</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>            <span class="dt">int32_t</span> b[<span class="dv">3</span>]{};</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">0</span>, b[<span class="dv">0</span>]);</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">0</span>, b[<span class="dv">1</span>]);</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">0</span>, b[<span class="dv">2</span>]);</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>        }</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a>        {</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a>            <span class="kw">auto</span> v = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="dv">3</span>, <span class="bu">std::</span>string{<span class="st">&quot;1&quot;</span>}};</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;1&quot;</span>, v[<span class="dv">0</span>]);</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;1&quot;</span>, v[<span class="dv">1</span>]);</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;1&quot;</span>, v[<span class="dv">2</span>]);</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>        }</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>        {</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a>            <span class="kw">auto</span> w = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;0&quot;</span>, <span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>};</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;0&quot;</span>, w[<span class="dv">0</span>]);</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;1&quot;</span>, w[<span class="dv">1</span>]);</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;2&quot;</span>, w[<span class="dv">2</span>]);</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a>        }</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_1_15">演習-インスタンスの初期化</a>へ戻る。</li>
</ul>
<h2 id="プログラミング規約クラス">プログラミング規約(クラス) <a id="SS_20_2"></a></h2>
<h3 id="解答-凝集度の意味">解答-凝集度の意味 <a id="SS_20_2_1"></a></h3>
<ul>
<li>選択肢4</li>
<li>参照 <a href="programming_convention.html#SS_3_2_2_3">凝集度</a></li>
<li><a href="exercise_q.html#SS_19_2_1">演習-凝集度の意味</a>へ戻る。</li>
</ul>
<h3 id="解答例-凝集度の向上">解答例-凝集度の向上 <a id="SS_20_2_2"></a></h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/class.cpp 7</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>    <span class="co">// 以下のクラスABCの凝集度が高くなるように、ABC、HasRealNumberSolutionをリファクタリングせよ。</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>    <span class="co">// その時に、他の問題があればそれも併せて修正せよ。</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>    <span class="kw">class</span> ABC {  <span class="co">// 2次方程式のパラメータ保持</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>        <span class="kw">explicit</span> ABC(<span class="dt">int32_t</span> a, <span class="dt">int32_t</span> b, <span class="dt">int32_t</span> c) <span class="kw">noexcept</span> : <span class="va">a_</span>{a}, <span class="va">b_</span>{b}, <span class="va">c_</span>{c} {}</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>        <span class="dt">bool</span> HasRealNumberSolution() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">0</span> &lt;= discriminant(); }</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="at">const</span> <span class="va">a_</span>;</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="at">const</span> <span class="va">b_</span>;</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="at">const</span> <span class="va">c_</span>;</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a>        <span class="dt">int32_t</span> discriminant() <span class="at">const</span> <span class="kw">noexcept</span>  <span class="co">// 判定式</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>        {</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">b_</span> * <span class="va">b_</span> - <span class="dv">4</span> * <span class="va">a_</span> * <span class="va">c_</span>;</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a>        }</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a>    };</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true"></a>    <span class="dt">bool</span> HasRealNumberSolution(ABC <span class="at">const</span>&amp; abc) <span class="kw">noexcept</span> { <span class="cf">return</span> abc.HasRealNumberSolution(); }</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true"></a>    TEST(ProgrammingConventionClassA, Cohision)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true"></a>    {</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true"></a>        {</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> abc = ABC{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>};</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true"></a>            ASSERT_TRUE(HasRealNumberSolution(abc));</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true"></a>        }</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true"></a>        {</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> abc = ABC{<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>};</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true"></a>            ASSERT_FALSE(HasRealNumberSolution(abc));</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true"></a>        }</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_2_2">演習-凝集度の向上</a>へ戻る。</li>
</ul>
<h3 id="解答-メンバ変数の初期化方法の選択">解答-メンバ変数の初期化方法の選択 <a id="SS_20_2_3"></a></h3>
<ul>
<li>選択肢2</li>
<li>参照 <a href="programming_convention.html#SS_3_2_5">非静的なメンバ変数/定数の初期化</a></li>
<li><a href="exercise_q.html#SS_19_2_3">演習-メンバ変数の初期化方法の選択</a>へ戻る。</li>
</ul>
<h3 id="解答-メンバの型">解答-メンバの型 <a id="SS_20_2_4"></a></h3>
<ul>
<li>選択肢3</li>
<li>参照 <a href="programming_convention.html#SS_3_1_12">インスタンスの初期化</a></li>
<li>解説<br />
関数の宣言と、クラスのデフォルトコンストラクタ呼び出しによるオブジェクトの生成は、 プログラマを混乱させることがあるので注意が必要である。</li>
<li><a href="exercise_q.html#SS_19_2_4">演習-メンバの型</a>へ戻る。</li>
</ul>
<h3 id="解答例-メンバ変数の初期化">解答例-メンバ変数の初期化 <a id="SS_20_2_5"></a></h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/class.cpp 46</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>    <span class="co">// 以下のMemberInitのメンバ変数を適切な方法で初期化せよ。</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>    <span class="kw">class</span> MemberInit {</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>        MemberInit() <span class="kw">noexcept</span> {}</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>        <span class="kw">explicit</span> MemberInit(<span class="dt">int</span> a) <span class="kw">noexcept</span> : <span class="va">a_</span>{a}, <span class="va">b_</span>{a, <span class="dv">99</span>} {}</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>        <span class="dt">int32_t</span> GetA() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">a_</span>; }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">size_t</span> b_len{<span class="dv">2</span>};</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="at">const</span> (&amp;GetB() <span class="at">const</span> <span class="kw">noexcept</span>)[b_len] { <span class="cf">return</span> <span class="va">b_</span>; }</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a>        <span class="dt">int32_t</span> GetC() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">c_</span>; }</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="at">const</span> <span class="va">a_</span>{<span class="dv">0</span>};</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="at">const</span> <span class="va">b_</span>[b_len]{<span class="dv">1</span>, <span class="dv">1</span>};</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="at">const</span> <span class="va">c_</span>{<span class="dv">2</span>};</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a>    };</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true"></a>    TEST(ProgrammingConventionClassA, MemberInit)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true"></a>    {</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true"></a>        {</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true"></a>            <span class="kw">auto</span> mi = MemberInit{};</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">0</span>, mi.GetA());</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, mi.GetB()[<span class="dv">0</span>]);</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, mi.GetB()[<span class="dv">1</span>]);</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">2</span>, mi.GetC());</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true"></a>        }</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true"></a>        {</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true"></a>            <span class="kw">auto</span> mi = MemberInit{<span class="dv">1</span>};</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, mi.GetA());</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, mi.GetB()[<span class="dv">0</span>]);</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">99</span>, mi.GetB()[<span class="dv">1</span>]);</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">2</span>, mi.GetC());</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true"></a>        }</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_2_5">演習-メンバ変数の初期化</a>へ戻る。</li>
</ul>
<h3 id="解答例-スライシング">解答例-スライシング <a id="SS_20_2_6"></a></h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/class.cpp 89</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>    <span class="co">// 以下のクラスBaseはオブジェクトのスライシングを引き起こす。</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>    <span class="co">// このような誤用を起こさないようにするために、Baseオブジェクトのコピーを禁止せよ。</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>    <span class="co">// 合わせてクラスDerivedも含め、不十分な記述を修正せよ。</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>    <span class="kw">class</span> Base {</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>        <span class="kw">explicit</span> Base(<span class="dt">char</span> <span class="at">const</span>* name = <span class="kw">nullptr</span>) <span class="kw">noexcept</span> : <span class="va">name_</span>{name == <span class="kw">nullptr</span> ? <span class="st">&quot;Base&quot;</span> : name} {}</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Base() = <span class="cf">default</span>;</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">char</span> <span class="at">const</span>* Name0() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="st">&quot;Base&quot;</span>; }</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>*         Name1() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name_</span>; }</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>        Base&amp; <span class="kw">operator</span>=(Base <span class="at">const</span>&amp; rhs) = <span class="kw">delete</span>;</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>        Base(Base <span class="at">const</span>&amp;)                = <span class="kw">delete</span>;</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>* <span class="va">name_</span>;</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>    };</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>    <span class="kw">class</span> Derived <span class="kw">final</span> : <span class="kw">public</span> Base {</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a>        Derived() <span class="kw">noexcept</span> : Base{<span class="st">&quot;Derived&quot;</span>} {}</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">char</span> <span class="at">const</span>* Name0() <span class="at">const</span> <span class="kw">noexcept</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">&quot;Derived&quot;</span>; }</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a>    };</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a>    TEST(ProgrammingConventionClassA, Slicing)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a>    {</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a>        <span class="kw">auto</span>  b     = Base{};</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a>        <span class="kw">auto</span>  d     = Derived{};</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a>        Base&amp; d_ref = d;</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a>        <span class="co">// 以下はBase、Derivedの単純なテスト</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;Base&quot;</span>, b.Name0());</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;Base&quot;</span>, b.Name1());</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;Derived&quot;</span>, d_ref.Name0());</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;Derived&quot;</span>, d_ref.Name1());</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true"></a>    <span class="pp">#if 0</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true"></a><span class="co">        // Base::operator=(Base const&amp; rhs)をdeleteしたためにこのような誤用はコンパイルエラーになる。</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true"></a><span class="co">        // 以下はbがスライスされたオブジェクトであることのテスト</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true"></a><span class="co">        // こういった誤用を防ぐためにBaseのコピーを禁止せよ。</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true"></a><span class="co">        b = d_ref;</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true"></a><span class="co">        ASSERT_STREQ(&quot;Base&quot;, b.Name0());     // vtblはBaseになるから</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true"></a><span class="co">        ASSERT_STREQ(&quot;Derived&quot;, b.Name1());  // name_はコピーされるから</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true"></a><span class="co">    </span><span class="pp">#else</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true"></a>        <span class="co">// 意図的に上記のようなことがしたい場合、下記のようにするべき。</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true"></a>        <span class="kw">auto</span> b_copy = Base{d_ref.Name0()};</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;Base&quot;</span>, b_copy.Name0());     <span class="co">// vtblはBaseになるから</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;Derived&quot;</span>, b_copy.Name1());  <span class="co">// name_はコピーされるから</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true"></a>    <span class="pp">#endif</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_2_6">演習-スライシング</a>へ戻る。</li>
</ul>
<h3 id="解答例-オブジェクトの所有権">解答例-オブジェクトの所有権 <a id="SS_20_2_7"></a></h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/class.cpp 146</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>    <span class="kw">class</span> A {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>        <span class="kw">explicit</span> A(<span class="dt">int32_t</span> n) <span class="kw">noexcept</span> : <span class="va">num_</span>{n} { <span class="va">last_constructed_num_</span> = <span class="va">num_</span>; }</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>        ~A() { <span class="va">last_destructed_num_</span> = <span class="va">num_</span>; }</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>        <span class="dt">int32_t</span> GetNum() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">num_</span>; }</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>        <span class="at">static</span> <span class="dt">int32_t</span> LastConstructedNum() <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">last_constructed_num_</span>; }</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>        <span class="at">static</span> <span class="dt">int32_t</span> LastDestructedNum() <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">last_destructed_num_</span>; }</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>        <span class="dt">int32_t</span>        <span class="va">num_</span>;</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>        <span class="at">static</span> <span class="dt">int32_t</span> <span class="va">last_constructed_num_</span>;</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a>        <span class="at">static</span> <span class="dt">int32_t</span> <span class="va">last_destructed_num_</span>;</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a>    };</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>    <span class="dt">int32_t</span> A::<span class="va">last_constructed_num_</span> = -<span class="dv">1</span>;</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a>    <span class="dt">int32_t</span> A::<span class="va">last_destructed_num_</span>  = -<span class="dv">1</span>;</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true"></a>    <span class="kw">class</span> X <span class="kw">final</span> {</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true"></a>        <span class="dt">void</span> Move(<span class="bu">std::</span>unique_ptr&lt;A&gt;&amp;&amp; ptr) <span class="kw">noexcept</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true"></a>        {</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true"></a>            <span class="va">ptr_</span> = <span class="bu">std::</span>move(ptr);  <span class="co">// ptr-&gt;ptr_へ所有権の移動</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true"></a>        }</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;A&gt; Release() <span class="kw">noexcept</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true"></a>        {</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>move(<span class="va">ptr_</span>);  <span class="co">// ptr_から外部への所有権の移動</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true"></a>        }</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true"></a>        A <span class="at">const</span>* GetA() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">ptr_</span>.get(); }</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true"></a>        X()  = <span class="cf">default</span>;</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true"></a>        ~X() = <span class="cf">default</span>;</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;A&gt; <span class="va">ptr_</span>{};</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true"></a>    };</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true"></a>    TEST(ProgrammingConventionClassA, Ownership)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true"></a>    {</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true"></a>        <span class="co">// 以下の単体テストを完成させよ。</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true"></a>        ASSERT_EQ(-<span class="dv">1</span>, A::LastConstructedNum());     <span class="co">// まだ、A::A()は呼ばれてない</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true"></a>        ASSERT_EQ(-<span class="dv">1</span>, A::LastDestructedNum());      <span class="co">// まだ、A::~A()は呼ばれてない</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true"></a>        <span class="kw">auto</span> a0 = <span class="bu">std::</span>make_unique&lt;A&gt;(<span class="dv">0</span>);           <span class="co">// a0はA(0)を所有</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true"></a>        <span class="kw">auto</span> a1 = <span class="bu">std::</span>make_unique&lt;A&gt;(<span class="dv">1</span>);           <span class="co">// a1はA(1)を所有</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true"></a>        <span class="kw">auto</span> x = X {};</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>,  A::LastConstructedNum());     <span class="co">// A(1)は生成された</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true"></a>        ASSERT_EQ(-<span class="dv">1</span>, A::LastDestructedNum());      <span class="co">// まだ、A::~A()は呼ばれてない</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, a0-&gt;GetNum());                 <span class="co">// a0はA(0)を所有</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true"></a>        x.Move(<span class="bu">std::</span>move(a0));                      <span class="co">// a0からxへA(0)の所有権の移動</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true"></a>        ASSERT_FALSE(a0);                           <span class="co">// a0は何も所有していない</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true"></a></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, a1-&gt;GetNum());                 <span class="co">// a1はA(1)を所有</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true"></a>        x.Move(<span class="bu">std::</span>move(a1));                      <span class="co">// xによるA(0)の解放</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true"></a>                                                    <span class="co">// a1からxへA(1)の所有権の移動</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, A::LastDestructedNum());       <span class="co">// A(0)は解放された</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true"></a>        ASSERT_FALSE(a1);                           <span class="co">// a1は何も所有していない</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, x.GetA()-&gt;GetNum());           <span class="co">// xはA(1)を所有</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;A&gt; a2{x.Release()};         <span class="co">// xからa2へA(1)の所有権の移動</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true"></a>        ASSERT_EQ(<span class="kw">nullptr</span>, x.GetA());               <span class="co">// xは何も所有していない</span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, a2-&gt;GetNum());                 <span class="co">// a2はA(1)を所有</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true"></a>        {</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true"></a>            <span class="bu">std::</span>unique_ptr&lt;A&gt; a3{<span class="bu">std::</span>move(a2)};</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true"></a>            ASSERT_FALSE(a2);                       <span class="co">// a2は何も所有していない</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">1</span>, a3-&gt;GetNum());             <span class="co">// a3はA(1)を所有</span></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true"></a>        }                                           <span class="co">// a3によるA(1)の解放</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, A::LastDestructedNum());</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_2_7">演習-オブジェクトの所有権</a>へ戻る。</li>
</ul>
<h2 id="プログラミング規約関数">プログラミング規約(関数) <a id="SS_20_3"></a></h2>
<h3 id="解答例-非メンバ関数の宣言">解答例-非メンバ関数の宣言 <a id="SS_20_3_1"></a></h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 11</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, NonMemberFunc)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>    {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>        <span class="co">// 適切な#includeを追加し、上記のextern宣言がなくとも下記がコンパイルできるようにせよ。</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>        <span class="co">// このファイルの先頭付近に</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>        <span class="co">// #include &lt;cmath&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>        <span class="co">// を追加した。</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, cos(<span class="dv">0</span>));</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_1">演習-非メンバ関数の宣言</a>へ戻る。</li>
</ul>
<h3 id="解答例-メンバ関数の修飾">解答例-メンバ関数の修飾 <a id="SS_20_3_2"></a></h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 25</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>    <span class="co">// 下記のクラスAのメンバ関数の不正確な記述を修正せよ。</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>    <span class="co">// また、単体テストを同様に修正せよ。</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>    <span class="kw">class</span> A {</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a>        A() : <span class="va">strings_</span>{GetStringsDefault()} {}</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a>        <span class="dt">void</span> SetStrings(<span class="dt">size_t</span> index, <span class="bu">std::</span>string str)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a>        {</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a>            <span class="cf">if</span> (index &lt; max_len) {</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a>                <span class="va">strings_</span>[index] = str;</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a>            }</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a>        }</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;&amp;       GetStrings() <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">strings_</span>; }</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; GetStrings() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">strings_</span>; }</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true"></a>        <span class="kw">constexpr</span> <span class="dt">size_t</span>                MaxLen() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> max_len; }</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; GetStringsDefault()</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true"></a>        {</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true"></a>            <span class="at">static</span> <span class="at">const</span> <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; strings_default{max_len, <span class="st">&quot;&quot;</span>};</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true"></a>            <span class="cf">return</span> strings_default;</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true"></a>        }</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="va">strings_</span>;</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">size_t</span>  max_len{<span class="dv">3</span>};</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true"></a>    };</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, MemberFunc)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true"></a>    {</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true"></a>        <span class="kw">auto</span> a = A{};</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; strings_default = a.GetStringsDefault();</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{a.MaxLen(), <span class="st">&quot;&quot;</span>}), strings_default);</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; strings = a.GetStrings();</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{a.MaxLen(), <span class="st">&quot;&quot;</span>}), strings);</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true"></a>        a.SetStrings(<span class="dv">1</span>, <span class="st">&quot;TEST&quot;</span>);</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;&quot;</span>, strings[<span class="dv">0</span>]);</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true"></a>        <span class="co">// [A]</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true"></a>        <span class="co">// このテストをASSERT_EQでパスできるようにせよ</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;TEST&quot;</span>, strings[<span class="dv">1</span>]);</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;&quot;</span>, strings[<span class="dv">2</span>]);</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true"></a></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true"></a>        <span class="co">// 上記は下記のように書くべき</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;&quot;</span>, <span class="st">&quot;TEST&quot;</span>, <span class="st">&quot;&quot;</span>}), strings);</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_2">演習-メンバ関数の修飾</a>へ戻る。</li>
</ul>
<h3 id="解答例-特殊メンバ関数の削除">解答例-特殊メンバ関数の削除 <a id="SS_20_3_3"></a></h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 81</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>    <span class="co">// 下記クラスAutoGenのコンパイラが自動生成するメンバ関数を生成しないようにせよ。</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>    <span class="kw">class</span> AutoGen {</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>        AutoGen()  = <span class="kw">delete</span>;</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>        ~AutoGen() = <span class="kw">delete</span>;</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>        AutoGen(AutoGen <span class="at">const</span>&amp;)                = <span class="kw">delete</span>;</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>        AutoGen&amp; <span class="kw">operator</span>=(AutoGen <span class="at">const</span>&amp;)     = <span class="kw">delete</span>;</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>        AutoGen(AutoGen&amp;&amp;) <span class="kw">noexcept</span>            = <span class="kw">delete</span>;</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>        AutoGen&amp; <span class="kw">operator</span>=(AutoGen&amp;&amp;) <span class="kw">noexcept</span> = <span class="kw">delete</span>;</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>    };</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_3">演習-特殊メンバ関数の削除</a>へ戻る。</li>
</ul>
<h3 id="解答例-委譲コンストラクタ">解答例-委譲コンストラクタ <a id="SS_20_3_4"></a></h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 97</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>    <span class="co">// 下記クラスDelConstructorの2つのコンストラクタのコードクローンをできるだけ排除せよ。</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>    <span class="kw">class</span> DelConstructor {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a>        <span class="kw">explicit</span> DelConstructor(<span class="bu">std::</span>string <span class="at">const</span>&amp; str)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a>            : <span class="va">str0_</span>{str + <span class="st">&quot;0&quot;</span>}, <span class="va">str1_</span>{str + <span class="st">&quot;1&quot;</span>}, <span class="va">str2_</span>{str + <span class="st">&quot;2&quot;</span>}</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>        {</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a>        }</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a>        <span class="kw">explicit</span> DelConstructor(<span class="dt">int32_t</span> num) : DelConstructor{<span class="bu">std::</span>to_string(num) + <span class="st">&quot;_&quot;</span>} {}</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetString0() <span class="at">const</span> { <span class="cf">return</span> <span class="va">str0_</span>; }</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetString1() <span class="at">const</span> { <span class="cf">return</span> <span class="va">str1_</span>; }</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetString2() <span class="at">const</span> { <span class="cf">return</span> <span class="va">str2_</span>; }</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span> <span class="va">str0_</span>;</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span> <span class="va">str1_</span>;</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span> <span class="va">str2_</span>;</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true"></a>    };</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, Constructor)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true"></a>    {</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true"></a>        {</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> dc = DelConstructor{<span class="st">&quot;hehe&quot;</span>};</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;hehe0&quot;</span>, dc.GetString0());</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;hehe1&quot;</span>, dc.GetString1());</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;hehe2&quot;</span>, dc.GetString2());</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true"></a>        }</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true"></a>        {</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> dc = DelConstructor{<span class="dv">123</span>};</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;123_0&quot;</span>, dc.GetString0());</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;123_1&quot;</span>, dc.GetString1());</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;123_2&quot;</span>, dc.GetString2());</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true"></a>        }</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_4">演習-委譲コンストラクタ</a>へ戻る。</li>
</ul>
<h3 id="解答例-copyコンストラクタ">解答例-copyコンストラクタ <a id="SS_20_3_5"></a></h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 139</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>    <span class="co">// 下記クラスIngeter、IntegerHolderに適切にcopyコンストラクタ、copy代入演算子を追加して、</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>    <span class="co">// 単体テストを行え。</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a>    <span class="kw">class</span> Integer {</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a>        <span class="kw">explicit</span> Integer(<span class="dt">int32_t</span> i) <span class="kw">noexcept</span> : <span class="va">i_</span>{i} {}</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a>        Integer(Integer <span class="at">const</span>&amp; rhs) <span class="kw">noexcept</span> = <span class="cf">default</span>;</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a>        Integer&amp; <span class="kw">operator</span>=(Integer <span class="at">const</span>&amp; rhs) <span class="kw">noexcept</span> = <span class="cf">default</span>;</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true"></a>        <span class="dt">int32_t</span> GetValue() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">i_</span>; }</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true"></a>        <span class="dt">int32_t</span> <span class="va">i_</span>;</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true"></a>    };</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true"></a>    <span class="kw">class</span> IntegerHolder {</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true"></a>        <span class="kw">explicit</span> IntegerHolder(<span class="dt">int32_t</span> i) : <span class="va">integer_</span>{<span class="bu">std::</span>make_unique&lt;Integer&gt;(i)} {}</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true"></a>        IntegerHolder(IntegerHolder <span class="at">const</span>&amp; rhs) : <span class="va">integer_</span>{<span class="bu">std::</span>make_unique&lt;Integer&gt;(*rhs.<span class="va">integer_</span>)} {}</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true"></a>        IntegerHolder&amp; <span class="kw">operator</span>=(IntegerHolder <span class="at">const</span>&amp; rhs)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true"></a>        {</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true"></a>            *<span class="va">integer_</span> = *(rhs.<span class="va">integer_</span>);</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true"></a>            <span class="cf">return</span> *<span class="kw">this</span>;</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true"></a>        }</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true"></a>        <span class="dt">int32_t</span> GetValue() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">integer_</span>-&gt;GetValue(); }</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Integer&gt; <span class="va">integer_</span>;</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true"></a>    };</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, Constructor2)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true"></a>    {</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true"></a>        {</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true"></a>            <span class="kw">auto</span> i = Integer{<span class="dv">3</span>};</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">3</span>, i.GetValue());</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true"></a>            <span class="kw">auto</span> j = Integer{i};</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">3</span>, j.GetValue());</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true"></a>            <span class="kw">auto</span> k = Integer{<span class="dv">0</span>};</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">0</span>, k.GetValue());</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true"></a></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true"></a>            k = i;</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">3</span>, k.GetValue());</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true"></a>        }</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true"></a>        {</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true"></a>            <span class="kw">auto</span> i = IntegerHolder{<span class="dv">3</span>};</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">3</span>, i.GetValue());</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true"></a>            <span class="kw">auto</span> j = IntegerHolder{i};</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">3</span>, j.GetValue());</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true"></a></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true"></a>            <span class="kw">auto</span> k = IntegerHolder{<span class="dv">0</span>};</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">0</span>, k.GetValue());</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true"></a></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true"></a>            k = i;</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">3</span>, k.GetValue());</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true"></a>        }</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_5">演習-copyコンストラクタ</a>へ戻る。</li>
</ul>
<h3 id="解答例-moveコンストラクタ">解答例-moveコンストラクタ <a id="SS_20_3_6"></a></h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 206</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>    <span class="co">// 上記問題を解決したIntegerHolderにmoveコンストラクタ、move演算子を追加した</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>    <span class="co">// クラスIntegerHolder2を作成し、単体テストを行え。</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>    <span class="kw">class</span> IntegerHolder2 {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>        <span class="kw">explicit</span> IntegerHolder2(<span class="dt">int32_t</span> i) : <span class="va">integer_</span>{<span class="bu">std::</span>make_unique&lt;Integer&gt;(i)} {}</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a>        IntegerHolder2(IntegerHolder2 <span class="at">const</span>&amp; rhs) : <span class="va">integer_</span>{<span class="bu">std::</span>make_unique&lt;Integer&gt;(*rhs.<span class="va">integer_</span>)}</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a>        {</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true"></a>        }</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true"></a>        IntegerHolder2(IntegerHolder2&amp;&amp; rhs) <span class="kw">noexcept</span> : <span class="va">integer_</span>{<span class="bu">std::</span>move(rhs.<span class="va">integer_</span>)} {}</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true"></a>        IntegerHolder2&amp; <span class="kw">operator</span>=(IntegerHolder2 <span class="at">const</span>&amp; rhs) <span class="kw">noexcept</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true"></a>        {</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true"></a>            *<span class="va">integer_</span> = *(rhs.<span class="va">integer_</span>);</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true"></a>            <span class="cf">return</span> *<span class="kw">this</span>;</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true"></a>        }</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true"></a>        IntegerHolder2&amp; <span class="kw">operator</span>=(IntegerHolder2&amp;&amp; rhs) <span class="kw">noexcept</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true"></a>        {</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true"></a>            <span class="va">integer_</span> = <span class="bu">std::</span>move(rhs.<span class="va">integer_</span>);</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true"></a>            <span class="cf">return</span> *<span class="kw">this</span>;</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true"></a>        }</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true"></a>        <span class="dt">int32_t</span> GetValue() <span class="at">const</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true"></a>        {</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true"></a>            <span class="cf">if</span> (!<span class="va">integer_</span>) {</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true"></a>                <span class="cf">throw</span> <span class="bu">std::</span>bad_exception{};</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true"></a>            }</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">integer_</span>-&gt;GetValue();</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true"></a>        }</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Integer&gt; <span class="va">integer_</span>;</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true"></a>    };</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true"></a>    <span class="pp">#ifndef __clang_analyzer__</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, Move)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true"></a>    {</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true"></a>        {</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true"></a>            <span class="kw">auto</span> i = IntegerHolder2{<span class="dv">3</span>};</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true"></a>            <span class="kw">auto</span> j = IntegerHolder2{<span class="bu">std::</span>move(i)};</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">3</span>, j.GetValue());</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true"></a>            ASSERT_THROW(i.GetValue(), <span class="bu">std::</span>bad_exception);</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true"></a>        }</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true"></a>        {</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true"></a>            <span class="kw">auto</span> i = IntegerHolder2{<span class="dv">30</span>};</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true"></a>            <span class="kw">auto</span> j = IntegerHolder2{<span class="dv">0</span>};</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">0</span>, j.GetValue());</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true"></a></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true"></a>            j = <span class="bu">std::</span>move(i);</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true"></a></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">30</span>, j.GetValue());</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true"></a>            ASSERT_THROW(i.GetValue(), <span class="bu">std::</span>bad_exception);</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true"></a>        }</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true"></a>    }</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true"></a>    <span class="pp">#endif</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_6">演習-moveコンストラクタ</a>へ戻る。</li>
</ul>
<h3 id="解答例-関数分割">解答例-関数分割 <a id="SS_20_3_7"></a></h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 272</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>    <span class="co">// 下記PrimeNumbersは引数で与えられた整数以下の素数を返す関数である。</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>    <span class="co">// PrimeNumbersの単体テストを作成し、その後、行数を短くする等のリファクタリングを行え。</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>    <span class="dt">uint32_t</span> next_prime_num(<span class="dt">uint32_t</span> curr_prime_num, <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;&amp; is_num_prime) <span class="kw">noexcept</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>    {</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i = <span class="dv">2</span> * curr_prime_num; i &lt; is_num_prime.size(); i += curr_prime_num) {</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>            is_num_prime[i] = <span class="kw">false</span>;  <span class="co">// 次の倍数は素数ではない</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>        }</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num = curr_prime_num;</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>        <span class="cf">do</span> {  <span class="co">// 次の素数の探索</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a>            ++prime_num;</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a>        } <span class="cf">while</span> (!is_num_prime[prime_num] &amp;&amp; (prime_num &lt; is_num_prime.size()));</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a>        <span class="cf">return</span> prime_num;</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true"></a>    }</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true"></a>    <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; PrimeNumbers(<span class="dt">uint32_t</span> max_number)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true"></a>    {</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true"></a>        <span class="kw">auto</span> result = <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{};</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true"></a>        <span class="cf">if</span> (max_number &lt; <span class="dv">2</span>) {  <span class="co">// ガード節。2未満の素数はない。</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true"></a>            <span class="cf">return</span> result;</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true"></a>        }</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num    = <span class="dv">2</span><span class="bu">U</span>;                                       <span class="co">// 最初の素数</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true"></a>        <span class="kw">auto</span> is_num_prime = <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;(max_number + <span class="dv">1</span>, <span class="kw">true</span>);  <span class="co">// falseなら素数でない。</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true"></a>        is_num_prime[<span class="dv">0</span>] = is_num_prime[<span class="dv">1</span>] = <span class="kw">false</span>;</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true"></a>        <span class="cf">do</span> {</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true"></a>            result.emplace_back(prime_num);</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true"></a>            prime_num = next_prime_num(prime_num, is_num_prime);</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true"></a>        } <span class="cf">while</span> (prime_num &lt; is_num_prime.size());</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true"></a>        <span class="cf">return</span> result;</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true"></a>    }</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, Lines)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true"></a>    {</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{}), PrimeNumbers(<span class="dv">0</span>));</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{}), PrimeNumbers(<span class="dv">1</span>));</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>}), PrimeNumbers(<span class="dv">2</span>));</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>}), PrimeNumbers(<span class="dv">3</span>));</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>}), PrimeNumbers(<span class="dv">8</span>));</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">29</span>}), PrimeNumbers(<span class="dv">30</span>));</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_7">演習-関数分割</a>へ戻る。</li>
</ul>
<h3 id="解答-オーバーライド関数の修飾">解答-オーバーライド関数の修飾 <a id="SS_20_3_8"></a></h3>
<ul>
<li>選択肢2</li>
<li>参照 <a href="programming_convention.html#SS_3_3_2_7">オーバーライド</a></li>
<li><a href="exercise_q.html#SS_19_3_8">演習-オーバーライド関数の修飾</a>へ戻る。</li>
</ul>
<h3 id="解答例-オーバーライドオーバーロード">解答例-オーバーライド/オーバーロード <a id="SS_20_3_9"></a></h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 325</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>    <span class="co">// 下記クラスBase、Derivedの単体テストを完成せよ。</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>    <span class="kw">class</span> Base {</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Base() = <span class="cf">default</span>;</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a>        <span class="dt">int32_t</span> f() <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">0</span>; }</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">int32_t</span> g() <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">0</span>; }</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a>    };</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true"></a>    <span class="kw">class</span> Derived : <span class="kw">public</span> Base {</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true"></a>        <span class="dt">int32_t</span> f() <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">1</span>; }</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">int32_t</span> g() <span class="kw">noexcept</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="dv">1</span>; }</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true"></a>    };</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, Overload)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true"></a>    {</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true"></a>        <span class="kw">auto</span>  b     = Base{};</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true"></a>        <span class="kw">auto</span>  d     = Derived{};</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true"></a>        Base&amp; d_ref = d;</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, b.f());</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, b.g());</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, d.f());</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, d.g());</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, d_ref.f());</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, d_ref.g());</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_9">演習-オーバーライド/オーバーロード</a>へ戻る。</li>
</ul>
<h3 id="解答例-オーバーロードによる誤用防止">解答例-オーバーロードによる誤用防止 <a id="SS_20_3_10"></a></h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 361</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>    <span class="co">// 下記関数Squareは、引数が浮動小数点となることを想定していない。</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a>    <span class="co">// 誤用を防ぐために、引数に浮動小数点を指定された場合、コンパイルできないようにせよ。</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>    <span class="dt">int32_t</span> Square(<span class="dt">int32_t</span> a) <span class="kw">noexcept</span> { <span class="cf">return</span> a * a; }</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a>    <span class="dt">int32_t</span> Square(<span class="dt">double</span> a) <span class="kw">noexcept</span> = <span class="kw">delete</span>;</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, Overload2)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a>    {</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">9</span>, Square(<span class="dv">3</span>));</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true"></a>    <span class="pp">#if 0  </span><span class="co">// int32_t Square(double a) = delete;により下記はコンパイルできない。</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true"></a><span class="co">        ASSERT_EQ(4, Square(2.5));</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true"></a><span class="co">    </span><span class="pp">#endif</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_10">演習-オーバーロードによる誤用防止</a>へ戻る。</li>
</ul>
<h3 id="解答例-仮引数の修飾">解答例-仮引数の修飾 <a id="SS_20_3_11"></a></h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 377</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a>    <span class="co">// 下記AddStringsの仮引数等を適切に修正せよ。</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a>    <span class="kw">using</span> Strings = <span class="bu">std::</span>list&lt;<span class="bu">std::</span>string&gt;;</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a>    Strings AddStrings(Strings <span class="at">const</span>&amp; a, Strings <span class="at">const</span>* b)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>    {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a>        <span class="kw">auto</span> ret = a;</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true"></a>        <span class="cf">if</span> (b == <span class="kw">nullptr</span>) {</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true"></a>            <span class="cf">return</span> ret;</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true"></a>        }</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true"></a>        ret.insert(ret.end(), b-&gt;begin(), b-&gt;end());</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true"></a>    }</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, Parameter)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true"></a>    {</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true"></a>        <span class="kw">auto</span> a = Strings{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;d&quot;</span>};</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true"></a>        <span class="kw">auto</span> b = Strings{<span class="st">&quot;e&quot;</span>, <span class="st">&quot;fgh&quot;</span>, <span class="st">&quot;i&quot;</span>};</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true"></a>        <span class="kw">auto</span> ret = AddStrings(a, <span class="kw">nullptr</span>);</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true"></a>        ASSERT_EQ(ret, (Strings{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;d&quot;</span>}));</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true"></a>        ret = AddStrings(a, &amp;b);</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true"></a>        ASSERT_EQ(ret, (Strings{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;e&quot;</span>, <span class="st">&quot;fgh&quot;</span>, <span class="st">&quot;i&quot;</span>}));</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true"></a>        ASSERT_EQ(AddStrings(a, <span class="kw">nullptr</span>), (Strings{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;d&quot;</span>}));</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true"></a>        ASSERT_EQ(AddStrings(a, &amp;b), (Strings{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;e&quot;</span>, <span class="st">&quot;fgh&quot;</span>, <span class="st">&quot;i&quot;</span>}));</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_11">演習-仮引数の修飾</a>へ戻る。</li>
</ul>
<h3 id="解答例-constexpr関数">解答例-constexpr関数 <a id="SS_20_3_12"></a></h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/func.cpp 411</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>    <span class="co">// 下記Factorialをconstexpr関数にせよ。</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">uint32_t</span> Factorial(<span class="dt">uint32_t</span> a) <span class="kw">noexcept</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>    {</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>        <span class="cf">if</span> (a == <span class="dv">0</span> || a == <span class="dv">1</span>) {</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>            <span class="cf">return</span> <span class="dv">1</span>;</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>        }</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>        <span class="cf">return</span> Factorial(a - <span class="dv">1</span>) * a;</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a>    }</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA, ConstexprFunc)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a>    {</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a>        <span class="kw">static_assert</span>(<span class="dv">1</span> == Factorial(<span class="dv">0</span>), <span class="st">&quot;Factorial fail&quot;</span>);</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, Factorial(<span class="dv">0</span>));</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">6</span>, Factorial(<span class="dv">3</span>));</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">120</span>, Factorial(<span class="dv">5</span>));</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3628800</span>, Factorial(<span class="dv">10</span>));</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_3_12">演習-constexpr関数</a>へ戻る。</li>
</ul>
<h3 id="解答-エクセプションの型">解答-エクセプションの型 <a id="SS_20_3_13"></a></h3>
<ul>
<li>選択肢2</li>
<li>参照 <a href="programming_convention.html#SS_3_3_3_10">エクセプション処理</a></li>
<li>解説<br />
下記3つを統合して考えれば、必然的に「選択肢2」であることがわかる。
<ul>
<li>エクセプションでthrowされるオブジェクトのポインタがnullptrになることはない。</li>
<li>throwされたオブジェクトのスライスは当然避けるべきである。</li>
<li>throwされたオブジェクトを直接修正すべきでない。</li>
</ul></li>
<li><a href="exercise_q.html#SS_19_3_13">演習-エクセプションの型</a>へ戻る。</li>
</ul>
<h2 id="プログラミング規約構文">プログラミング規約(構文) <a id="SS_20_4"></a></h2>
<h3 id="解答例-コンテナの範囲for文">解答例-コンテナの範囲for文 <a id="SS_20_4_1"></a></h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/syntax.cpp 8</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a>    <span class="co">// 下記Accumlateのfor文を</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>    <span class="co">//  * イテレータを使ったfor文を使用したAccumlate2</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>    <span class="co">//  * 範囲for文を使用したAccumlate3</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>    <span class="co">// を作り、それらの単体テストを行え。また、その時にその他の不具合があれば合わせて修正せよ。</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>    <span class="bu">std::</span>string Accumlate(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; strings) <span class="kw">noexcept</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>    {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a>        <span class="kw">auto</span> ret = <span class="bu">std::</span>string{};</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i = <span class="dv">0</span><span class="bu">U</span>; i &lt; strings.size(); ++i) {</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true"></a>            ret += strings[i];</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true"></a>        }</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true"></a>    }</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true"></a>    <span class="bu">std::</span>string Accumlate2(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; strings) <span class="kw">noexcept</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true"></a>    {</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true"></a>        <span class="kw">auto</span> ret = <span class="bu">std::</span>string{};</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true"></a>    <span class="pp">#if 0  </span><span class="co">// old style</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true"></a><span class="co">        for (std::vector&lt;std::string&gt;::const_iterator it = strings.cbegin(); it != strings.cend(); ++it) {</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true"></a><span class="co">            ret += *it;</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true"></a><span class="co">        }</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true"></a><span class="co">    </span><span class="pp">#else</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> it = strings.cbegin(); it != strings.cend(); ++it) {</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true"></a>            ret += *it;</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true"></a>        }</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true"></a>    <span class="pp">#endif</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true"></a>    }</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true"></a>    <span class="bu">std::</span>string Accumlate3(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; strings) <span class="kw">noexcept</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true"></a>    {</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true"></a>        <span class="kw">auto</span> ret = <span class="bu">std::</span>string{};</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; s : strings) {</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true"></a>            ret += s;</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true"></a>        }</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true"></a></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true"></a>    }</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true"></a>    TEST(ProgrammingConventionSyntaxA, RangeFor)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true"></a>    {</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;abcd&quot;</span>, Accumlate(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;cd&quot;</span>}));</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;ABCD&quot;</span>, Accumlate2(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;CD&quot;</span>}));</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;AbCd&quot;</span>, Accumlate3(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;A&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;Cd&quot;</span>}));</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_4_1">演習-コンテナの範囲for文</a>へ戻る。</li>
</ul>
<h3 id="解答例-ラムダ式">解答例-ラムダ式 <a id="SS_20_4_2"></a></h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/syntax.cpp 62</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>    <span class="co">// 下記のcopy_ifの第4引数をラムダ式を使って書き直せ。</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>    TEST(ProgrammingConventionSyntaxA, Lambda)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>    {</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>        <span class="kw">auto</span> data = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;&quot;</span>, <span class="st">&quot;abc&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;d&quot;</span>};</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a>        <span class="kw">auto</span> ret = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{};</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a>        <span class="bu">std::</span>copy_if(data.cbegin(), data.cend(), <span class="bu">std::</span>back_inserter(ret),</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a>                     [](<span class="kw">auto</span> <span class="at">const</span>&amp; s) <span class="kw">noexcept</span> { <span class="cf">return</span> s.size() != <span class="dv">0</span>; });</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;d&quot;</span>}), ret);</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_4_2">演習-ラムダ式</a>へ戻る。</li>
</ul>
<h3 id="解答例-ラムダ式のキャプチャ">解答例-ラムダ式のキャプチャ <a id="SS_20_4_3"></a></h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/syntax.cpp 78</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>    <span class="co">// 下記Lambda::GetNameLessThan()のラムダ式の問題点を修正し、単体テストを行え。</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>    <span class="kw">class</span> Lambda {</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a>        <span class="kw">explicit</span> Lambda(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;&amp;&amp; strs) : <span class="va">strs_</span>{<span class="bu">std::</span>move(strs)} {}</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; GetNameLessThan(<span class="dt">uint32_t</span> length) <span class="at">const</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a>        {</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a>            <span class="kw">auto</span> ret = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{};</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>            <span class="bu">std::</span>copy_if(<span class="va">strs_</span>.cbegin(), <span class="va">strs_</span>.cend(), <span class="bu">std::</span>back_inserter(ret),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>                         [length = length](<span class="kw">auto</span> <span class="at">const</span>&amp; str) <span class="kw">noexcept</span> { <span class="cf">return</span> (str.size() &lt; length); });</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>            <span class="cf">return</span> ret;</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true"></a>        }</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="va">strs_</span>;</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true"></a>    };</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true"></a>    TEST(ProgrammingConventionSyntaxA, Lambda2)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true"></a>    {</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true"></a>        <span class="kw">auto</span> lambda = Lambda{{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;abcdef&quot;</span>, <span class="st">&quot;a&quot;</span>}};</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true"></a>        ASSERT_EQ(lambda.GetNameLessThan(<span class="dv">4</span>), (<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;a&quot;</span>}));</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true"></a>        ASSERT_EQ(lambda.GetNameLessThan(<span class="dv">2</span>), (<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;a&quot;</span>}));</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true"></a>        ASSERT_EQ(lambda.GetNameLessThan(<span class="dv">1</span>), (<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{}));</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_4_3">演習-ラムダ式のキャプチャ</a>へ戻る。</li>
</ul>
<h2 id="プログラミング規約演算子">プログラミング規約(演算子) <a id="SS_20_5"></a></h2>
<h3 id="解答例-三項演算子">解答例-三項演算子 <a id="SS_20_5_1"></a></h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/operator.cpp 8</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a>    <span class="co">// 下記whichのif文を三項演算子を使用して書き直せ。</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a>    <span class="dt">int32_t</span> which(<span class="dt">bool</span> left, <span class="dt">int32_t</span> lhs, <span class="dt">int32_t</span> rhs) <span class="kw">noexcept</span> { <span class="cf">return</span> left ? lhs : rhs; }</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true"></a>    TEST(ProgrammingConventionOperatorA, OoOperator)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true"></a>    {</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, which(<span class="kw">true</span>, <span class="dv">3</span>, <span class="dv">4</span>));</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">4</span>, which(<span class="kw">false</span>, <span class="dv">3</span>, <span class="dv">4</span>));</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_5_1">演習-三項演算子</a>へ戻る。</li>
</ul>
<h3 id="解答例-delete">解答例-delete <a id="SS_20_5_2"></a></h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/operator.cpp 20</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a>    <span class="co">// 下記DeleteProblemのメモリ管理の問題を修正せよ。</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a>    <span class="co">// また、他の問題があれば、合わせて修正せよ。</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true"></a>    <span class="kw">class</span> DeleteProblem {</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true"></a>        DeleteProblem(<span class="dt">char</span> <span class="at">const</span>* str0 = <span class="kw">nullptr</span>, <span class="dt">char</span> <span class="at">const</span>* str1 = <span class="kw">nullptr</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true"></a>            : <span class="va">str0_</span>{(str0 == <span class="kw">nullptr</span>) ? <span class="bu">std::</span>unique_ptr&lt;<span class="bu">std::</span>string&gt;{}</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true"></a>                                      : <span class="bu">std::</span>make_unique&lt;<span class="bu">std::</span>string&gt;(str0)},</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true"></a>              <span class="va">str1_</span>{(str1 == <span class="kw">nullptr</span>) ? <span class="bu">std::</span>unique_ptr&lt;<span class="bu">std::</span>string&gt;{}</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true"></a>                                      : <span class="bu">std::</span>make_unique&lt;<span class="bu">std::</span>string&gt;(str1)}</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true"></a>        {</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true"></a>        }</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true"></a>        DeleteProblem(DeleteProblem <span class="at">const</span>&amp;)            = <span class="kw">delete</span>;</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true"></a>        DeleteProblem&amp; <span class="kw">operator</span>=(DeleteProblem <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>* GetStr0() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">str0_</span>.get(); }</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>* GetStr1() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">str1_</span>.get(); }</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;<span class="bu">std::</span>string&gt; <span class="va">str0_</span>;</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;<span class="bu">std::</span>string&gt; <span class="va">str1_</span>;</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true"></a>    };</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true"></a>    TEST(ProgrammingConventionOperatorA, Delete)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true"></a>    {</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true"></a>        {</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> dp = DeleteProblem{};</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true"></a>            ASSERT_EQ(<span class="kw">nullptr</span>, dp.GetStr0());</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true"></a>            ASSERT_EQ(<span class="kw">nullptr</span>, dp.GetStr1());</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true"></a>        }</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true"></a>        {</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> dp = DeleteProblem{<span class="st">&quot;abc&quot;</span>};</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;abc&quot;</span>, *dp.GetStr0());</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true"></a>            ASSERT_EQ(<span class="kw">nullptr</span>, dp.GetStr1());</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true"></a>        }</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true"></a>        {</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> dp = DeleteProblem{<span class="st">&quot;abc&quot;</span>, <span class="st">&quot;de&quot;</span>};</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true"></a></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;abc&quot;</span>, *dp.GetStr0());</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;de&quot;</span>, *dp.GetStr1());</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true"></a>        }</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_5_2">演習-delete</a>へ戻る。</li>
</ul>
<h3 id="解答例-sizeof">解答例-sizeof <a id="SS_20_5_3"></a></h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/operator.cpp 71</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>    <span class="co">// 下記Size1() - Size4()の単体テストを作れ。</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a>    <span class="dt">size_t</span> Size0(<span class="dt">int32_t</span> a) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="kw">sizeof</span>(a); }</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>    <span class="dt">size_t</span> Size1(<span class="dt">int32_t</span> a[<span class="dv">10</span>]) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="kw">sizeof</span>(a); }</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a>    <span class="dt">size_t</span> Size2(<span class="dt">int32_t</span> a[]) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="kw">sizeof</span>(a); }</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a>    <span class="dt">size_t</span> Size3(<span class="dt">int32_t</span>* a) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="kw">sizeof</span>(a); }</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true"></a>    <span class="dt">size_t</span> Size4(<span class="dt">int32_t</span> (&amp;a)[<span class="dv">10</span>]) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="kw">sizeof</span>(a); }</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true"></a>    TEST(ProgrammingConventionOperatorA, Sizeof)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true"></a>    {</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true"></a>        <span class="dt">int32_t</span> array[<span class="dv">10</span>]{};</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">4</span>, Size0(array[<span class="dv">0</span>]));</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true"></a>        ASSERT_EQ(<span class="kw">sizeof</span>(<span class="dt">void</span>*), Size1(array));</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true"></a>        ASSERT_EQ(<span class="kw">sizeof</span>(<span class="dt">void</span>*), Size2(array));</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true"></a>        ASSERT_EQ(<span class="kw">sizeof</span>(<span class="dt">void</span>*), Size3(array));</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true"></a>        ASSERT_EQ(<span class="kw">sizeof</span>(<span class="dt">int32_t</span>) * <span class="dv">10</span>, Size4(array));</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_5_3">演習-sizeof</a>へ戻る。</li>
</ul>
<h3 id="解答例-dynamic_castの削除">解答例-dynamic_castの削除 <a id="SS_20_5_4"></a></h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/operator.cpp 97</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true"></a>    <span class="co">// 下記クラスX、Y、ZとGetNameをdynamic_castを使わずに書き直せ。</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true"></a>    <span class="kw">class</span> X {</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string GetName() <span class="at">const</span> { <span class="cf">return</span> <span class="st">&quot;X&quot;</span>; }</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true"></a>        <span class="kw">virtual</span> ~X() = <span class="cf">default</span>;</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true"></a>    };</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true"></a>    <span class="kw">class</span> Y : <span class="kw">public</span> X {</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string GetName() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">&quot;Y&quot;</span>; }</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true"></a>    };</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true"></a>    <span class="kw">class</span> Z : <span class="kw">public</span> X {</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string GetName() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">&quot;Z&quot;</span>; }</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true"></a>    };</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true"></a>    <span class="bu">std::</span>string GetName(X <span class="at">const</span>&amp; x) { <span class="cf">return</span> x.GetName(); }</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true"></a>    TEST(ProgrammingConventionOperatorA, Cast)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true"></a>    {</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true"></a>        <span class="kw">auto</span> x = X{};</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true"></a>        <span class="kw">auto</span> y = Y{};</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true"></a>        <span class="kw">auto</span> z = Z{};</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;X&quot;</span>, GetName(x));</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;Y&quot;</span>, GetName(y));</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;Z&quot;</span>, GetName(z));</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_5_4">演習-dynamic_castの削除</a>へ戻る。</li>
</ul>
<h3 id="解答-キャスト">解答-キャスト <a id="SS_20_5_5"></a></h3>
<ul>
<li>選択肢3<br />
</li>
<li>参照 <a href="programming_convention.html#SS_3_5_10">キャスト、暗黙の型変換</a></li>
<li>解説<br />
reinterpret_castも避けるべきであるが、組み込みソフト等でのハードウエアアドレスの記述等には、 使わざるを得ない。</li>
<li><a href="exercise_q.html#SS_19_5_5">演習-キャスト</a>へ戻る。</li>
</ul>
<h2 id="プログラミング規約スコープ">プログラミング規約(スコープ) <a id="SS_20_6"></a></h2>
<h3 id="解答-usingディレクティブ">解答-usingディレクティブ <a id="SS_20_6_1"></a></h3>
<ul>
<li>選択肢1</li>
<li>参照 <a href="programming_convention.html#SS_3_8_3">using宣言/usingディレクティブ</a></li>
<li><a href="exercise_q.html#SS_19_6_1">演習-usingディレクティブ</a>へ戻る。</li>
</ul>
<h2 id="プログラミング規約その他">プログラミング規約(その他) <a id="SS_20_7"></a></h2>
<h3 id="解答-アサーションの選択">解答-アサーションの選択 <a id="SS_20_7_1"></a></h3>
<ul>
<li>選択肢1</li>
<li>参照 <a href="programming_convention.html#SS_3_11_1">assertion</a></li>
<li><a href="exercise_q.html#SS_19_7_1">演習-アサーションの選択</a>へ戻る。</li>
</ul>
<h3 id="解答例-assertstatic_assert">解答例-assert/static_assert <a id="SS_20_7_2"></a></h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/programming_convention_a/etc.cpp 10</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a>    <span class="co">// 下記FloatingPointは、Tが浮動小数点型、Tのインスタンスは非０であることを前提としている。</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true"></a>    <span class="co">// 適切にアサーションを挿入して誤用を防げ。</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true"></a>    <span class="kw">class</span> FloatingPoint {</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true"></a>        <span class="kw">static_assert</span>(<span class="bu">std::</span>is_floating_point_v&lt;T&gt;, <span class="st">&quot;T must be floating point type&quot;</span>);</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true"></a>        FloatingPoint(T num) <span class="kw">noexcept</span> : <span class="va">num_</span>{num} { <span class="ot">assert</span>(num != <span class="dv">0</span>); }</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true"></a>        T Get() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">num_</span>; }</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true"></a>        T Reciprocal() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">1</span> / <span class="va">num_</span>; }</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true"></a>        T <span class="at">const</span> <span class="va">num_</span>;</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true"></a>    };</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true"></a>    TEST(ProgrammingConventionFuncA_Opt, Assertion)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true"></a>    {</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true"></a>        <span class="kw">auto</span> f1 = FloatingPoint&lt;<span class="dt">float</span>&gt;{<span class="fl">1.0</span><span class="bu">F</span>};</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true"></a>        <span class="kw">auto</span> d1 = FloatingPoint&lt;<span class="dt">double</span>&gt;{<span class="fl">1.0</span>};</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true"></a>        ASSERT_EQ(f1.Get(), <span class="fl">1.0</span><span class="bu">F</span>);</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true"></a>        ASSERT_EQ(d1.Get(), <span class="fl">1.0</span>);</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true"></a>        ASSERT_DEATH(FloatingPoint&lt;<span class="dt">float</span>&gt;{<span class="dv">0</span>}, <span class="st">&quot;num != 0&quot;</span>);</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true"></a>        ASSERT_DEATH(FloatingPoint&lt;<span class="dt">double</span>&gt;{<span class="dv">0</span>}, <span class="st">&quot;num != 0&quot;</span>);</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true"></a>    <span class="pp">#if 0  </span><span class="co">// コンパイルできない。</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true"></a><span class="co">        auto i = FloatingPoint&lt;int32_t&gt;{1};</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true"></a><span class="co">    </span><span class="pp">#endif</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_7_2">演習-assert/static_assert</a>へ戻る。</li>
</ul>
<h2 id="solid">SOLID <a id="SS_20_8"></a></h2>
<h3 id="解答例-srp">解答例-SRP <a id="SS_20_8_1"></a></h3>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/srp_test_score.h 8</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a>    <span class="co">// 下記クラスTestScoreはメンバにする必要のない関数までメンバにしてるため、</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true"></a>    <span class="co">// インターフェースが肥大化してしまい、少なくともSRPに反している。</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true"></a>    <span class="co">// メンバにする必要のないStoreCSVを外部関数にせよ。</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true"></a>    <span class="co">// また、受験者の平均点を求める</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true"></a>    <span class="co">//      TestScore::ScoreOne_t Average(TestScore const&amp; test_score);</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true"></a>    <span class="co">// を同様の方法で作り、単体テストを行え。</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true"></a>    <span class="kw">class</span> TestScore {</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true"></a>        ...</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true"></a>        <span class="co">// void StoreCSV(std::string const&amp; filename) const;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true"></a>        <span class="co">// は外部関数にした。</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true"></a>        <span class="dt">void</span> LoadCSV(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename);</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true"></a>        ...</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true"></a>    };</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true"></a>    <span class="bu">std::</span>string           ToString(TestScore <span class="at">const</span>&amp; ts);</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true"></a>    <span class="dt">void</span>                  StoreCSV(TestScore <span class="at">const</span>&amp; test_score, <span class="bu">std::</span>string <span class="at">const</span>&amp; filename);</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true"></a>    TestScore::<span class="dt">ScoreOne_t</span> Average(TestScore <span class="at">const</span>&amp; test_score);</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/srp_test_score.cpp 10</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a>    ...</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true"></a>    <span class="dt">bool</span> is_valid_score(<span class="dt">int32_t</span> score) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">0</span> &lt;= score &amp;&amp; score &lt;= <span class="dv">100</span>; }</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true"></a>    <span class="dt">bool</span> not_score(<span class="dt">int32_t</span> score) <span class="kw">noexcept</span> { <span class="cf">return</span> score == -<span class="dv">1</span>; }</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true"></a>    <span class="dt">void</span> TestScore::validate_score(<span class="dt">int32_t</span> score) <span class="at">const</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true"></a>    {</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true"></a>        <span class="cf">if</span> (is_valid_score(score) || not_score(score)) {</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true"></a>            <span class="cf">return</span>;</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true"></a>        }</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true"></a>        <span class="cf">throw</span> <span class="bu">std::</span>out_of_range{<span class="st">&quot;Invalid Score&quot;</span>};</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true"></a>    }</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true"></a>    <span class="dt">void</span> TestScore::AddScore(TestScore::<span class="dt">ScoreOne_t</span> <span class="at">const</span>&amp; one_test_score)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true"></a>    {</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : one_test_score) {</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true"></a>            validate_score(pair.second);</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true"></a>        }</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true"></a>        <span class="cf">if</span> (<span class="va">test_score_row_</span>.size() == <span class="dv">0</span>) {</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true"></a>            <span class="va">test_score_row_</span>[one_test_score[<span class="dv">0</span>].first] = <span class="bu">std::</span>vector&lt;<span class="dt">int32_t</span>&gt;{};</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true"></a>        }</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true"></a></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span>&amp; pair : <span class="va">test_score_row_</span>) {</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true"></a>            pair.second.push_back(-<span class="dv">1</span>);</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true"></a>        }</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true"></a></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true"></a>        <span class="kw">auto</span> curr_test_count = <span class="va">test_score_row_</span>.begin()-&gt;second.size();</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true"></a></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : one_test_score) {</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="va">test_score_row_</span>.find(pair.first) == <span class="va">test_score_row_</span>.end()) {</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true"></a>                <span class="va">test_score_row_</span>[pair.first] = <span class="bu">std::</span>vector&lt;<span class="dt">int32_t</span>&gt;(curr_test_count, -<span class="dv">1</span>);</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true"></a>            }</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true"></a>            <span class="va">test_score_row_</span>[pair.first].back() = pair.second;</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true"></a>        }</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true"></a>    }</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true"></a></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true"></a>    <span class="dt">void</span> TestScore::LoadCSV(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename)</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true"></a>    {</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true"></a>        <span class="kw">auto</span> data = <span class="bu">std::</span>ifstream{filename};</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true"></a></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true"></a>        <span class="kw">auto</span> test_score_raw = <span class="dt">ScoreAll_t</span>{};</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true"></a>        <span class="kw">auto</span> line           = <span class="bu">std::</span>string{};</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true"></a>        <span class="cf">while</span> (<span class="bu">std::</span>getline(data, line)) {</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true"></a>            <span class="co">// std::pair&lt;TestScore::ScoreAll_t::iterator, bool&gt;</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true"></a>            <span class="kw">auto</span> ret = test_score_raw.insert(parse_line(line));</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true"></a>            <span class="ot">assert</span>(ret.second);</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true"></a>        }</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true"></a></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : test_score_raw) {</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span> s : pair.second) {</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true"></a>                validate_score(s);</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true"></a>            }</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true"></a>        }</span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true"></a></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true"></a>        <span class="va">test_score_row_</span>.swap(test_score_raw);</span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true"></a>    }</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true"></a></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true"></a>    <span class="dt">void</span> StoreCSV(TestScore <span class="at">const</span>&amp; test_score, <span class="bu">std::</span>string <span class="at">const</span>&amp; filename)</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true"></a>    {</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true"></a>        <span class="kw">auto</span> data = <span class="bu">std::</span>ofstream{filename};</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true"></a>        <span class="kw">auto</span> ss   = <span class="bu">std::</span>ostringstream{};</span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true"></a></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : test_score) {</span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true"></a>            ss &lt;&lt; pair.first;</span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span> s : pair.second) {</span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true"></a>                ss &lt;&lt; <span class="st">&quot;, &quot;</span> &lt;&lt; s;</span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true"></a>            }</span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true"></a>            ss &lt;&lt; <span class="bu">std::</span>endl;</span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true"></a>        }</span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true"></a></span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true"></a>        data &lt;&lt; ss.str();</span>
<span id="cb34-81"><a href="#cb34-81" aria-hidden="true"></a>    }</span>
<span id="cb34-82"><a href="#cb34-82" aria-hidden="true"></a></span>
<span id="cb34-83"><a href="#cb34-83" aria-hidden="true"></a>    ...</span>
<span id="cb34-84"><a href="#cb34-84" aria-hidden="true"></a></span>
<span id="cb34-85"><a href="#cb34-85" aria-hidden="true"></a>    TestScore::<span class="dt">ScoreOne_t</span> Average(TestScore <span class="at">const</span>&amp; test_score)</span>
<span id="cb34-86"><a href="#cb34-86" aria-hidden="true"></a>    {</span>
<span id="cb34-87"><a href="#cb34-87" aria-hidden="true"></a>        <span class="kw">auto</span> ret = TestScore::<span class="dt">ScoreOne_t</span>{};</span>
<span id="cb34-88"><a href="#cb34-88" aria-hidden="true"></a></span>
<span id="cb34-89"><a href="#cb34-89" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : test_score) {</span>
<span id="cb34-90"><a href="#cb34-90" aria-hidden="true"></a>            <span class="kw">auto</span> sum         = <span class="dv">0</span>;</span>
<span id="cb34-91"><a href="#cb34-91" aria-hidden="true"></a>            <span class="kw">auto</span> valid_count = <span class="dv">0</span><span class="bu">U</span>;</span>
<span id="cb34-92"><a href="#cb34-92" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span> s : pair.second) {</span>
<span id="cb34-93"><a href="#cb34-93" aria-hidden="true"></a>                <span class="cf">if</span> (is_valid_score(s)) {</span>
<span id="cb34-94"><a href="#cb34-94" aria-hidden="true"></a>                    sum += s;</span>
<span id="cb34-95"><a href="#cb34-95" aria-hidden="true"></a>                    ++valid_count;</span>
<span id="cb34-96"><a href="#cb34-96" aria-hidden="true"></a>                }</span>
<span id="cb34-97"><a href="#cb34-97" aria-hidden="true"></a>            }</span>
<span id="cb34-98"><a href="#cb34-98" aria-hidden="true"></a>            ret.emplace_back(<span class="bu">std::</span>make_pair(pair.first, valid_count == <span class="dv">0</span> ? -<span class="dv">1</span> : sum / valid_count));</span>
<span id="cb34-99"><a href="#cb34-99" aria-hidden="true"></a>        }</span>
<span id="cb34-100"><a href="#cb34-100" aria-hidden="true"></a></span>
<span id="cb34-101"><a href="#cb34-101" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb34-102"><a href="#cb34-102" aria-hidden="true"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/srp_test_score_ut.cpp 13</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true"></a>    ...</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true"></a>    TEST_F(SolidSRP_A, TestScore_StoreCSV)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true"></a>    {</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true"></a>        <span class="kw">auto</span> ts = TestScore{};</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true"></a>        ts.LoadCSV(<span class="va">test_score_org_</span>);</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true"></a>        StoreCSV(ts, <span class="va">test_score_act_</span>);</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true"></a>        <span class="kw">auto</span> content_act = whole_file(<span class="va">test_score_act_</span>);</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true"></a>        <span class="kw">auto</span> content_exp = whole_file(<span class="va">test_score_exp_</span>);</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true"></a>        ASSERT_EQ(content_exp, content_act);</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true"></a>        <span class="co">// 不正ファイルロード</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true"></a>        <span class="kw">auto</span> ts2 = ts;</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true"></a>        ASSERT_THROW(ts.LoadCSV(<span class="va">test_score_exp_err_</span>), <span class="bu">std::</span>out_of_range);</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true"></a>        <span class="co">// エクセプション 強い保証</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true"></a>        ASSERT_TRUE(<span class="bu">std::</span>equal(ts.begin(), ts.end(), ts2.begin()));</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true"></a>    }</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true"></a>    TEST_F(SolidSRP_A, TestScore_Average)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true"></a>    {</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true"></a>        <span class="kw">auto</span> ts = TestScore{};</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true"></a>        ts.LoadCSV(<span class="va">test_score_org_</span>);</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> exp = TestScore::<span class="dt">ScoreOne_t</span>{</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;堂林&quot;</span>, <span class="dv">65</span>),</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;広輔&quot;</span>, <span class="dv">26</span>),</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;會澤&quot;</span>, <span class="dv">53</span>),</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;松山&quot;</span>, <span class="dv">73</span>),</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;菊池&quot;</span>, <span class="dv">50</span>),</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;鈴木&quot;</span>, <span class="dv">60</span>),</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true"></a>        };</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true"></a>        <span class="kw">auto</span> act = Average(ts);</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true"></a>        ASSERT_EQ(act, exp);</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true"></a>    }</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_8_1">演習-SRP</a>へ戻る。</li>
</ul>
<h3 id="解答例-ocp">解答例-OCP <a id="SS_20_8_2"></a></h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/ocp_test_score.h 8</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a>    <span class="co">// 下記クラスTestScoreは、</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true"></a>    <span class="co">//      * テスト受講者とその点数を保持/提供する。</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true"></a>    <span class="co">//      * テスト受講者とその点数をCSVファイルからロードする。</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true"></a>    <span class="co">// 責任を持つ。サポートするファイル形式が増えた場合、このクラスを修正せざるを得ないため、</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true"></a>    <span class="co">// 機能拡張に対して開いていない。つまり、OCPに反していると言える</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true"></a>    <span class="co">// (実際にはこの程度の違反が問題になることは稀である)。</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true"></a>    <span class="co">// サポートしているファイル形式はCSVのみであったが、TSVを追加することになった。</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true"></a>    <span class="co">// 今後もサポートするファイル形式を増やす必要があるため、OCPに従った方が良いと判断し、</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true"></a>    <span class="co">// TestScoreの責務から「ファイルのロード」を外し、その機能を外部関数として定義することにした。</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true"></a>    <span class="co">// これに従い、下記クラスTestScoreを修正し、外部関数</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true"></a>    <span class="co">//      void LoadCSV(std::string const&amp; filename, TestScore&amp; test_score);</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true"></a>    <span class="co">// を作り、単体テストを行え。</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true"></a>    <span class="kw">class</span> TestScore {</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true"></a>        TestScore()                            = <span class="cf">default</span>;</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true"></a>        TestScore(TestScore <span class="at">const</span>&amp;)            = <span class="cf">default</span>;</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true"></a>        TestScore&amp; <span class="kw">operator</span>=(TestScore <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true"></a>        TestScore&amp; <span class="kw">operator</span>=(TestScore&amp;&amp;)      = <span class="cf">default</span>;  <span class="co">// moveが必要になった</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true"></a>        ...</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true"></a>        <span class="co">// void LoadCSV(std::string const&amp; filename);</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true"></a>        <span class="co">// は外部関数にした。</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true"></a>        <span class="dt">ScoreAll_t</span>::const_iterator begin() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">test_score_row_</span>.begin(); }</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true"></a>        <span class="dt">ScoreAll_t</span>::const_iterator end() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">test_score_row_</span>.end(); }</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true"></a>        <span class="co">// int32_t score: 0～100はスコア、-1は未受験、それ以外は不正データ</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true"></a>        <span class="dt">void</span>       validate_score(<span class="dt">int32_t</span> score) <span class="at">const</span>;</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true"></a>        <span class="dt">ScoreAll_t</span> <span class="va">test_score_row_</span>{};</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true"></a>    };</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true"></a></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true"></a>    <span class="bu">std::</span>string           ToString(TestScore <span class="at">const</span>&amp; ts);</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true"></a>    <span class="dt">void</span>                  LoadCSV(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename, TestScore&amp; test_score);</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true"></a>    <span class="dt">void</span>                  StoreCSV(TestScore <span class="at">const</span>&amp; test_score, <span class="bu">std::</span>string <span class="at">const</span>&amp; filename);</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true"></a>    TestScore::<span class="dt">ScoreOne_t</span> Average(TestScore <span class="at">const</span>&amp; test_score);</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/ocp_test_score.cpp 10</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true"></a>    ...</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true"></a>    <span class="dt">void</span> LoadCSV(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename, TestScore&amp; test_score)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true"></a>    {</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true"></a>        <span class="kw">auto</span> data = <span class="bu">std::</span>ifstream{filename};</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true"></a>        <span class="kw">auto</span> test_score_raw = TestScore::<span class="dt">ScoreAll_t</span>{};</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true"></a>        <span class="kw">auto</span> line           = <span class="bu">std::</span>string{};</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true"></a>        <span class="cf">while</span> (<span class="bu">std::</span>getline(data, line)) {</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true"></a>            <span class="co">// std::pair&lt;TestScore::ScoreAll_t::iterator, bool&gt;</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true"></a>            <span class="kw">auto</span> ret = test_score_raw.insert(parse_line(line));</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true"></a>            <span class="ot">assert</span>(ret.second);</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true"></a>        }</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true"></a>        <span class="kw">auto</span> one_test = TestScore::<span class="dt">ScoreOne_t</span>{};</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : test_score_raw) {</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true"></a>            one_test.emplace_back(<span class="bu">std::</span>make_pair(pair.first, <span class="dv">0</span>));</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true"></a>        }</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> score_count = test_score_raw.begin()-&gt;second.size();</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true"></a>        <span class="kw">auto</span>       ts          = TestScore{};</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i = <span class="dv">0</span><span class="bu">U</span>; i &lt; score_count; ++i) {</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span>&amp; pair : one_test) {</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true"></a>                pair.second = test_score_raw[pair.first][i];</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true"></a>            }</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true"></a>            ts.AddScore(one_test);</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true"></a>        }</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true"></a>        test_score = <span class="bu">std::</span>move(ts);</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true"></a>    }</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true"></a></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true"></a>    <span class="dt">void</span> StoreCSV(TestScore <span class="at">const</span>&amp; test_score, <span class="bu">std::</span>string <span class="at">const</span>&amp; filename)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true"></a>    {</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true"></a>        <span class="kw">auto</span> data = <span class="bu">std::</span>ofstream{filename};</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true"></a>        <span class="kw">auto</span> ss   = <span class="bu">std::</span>ostringstream{};</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true"></a></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : test_score) {</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true"></a>            ss &lt;&lt; pair.first;</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span> s : pair.second) {</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true"></a>                ss &lt;&lt; <span class="st">&quot;, &quot;</span> &lt;&lt; s;</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true"></a>            }</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true"></a>            ss &lt;&lt; <span class="bu">std::</span>endl;</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true"></a>        }</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true"></a></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true"></a>        data &lt;&lt; ss.str();</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true"></a>    }</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true"></a></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true"></a>    <span class="bu">std::</span>string ToString(TestScore <span class="at">const</span>&amp; ts)</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true"></a>    {</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true"></a>        <span class="kw">auto</span> ss = <span class="bu">std::</span>ostringstream{};</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true"></a></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : ts) {</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true"></a>            ss &lt;&lt; pair.first &lt;&lt; <span class="ch">&#39;:&#39;</span>;</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span> s : pair.second) {</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true"></a>                ss &lt;&lt; <span class="ch">&#39; &#39;</span> &lt;&lt; s;</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true"></a>            }</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true"></a>            ss &lt;&lt; <span class="bu">std::</span>endl;</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true"></a>        }</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true"></a></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true"></a>        <span class="cf">return</span> ss.str();</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true"></a>    }</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true"></a></span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true"></a>    TestScore::<span class="dt">ScoreOne_t</span> Average(TestScore <span class="at">const</span>&amp; test_score)</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true"></a>    {</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true"></a>        <span class="kw">auto</span> ret = TestScore::<span class="dt">ScoreOne_t</span>{};</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true"></a></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : test_score) {</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true"></a>            <span class="kw">auto</span> sum         = <span class="dv">0</span>;</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true"></a>            <span class="kw">auto</span> valid_count = <span class="dv">0</span><span class="bu">U</span>;</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span> s : pair.second) {</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true"></a>                <span class="cf">if</span> (is_valid_score(s)) {</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true"></a>                    sum += s;</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true"></a>                    ++valid_count;</span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true"></a>                }</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true"></a>            }</span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true"></a>            ret.emplace_back(<span class="bu">std::</span>make_pair(pair.first, valid_count == <span class="dv">0</span> ? -<span class="dv">1</span> : sum / valid_count));</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true"></a>        }</span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true"></a></span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/ocp_test_score_ut.cpp 13</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true"></a>    TEST_F(SolidOCP_A, TestScore_LoadCSV)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true"></a>    {</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true"></a>        <span class="kw">auto</span> ts = TestScore{};</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true"></a>        LoadCSV(<span class="va">test_score_org_</span>, ts);</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true"></a>        ...</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true"></a>    }</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true"></a>    ...</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true"></a>    TEST_F(SolidOCP_A, TestScore_AddScore)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true"></a>    {</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true"></a>        <span class="kw">auto</span> ts = TestScore{};</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true"></a>        LoadCSV(<span class="va">test_score_org_</span>, ts);</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true"></a>        ...</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true"></a>    }</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true"></a>    TEST_F(SolidOCP_A, TestScore_GetScore)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true"></a>    {</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true"></a>        <span class="kw">auto</span> ts = TestScore{};</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true"></a>        LoadCSV(<span class="va">test_score_org_</span>, ts);</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true"></a>        ...</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true"></a>    }</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true"></a>    TEST_F(SolidOCP_A, TestScore_StoreCSV)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true"></a>    {</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true"></a>        <span class="kw">auto</span> ts = TestScore{};</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true"></a>        LoadCSV(<span class="va">test_score_org_</span>, ts);</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true"></a>        StoreCSV(ts, <span class="va">test_score_act_</span>);</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true"></a>        <span class="kw">auto</span> content_act = whole_file(<span class="va">test_score_act_</span>);</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true"></a>        <span class="kw">auto</span> content_exp = whole_file(<span class="va">test_score_exp_</span>);</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true"></a>        ASSERT_EQ(content_exp, content_act);</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true"></a>        <span class="co">// 不正ファイルロード</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true"></a>        <span class="kw">auto</span> ts2 = ts;</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true"></a>        ASSERT_THROW(LoadCSV(<span class="va">test_score_exp_err_</span>, ts2), <span class="bu">std::</span>out_of_range);</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true"></a>        <span class="co">// エクセプション 強い保証</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true"></a>        ASSERT_TRUE(<span class="bu">std::</span>equal(ts.begin(), ts.end(), ts2.begin()));</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true"></a>    }</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true"></a></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true"></a>    TEST_F(SolidOCP_A, TestScore_Average)</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true"></a>    {</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true"></a>        <span class="kw">auto</span> ts = TestScore{};</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true"></a>        LoadCSV(<span class="va">test_score_org_</span>, ts);</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true"></a></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true"></a>        ...</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true"></a>    }</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_8_2">演習-OCP</a>へ戻る。</li>
</ul>
<h3 id="解答例-lsp">解答例-LSP <a id="SS_20_8_3"></a></h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/lsp_test_score.h 8</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true"></a>    <span class="co">// 下記クラスTestScoreが管理するテストのスコアの値は、</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true"></a>    <span class="co">//      * 0～100   テストのスコア</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true"></a>    <span class="co">//      *-1        未受験</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true"></a>    <span class="co">//      * それ以外 不正値であるため、このデータを入力すると</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true"></a>    <span class="co">//                 std::out_of_rangeエクセプションが発生する。</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true"></a>    <span class="co">// を表すが、未受講を許可しない仕様(受験できない場合のスコアは0点)の</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true"></a>    <span class="co">// TestScoreForceも必要になったため下記のように定義した。</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true"></a>    <span class="co">//      * TestScoreForceが管理するテストのスコアの値は</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true"></a>    <span class="co">//           * 0～100   テストのスコア</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true"></a>    <span class="co">//           * それ以外 不正値であるため、このデータを入力すると</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true"></a>    <span class="co">//                      std::out_of_rangeエクセプションが発生する。</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true"></a>    <span class="co">//      * それ以外の動作はTestScoreと同じ。</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true"></a>    <span class="co">//  これは、事前条件(「-1～100を受け入れる」から「0～100を受け入れる」)の強化であるため、</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true"></a>    <span class="co">//  LSPに反する。</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true"></a>    <span class="co">//  これにより起こる問題点を単体テストを用いて指摘せよ。</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true"></a>    <span class="co">// 上記問題を解決するため、クラスTestScoreForceFixedを作り単体テストを行え。</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true"></a>    <span class="co">// TestScoreForceFixedをTestScoreからprivate継承することで、</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true"></a>    <span class="co">// TestScoreForceFixedとTestScorの関係がis-aの関係ではなくなるためLSPに適合する。</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true"></a>    <span class="co">// 一方で、private継承の影響で、TestScoreForceFixedは、</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true"></a>    <span class="co">//      * void LoadCSV(std::string const&amp; filename, TestScore&amp; test_score);</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true"></a>    <span class="co">//      * void StoreCSV(TestScore const&amp; test_score, std::string const&amp; filename);</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true"></a>    <span class="co">// 等TestScoreオブジェクトのリファレンスやポインタを受け取る関数が使えなくなる</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true"></a>    <span class="co">// (そもそもそれが目的でprivate継承にした)。</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true"></a>    <span class="co">// これに対処するために、オリジナルのコードをほとんどクローンした</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true"></a>    <span class="co">//      * void LoadCSV(std::string const&amp; filename, TestScoreForceFixed&amp; test_score);</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true"></a>    <span class="co">//      * void StoreCSV(TestScoreForceFixed const&amp; test_score, std::string const&amp; filename);</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true"></a>    <span class="co">// を作ることは当然、誤りである。</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true"></a>    <span class="co">// クローンを作らずに対処するためのコードを単体テストに記述したので参照してほしい。</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true"></a>    <span class="co">// また、TestScoreForceを作ったことが根本的な誤りであった可能性もある。</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true"></a>    <span class="co">// 「未受講データ-1を入力された場合、それをテストスコア0と解釈する」ようなオプションを</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true"></a>    <span class="co">// TestScoreに持たせることも考慮すべきであった。</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true"></a></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true"></a>    <span class="kw">class</span> TestScore {</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true"></a>        ...</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true"></a>    };</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true"></a></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true"></a>    <span class="kw">class</span> TestScoreForce : <span class="kw">public</span> TestScore {</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true"></a>        ...</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true"></a>    };</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true"></a></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true"></a>    <span class="kw">class</span> TestScoreForceFixed : TestScore {</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true"></a>        TestScoreForceFixed()                                      = <span class="cf">default</span>;</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true"></a>        <span class="kw">virtual</span> ~TestScoreForceFixed()                             = <span class="cf">default</span>;</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true"></a>        TestScoreForceFixed(TestScoreForceFixed <span class="at">const</span>&amp;)            = <span class="cf">default</span>;</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true"></a>        TestScoreForceFixed&amp; <span class="kw">operator</span>=(TestScoreForceFixed <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true"></a>        TestScoreForceFixed&amp; <span class="kw">operator</span>=(TestScoreForceFixed&amp;&amp;)      = <span class="cf">default</span>;</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true"></a></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true"></a>        <span class="kw">using</span> <span class="dt">ScoreAll_t</span> = TestScore::<span class="dt">ScoreAll_t</span>;</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true"></a>        <span class="kw">using</span> <span class="dt">ScoreOne_t</span> = TestScore::<span class="dt">ScoreOne_t</span>;</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true"></a></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true"></a>        <span class="kw">using</span> TestScore::AddScore;</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true"></a>        <span class="kw">using</span> TestScore::GetScore;</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true"></a></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true"></a>        <span class="kw">using</span> TestScore::begin;</span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true"></a>        <span class="kw">using</span> TestScore::end;</span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true"></a></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true"></a>        <span class="co">// int32_t score: 0～100はスコア、それ以外は不正データ</span></span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> validate_score(<span class="dt">int32_t</span> score) <span class="at">const</span> <span class="kw">override</span>;</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true"></a>    };</span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true"></a></span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true"></a>    <span class="bu">std::</span>string           ToString(TestScore <span class="at">const</span>&amp; ts);</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true"></a>    <span class="dt">void</span>                  LoadCSV(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename, TestScore&amp; test_score);</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true"></a>    <span class="dt">void</span>                  StoreCSV(TestScore <span class="at">const</span>&amp; test_score, <span class="bu">std::</span>string <span class="at">const</span>&amp; filename);</span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true"></a>    TestScore::<span class="dt">ScoreOne_t</span> Average(TestScore <span class="at">const</span>&amp; test_score);</span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/lsp_test_score.cpp 10</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a>    ...</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a>    <span class="dt">void</span> TestScoreForceFixed::validate_score(<span class="dt">int32_t</span> score) <span class="at">const</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true"></a>    {</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true"></a>        <span class="cf">if</span> (is_valid_score(score)) {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true"></a>            <span class="cf">return</span>;</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true"></a>        }</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true"></a>        <span class="cf">throw</span> <span class="bu">std::</span>out_of_range{<span class="st">&quot;Invalid Score&quot;</span>};</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true"></a>    }</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true"></a>    ...</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/lsp_test_score_ut.cpp 15</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true"></a>    ...</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true"></a>    <span class="co">// ファイルtest_score_org_には、TestScoreForceの不正値が含まれているため、</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true"></a>    <span class="co">// 下記の単体テストでの、</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true"></a>    <span class="co">//      LoadCSV(test_score_org_, ts_f);</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true"></a>    <span class="co">// はエクセプションが発生するべきだが、実際にはパスしてしまう。</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true"></a>    <span class="co">// 一方で、エクセプションが発生するようにLoadCSVを変更するには、LoadCVSの第2引数の</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true"></a>    <span class="co">// ランタイム時の実際の型が必要になってしまうため、この解決手段にも問題がある。</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true"></a>    TEST_F(SolidLSP_A, TestScoreForce_LoadCSV)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true"></a>    {</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true"></a>        <span class="kw">auto</span> ts_f = TestScoreForce{};</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true"></a>        LoadCSV(<span class="va">test_score_org_</span>, ts_f);  <span class="co">// 本来はエクセプションが発生すべき。</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> exp = TestScore::<span class="dt">ScoreAll_t</span>{</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;堂林&quot;</span>, {-<span class="dv">1</span>, <span class="dv">50</span>, <span class="dv">80</span>}),</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;広輔&quot;</span>, {<span class="dv">40</span>, <span class="dv">30</span>, <span class="dv">10</span>}),</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;會澤&quot;</span>, {<span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">70</span>}),</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;松山&quot;</span>, {<span class="dv">80</span>, <span class="dv">90</span>, <span class="dv">50</span>}),</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;菊池&quot;</span>, {<span class="dv">50</span>, <span class="dv">20</span>, <span class="dv">80</span>}),</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;鈴木&quot;</span>, {<span class="dv">0</span>, <span class="dv">80</span>, <span class="dv">100</span>}),</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true"></a>        };</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true"></a></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true"></a>        ASSERT_TRUE(<span class="bu">std::</span>equal(ts_f.begin(), ts_f.end(), exp.begin()));</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> one_score = TestScore::<span class="dt">ScoreOne_t</span>{</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;堂林&quot;</span>, <span class="dv">50</span>),</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;広輔&quot;</span>, <span class="dv">40</span>),</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;會澤&quot;</span>, <span class="dv">70</span>),</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;松山&quot;</span>, <span class="dv">1</span>),</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;菊池&quot;</span>, -<span class="dv">1</span>),</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;鈴木&quot;</span>, <span class="dv">5</span>),</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;田中&quot;</span>, <span class="dv">100</span>),</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreOne_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;西川&quot;</span>, <span class="dv">90</span>),</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true"></a>        };</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true"></a>    }</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true"></a>    <span class="bu">std::</span>pair&lt;<span class="bu">std::</span>string, <span class="bu">std::</span>vector&lt;<span class="dt">int32_t</span>&gt;&gt; parse_line(<span class="bu">std::</span>string <span class="at">const</span>&amp; line)</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true"></a>    {</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> csv_sep = <span class="bu">std::</span>regex{<span class="st">R&quot;( *, *)&quot;</span>};</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true"></a>        <span class="kw">auto</span>       name    = <span class="bu">std::</span>string{};</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true"></a>        <span class="kw">auto</span>       score   = <span class="bu">std::</span>vector&lt;<span class="dt">int32_t</span>&gt;{};</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true"></a></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true"></a>        <span class="kw">auto</span> end = <span class="bu">std::</span>sregex_token_iterator{};</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> it = <span class="bu">std::</span>sregex_token_iterator{line.begin(), line.end(), csv_sep, -<span class="dv">1</span>}; it != end;</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true"></a>             ++it) {</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true"></a>            <span class="cf">if</span> (name.length() == <span class="dv">0</span>) {</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true"></a>                name = *it;</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true"></a>            }</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true"></a>            <span class="cf">else</span> {</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true"></a>                <span class="kw">auto</span> s = <span class="bu">std::</span>stoi(*it);</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true"></a>                score.emplace_back(s);</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true"></a>            }</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true"></a>        }</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true"></a></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true"></a>        <span class="cf">return</span> {<span class="bu">std::</span>move(name), <span class="bu">std::</span>move(score)};</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true"></a>    }</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true"></a></span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> TEST_SCORE&gt;</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true"></a>    TEST_SCORE LoadCSV(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename)</span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true"></a>    {</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true"></a>        <span class="kw">static_assert</span>(</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true"></a>            <span class="bu">std::</span>is_same_v&lt;TEST_SCORE, TestScore&gt; || <span class="bu">std::</span>is_same_v&lt;TEST_SCORE, TestScoreForceFixed&gt;);</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true"></a></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true"></a>        <span class="kw">auto</span> data = <span class="bu">std::</span>ifstream{filename};</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true"></a></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true"></a>        <span class="kw">typename</span> TEST_SCORE::<span class="dt">ScoreAll_t</span> test_score_raw;</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true"></a>        <span class="kw">auto</span>                            line = <span class="bu">std::</span>string{};</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true"></a>        <span class="cf">while</span> (<span class="bu">std::</span>getline(data, line)) {</span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true"></a>            <span class="co">// std::pair&lt;TestScore::ScoreAll_t::iterator, bool&gt;</span></span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true"></a>            <span class="kw">auto</span> ret = test_score_raw.insert(parse_line(line));</span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true"></a>            <span class="ot">assert</span>(ret.second);</span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true"></a>        }</span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true"></a></span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true"></a>        <span class="kw">typename</span> TEST_SCORE::<span class="dt">ScoreOne_t</span> one_test;</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; pair : test_score_raw) {</span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true"></a>            one_test.emplace_back(<span class="bu">std::</span>make_pair(pair.first, <span class="dv">0</span>));</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true"></a>        }</span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true"></a></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> score_count = test_score_raw.begin()-&gt;second.size();</span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true"></a>        <span class="kw">auto</span>       ts          = TEST_SCORE{};</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true"></a></span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i = <span class="dv">0</span><span class="bu">U</span>; i &lt; score_count; ++i) {</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span>&amp; pair : one_test) {</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true"></a>                pair.second = test_score_raw[pair.first][i];</span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true"></a>            }</span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true"></a>            ts.AddScore(one_test);</span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true"></a>        }</span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true"></a></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true"></a>        <span class="cf">return</span> ts;</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true"></a>    }</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true"></a></span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true"></a>    TEST_F(SolidLSP_A, TestScoreForceFixed_LoadCSV)</span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true"></a>    {</span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true"></a>        <span class="co">// 下で使用しているLoadCSVはtemplateで実装し直したもの(上記templace &lt;&gt;LoadCSV)。</span></span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true"></a>        <span class="co">// 従来のLoadCSVでは型違いでコンパイルできない。</span></span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true"></a>        <span class="co">// また、従来のLoadCSVは第2引数をTestScore&amp;をしたため、</span></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true"></a>        <span class="co">// ここで指摘したような問題を引き起こしやすい。この問題を解決するため、</span></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true"></a>        <span class="co">// templace &lt;&gt;LoadCSVは引数での値戻しをやめ、リターンでの値戻しに改めた。</span></span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true"></a>        ASSERT_THROW(LoadCSV&lt;TestScoreForceFixed&gt;(<span class="va">test_score_org_</span>), <span class="bu">std::</span>out_of_range);</span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true"></a></span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true"></a>        TestScoreForceFixed ts_f_f = LoadCSV&lt;TestScoreForceFixed&gt;(<span class="va">test_score_org_f_</span>);</span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true"></a></span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> exp = TestScore::<span class="dt">ScoreAll_t</span>{</span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;堂林&quot;</span>, {<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">80</span>}),</span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;広輔&quot;</span>, {<span class="dv">40</span>, <span class="dv">30</span>, <span class="dv">10</span>}),</span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;會澤&quot;</span>, {<span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">70</span>}),</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;松山&quot;</span>, {<span class="dv">80</span>, <span class="dv">90</span>, <span class="dv">50</span>}),</span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;菊池&quot;</span>, {<span class="dv">50</span>, <span class="dv">20</span>, <span class="dv">80</span>}),</span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true"></a>            TestScore::<span class="dt">ScoreAll_t</span>::<span class="dt">value_type</span>(<span class="st">&quot;鈴木&quot;</span>, {<span class="dv">0</span>, <span class="dv">80</span>, <span class="dv">100</span>}),</span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true"></a>        };</span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true"></a></span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true"></a>        ASSERT_TRUE(<span class="bu">std::</span>equal(ts_f_f.begin(), ts_f_f.end(), exp.begin()));</span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true"></a>    }</span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_8_3">演習-LSP</a>へ戻る。</li>
</ul>
<h3 id="解答例-isp">解答例-ISP <a id="SS_20_8_4"></a></h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/isp_test_score_average.h 8</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true"></a>    <span class="co">// 下記クラスTestScoreの管理データの内、受験者とその平均スコア、</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true"></a>    <span class="co">// 平均スコアの高い順でソートされた受験者リストを扱うクラスが必要になったため、</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true"></a>    <span class="co">// 下記のようにイミュータブルなクラスTestScoreAverageを作成した。</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true"></a>    <span class="co">// 現在のファイル構成では、TestScoreAverageのみを使うクラスや関数にも、</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true"></a>    <span class="co">// このファイル全体への依存を強いる(つまり、TestScoreやLoadCSV等に依存させる)ため、</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true"></a>    <span class="co">// ISPに反する。</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true"></a>    <span class="co">// TestScoreAverageを使うクラスや関数に余計な依存関係が発生しないようにリファクタリングを</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true"></a>    <span class="co">// 行え。</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true"></a>    <span class="co">// TestScoreAverageの宣言・定義をsolid_isp_test_score_a.hからこのファイルに移動し、</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true"></a>    <span class="co">// TestScoreAverageのTestScore依存部分をTestScoreAverageDataで隠蔽することで、</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true"></a>    <span class="co">// このファイルからのsolid_isp_test_score_a.hの依存を消した。</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true"></a>    <span class="co">// また、TestScoreAverageのTestScore依存部はすべてsolid_isp_test_score_average_a.cppに移動した。</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true"></a>    <span class="co">// これにより、TestScoreAverageの利用者はTestScoreに依存しなくなった。</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true"></a>    <span class="kw">class</span> TestScoreAverage {</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true"></a>        <span class="kw">explicit</span> TestScoreAverage(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename);</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true"></a>        ~TestScoreAverage();</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true"></a>        <span class="dt">uint32_t</span>                        GetAverage(<span class="bu">std::</span>string <span class="at">const</span>&amp; name) <span class="at">const</span>;</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; DescendingOrder() <span class="at">const</span>;</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true"></a>        <span class="kw">struct</span> TestScoreAverageData;</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;TestScoreAverageData&gt; <span class="at">const</span> <span class="va">data_</span>;</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true"></a>    };</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/isp_test_score.h 8</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a>    <span class="kw">class</span> TestScore {</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true"></a>        ...</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true"></a>    };</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true"></a>    <span class="bu">std::</span>string           ToString(TestScore <span class="at">const</span>&amp; ts);</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true"></a>    TestScore             LoadCSV(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename);</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true"></a>    <span class="dt">void</span>                  StoreCSV(TestScore <span class="at">const</span>&amp; test_score, <span class="bu">std::</span>string <span class="at">const</span>&amp; filename);</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true"></a>    TestScore::<span class="dt">ScoreOne_t</span> Average(TestScore <span class="at">const</span>&amp; test_score);</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/isp_test_score_average.cpp 10</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true"></a>    TestScore::<span class="dt">ScoreOne_t</span> get_average(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true"></a>    {</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true"></a>        TestScore ts = LoadCSV(filename);</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true"></a>        <span class="cf">return</span> Average(ts);</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true"></a>    }</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true"></a>    <span class="kw">struct</span> TestScoreAverage::TestScoreAverageData {</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true"></a>        TestScoreAverageData(TestScore::<span class="dt">ScoreOne_t</span>&amp;&amp; average) : average{<span class="bu">std::</span>move(average)} {}</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true"></a>        TestScore::<span class="dt">ScoreOne_t</span> <span class="at">const</span> average;</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;    desending_order{};</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true"></a>    };</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true"></a>    TestScoreAverage::TestScoreAverage(<span class="bu">std::</span>string <span class="at">const</span>&amp; filename)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true"></a>        : <span class="va">data_</span>{<span class="bu">std::</span>make_unique&lt;TestScoreAverage::TestScoreAverageData&gt;(get_average(filename))}</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true"></a>    {</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true"></a>    }</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true"></a>    TestScoreAverage::~TestScoreAverage() = <span class="cf">default</span>;  <span class="co">// これはヘッダには書けない</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true"></a></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true"></a>    <span class="dt">uint32_t</span> TestScoreAverage::GetAverage(<span class="bu">std::</span>string <span class="at">const</span>&amp; name) <span class="at">const</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true"></a>    {</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true"></a>        <span class="kw">auto</span> pos = <span class="bu">std::</span>find_if(<span class="va">data_</span>-&gt;average.cbegin(), <span class="va">data_</span>-&gt;average.cend(),</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true"></a>                                [&amp;name](<span class="bu">std::</span>pair&lt;<span class="bu">std::</span>string, <span class="dt">int32_t</span>&gt; <span class="at">const</span>&amp; pair) <span class="kw">noexcept</span> {</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true"></a>                                    <span class="cf">return</span> name == pair.first;</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true"></a>                                });</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true"></a></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true"></a>        <span class="cf">if</span> (pos == <span class="va">data_</span>-&gt;average.cend()) {</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true"></a>            <span class="cf">throw</span> <span class="bu">std::</span>out_of_range{<span class="st">&quot;no member&quot;</span>};</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true"></a>        }</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true"></a></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true"></a>        <span class="cf">return</span> pos-&gt;second;</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true"></a>    }</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true"></a></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true"></a>    <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; <span class="at">const</span>&amp; TestScoreAverage::DescendingOrder() <span class="at">const</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true"></a>    {</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true"></a>        <span class="cf">if</span> (<span class="va">data_</span>-&gt;desending_order.size() != <span class="dv">0</span>) {</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">data_</span>-&gt;desending_order;</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true"></a>        }</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true"></a></span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true"></a>        <span class="kw">auto</span> ave = <span class="va">data_</span>-&gt;average;</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true"></a>        <span class="bu">std::</span>sort(ave.begin(), ave.end(),</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true"></a>                  [](<span class="bu">std::</span>pair&lt;<span class="bu">std::</span>string, <span class="dt">int32_t</span>&gt; <span class="at">const</span>&amp; lhs, <span class="kw">auto</span> <span class="at">const</span>&amp; rhs) <span class="kw">noexcept</span> {</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true"></a>                      <span class="cf">return</span> lhs.second &gt; rhs.second;</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true"></a>                  });</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true"></a></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span>&amp; pair : ave) {</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true"></a>            <span class="va">data_</span>-&gt;desending_order.emplace_back(<span class="bu">std::</span>move(pair.first));</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true"></a>        }</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true"></a></span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">data_</span>-&gt;desending_order;</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/isp_test_score.cpp 10</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true"></a>    <span class="co">// 演習コードと同一であるため省略</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true"></a>    ...</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/isp_test_score_average_ut.cpp 13</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true"></a>    TEST_F(SolidISP_A, TestScoreAverage)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true"></a>    {</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true"></a>        <span class="kw">auto</span> tsa = TestScoreAverage{<span class="va">test_score_org_</span>};</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true"></a>        ASSERT_EQ(tsa.GetAverage(<span class="st">&quot;堂林&quot;</span>), <span class="dv">65</span>);</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true"></a>        ASSERT_EQ(tsa.GetAverage(<span class="st">&quot;広輔&quot;</span>), <span class="dv">26</span>);</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true"></a>        ASSERT_EQ(tsa.GetAverage(<span class="st">&quot;會澤&quot;</span>), <span class="dv">53</span>);</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true"></a>        ASSERT_EQ(tsa.GetAverage(<span class="st">&quot;松山&quot;</span>), <span class="dv">73</span>);</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true"></a>        ASSERT_EQ(tsa.GetAverage(<span class="st">&quot;菊池&quot;</span>), <span class="dv">50</span>);</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true"></a>        ASSERT_EQ(tsa.GetAverage(<span class="st">&quot;鈴木&quot;</span>), <span class="dv">60</span>);</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true"></a>        ASSERT_THROW(tsa.GetAverage(<span class="st">&quot;野村&quot;</span>), <span class="bu">std::</span>out_of_range);</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> exp = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true"></a>            <span class="st">&quot;松山&quot;</span>, <span class="st">&quot;堂林&quot;</span>, <span class="st">&quot;鈴木&quot;</span>, <span class="st">&quot;會澤&quot;</span>, <span class="st">&quot;菊池&quot;</span>, <span class="st">&quot;広輔&quot;</span>,</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true"></a>        };</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true"></a>        ASSERT_EQ(tsa.DescendingOrder(), exp);</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true"></a>        ASSERT_EQ(tsa.DescendingOrder(), exp);  <span class="co">// キャッシュのテスト</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true"></a>    }</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/isp_test_score_ut.cpp 13</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true"></a>    <span class="co">// 演習コードと同一であるため省略</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true"></a>    ...</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_8_4">演習-ISP</a>へ戻る。</li>
</ul>
<h3 id="解答例-dip">解答例-DIP <a id="SS_20_8_5"></a></h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/dip_test_score.h 9</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true"></a>    <span class="co">// クラスTestScoreClientは、</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true"></a>    <span class="co">//      * dip_test_score_client.h</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true"></a>    <span class="co">//      * dip_test_score_client.cpp</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true"></a>    <span class="co">// で宣言・定義され、</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true"></a>    <span class="co">// クラスTestScoreLoaderは、</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true"></a>    <span class="co">//      * dip_test_score.h(このファイル)</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true"></a>    <span class="co">//      * dip_test_score.cpp</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true"></a>    <span class="co">// で宣言・定義されされている。</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true"></a>    <span class="co">// TestScoreLoaderは宣言・定義の中にTestScoreClientを使用しているため、</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true"></a>    <span class="co">//      * dip_test_score.cpp -&gt; dip_test_score_client.h</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true"></a>    <span class="co">// の依存関係が発生してる(dip_test_score.h -&gt; dip_test_score_client.hの依存関係は、</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true"></a>    <span class="co">// dip_test_score.h内のTestScoreClientの前方宣言で回避)。</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true"></a>    <span class="co">// クラスの名前からもわかる通り、</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true"></a>    <span class="co">//      * TestScoreClientはTestScoreLoaderのクライアント</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true"></a>    <span class="co">//      * TestScoreLoaderはTestScoreClientのサーバ</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true"></a>    <span class="co">// であるため、この依存関係</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true"></a>    <span class="co">//      * TestScoreLoader -&gt; TestScoreClient(逆の依存関係もあるため、双方向依存)</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true"></a>    <span class="co">//      * dip_test_score.cpp -&gt; dip_test_score_client.h</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true"></a>    <span class="co">// はDIPに反し、機能拡張(や、場合よっては単体テスト可能なパッケージ構成維持)</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true"></a>    <span class="co">// に多大な悪影響がある(TestScoreLoaderを使うTestScoreClient2を新たに定義したときに</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true"></a>    <span class="co">// TestScoreLoaderがどのように修正されるかを考えればこの問題に気づくだろう)。</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true"></a>    <span class="co">// この問題に対処せよ。</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true"></a>    <span class="co">// TestScoreLoaderを「TestScoreClientへの依存」から「TestScoreClientIFへの依存」に変更し、</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true"></a>    <span class="co">// TestScoreClientIFをTestScoreLoaderと同じファイル(このファイル)で宣言・定義したことにより、</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true"></a>    <span class="co">//      * TestScoreLoader -&gt; TestScoreClient</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true"></a>    <span class="co">// の依存関係は解消された。</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true"></a>    <span class="co">// TestScoreClientは、TestScoreClientIFを継承することでTestScoreLoaderのサービスを使用できる。</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true"></a>    <span class="co">// この依存関係は、</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true"></a>    <span class="co">//      * TestScoreClient -&gt; TestScoreClientIF</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true"></a>    <span class="co">// であり、クライアントからサーバへの依存であるため問題にならない。</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true"></a>    <span class="kw">class</span> TestScore {</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true"></a>        ...</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true"></a>    };</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true"></a></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true"></a>    ...</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true"></a></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true"></a>    <span class="kw">class</span> TestScoreClientIF {</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true"></a>        TestScoreClientIF()          = <span class="cf">default</span>;</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true"></a>        <span class="kw">virtual</span> ~TestScoreClientIF() = <span class="cf">default</span>;</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> Done()          = <span class="dv">0</span>;</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true"></a>    };</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true"></a>    <span class="kw">class</span> TestScoreLoader {</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true"></a>        TestScoreLoader() {}</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true"></a>        ~TestScoreLoader();</span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true"></a>        <span class="dt">void</span>      LoadCSV_Async(<span class="bu">std::</span>string&amp;&amp; filename, TestScoreClientIF&amp; client);</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true"></a>        TestScore LoadCSV_Get() { <span class="cf">return</span> <span class="va">future_</span>.get(); }</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true"></a></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true"></a>        <span class="bu">std::</span>future&lt;TestScore&gt; <span class="va">future_</span>{};</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true"></a>    };</span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/dip_test_score.cpp 10</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true"></a>    ...</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true"></a>    <span class="dt">void</span> TestScoreLoader::LoadCSV_Async(<span class="bu">std::</span>string&amp;&amp; filename, TestScoreClientIF&amp; client)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true"></a>    {</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true"></a>        <span class="cf">if</span> (<span class="va">future_</span>.valid()) {</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true"></a>            <span class="va">future_</span>.get();</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true"></a>        }</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true"></a>        <span class="va">future_</span> = <span class="bu">std::</span>async(<span class="bu">std::</span>launch<span class="bu">::</span>async, [&amp;client, filename = <span class="bu">std::</span>move(filename)]() {</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true"></a>            <span class="kw">auto</span> test_score = LoadCSV(filename);</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true"></a>            client.Done();</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true"></a>            <span class="cf">return</span> test_score;</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true"></a>        });</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/dip_test_score_ut.cpp 13</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true"></a>    <span class="co">// 演習コードと同一であるため省略</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true"></a>    ...</span></code></pre></div>
<div class="sourceCode" id="cb51"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/dip_test_score_client.h 11</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true"></a>    <span class="kw">class</span> TestScoreClient : <span class="kw">public</span> TestScoreClientIF {</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true"></a>        <span class="dt">void</span>             LoadAsync(<span class="bu">std::</span>string&amp;&amp; filename);</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span>     Done() <span class="kw">override</span>;</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true"></a>        <span class="dt">void</span>             Wait();</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true"></a>        TestScore <span class="at">const</span>&amp; GetTestScore() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">test_score_</span>; }</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true"></a>        <span class="bu">std::</span>condition_variable <span class="va">condition_</span>{};</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true"></a>        <span class="bu">std::</span>mutex              <span class="va">mutex_</span>{};</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true"></a>        TestScore               <span class="va">test_score_</span>{};</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true"></a>        TestScoreLoader         <span class="va">loader_</span>{};</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true"></a>        <span class="dt">bool</span>                    <span class="va">loaded_</span>{<span class="kw">false</span>};</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true"></a>    };</span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/dip_test_score_client.cpp 5</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true"></a>    <span class="co">// 演習コードと同一であるため省略</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true"></a>    ...</span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/solid_a/dip_test_score_client_ut.cpp 9</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true"></a>    <span class="co">// 演習コードと同一であるため省略</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true"></a>    ...</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_8_5">演習-DIP</a>へ戻る。</li>
</ul>
<h3 id="解答-solidの定義">解答-SOLIDの定義 <a id="SS_20_8_6"></a></h3>
<ul>
<li>選択肢対応
<ul>
<li>SRP - 1</li>
<li>OCP - 2</li>
<li>LIP - 3</li>
<li>ISP - 4</li>
<li>DIP - 5</li>
</ul></li>
<li>参照 <a href="solid.html#SS_8">SOLID</a></li>
<li><a href="exercise_q.html#SS_19_8_6">演習-SOLIDの定義</a>へ戻る。</li>
</ul>
<h2 id="デザインパターン">デザインパターン <a id="SS_20_9"></a></h2>
<h3 id="解答例-ガード節">解答例-ガード節 <a id="SS_20_9_1"></a></h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/guard.cpp 7</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true"></a>    <span class="co">// 以下の関数PrimeNumbersをガード節や、関数の括りだし等によってリファクタリングせよ。</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true"></a>    <span class="kw">inline</span> <span class="dt">uint32_t</span> next_prime_num(<span class="dt">uint32_t</span> curr_prime_num, <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;&amp; is_num_prime) <span class="kw">noexcept</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true"></a>    {</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i = <span class="dv">2</span> * curr_prime_num; i &lt; is_num_prime.size(); i += curr_prime_num) {</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true"></a>            is_num_prime[i] = <span class="kw">false</span>;  <span class="co">// 次の倍数は素数ではない</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true"></a>        }</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num = curr_prime_num;</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true"></a>        <span class="cf">do</span> {  <span class="co">// 次の素数の探索</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true"></a>            ++prime_num;</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true"></a>        } <span class="cf">while</span> (!is_num_prime[prime_num] &amp;&amp; (prime_num &lt; is_num_prime.size()));</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true"></a></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true"></a>        <span class="cf">return</span> prime_num;</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true"></a>    }</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true"></a></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true"></a>    <span class="kw">inline</span> <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; prime_numbers(<span class="dt">uint32_t</span> max_number)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true"></a>    {</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true"></a>        <span class="kw">auto</span> result       = <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{};</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num    = <span class="dv">2</span><span class="bu">U</span>;                                       <span class="co">// 最初の素数</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true"></a>        <span class="kw">auto</span> is_num_prime = <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;(max_number + <span class="dv">1</span>, <span class="kw">true</span>);  <span class="co">// falseなら素数でない</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true"></a>        is_num_prime[<span class="dv">0</span>] = is_num_prime[<span class="dv">1</span>] = <span class="kw">false</span>;</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true"></a></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true"></a>        <span class="cf">do</span> {</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true"></a>            result.emplace_back(prime_num);</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true"></a>            prime_num = next_prime_num(prime_num, is_num_prime);</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true"></a>        } <span class="cf">while</span> (prime_num &lt; is_num_prime.size());</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true"></a></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true"></a>        <span class="cf">return</span> result;</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true"></a>    }</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true"></a></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true"></a>    <span class="bu">std::</span>optional&lt;<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;&gt; PrimeNumbers(<span class="dt">uint32_t</span> max_number)</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true"></a>    {</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true"></a>        <span class="cf">if</span> (max_number &gt;= <span class="dv">65536</span>) {  <span class="co">// ガード節。演算コストが高いためエラーにする</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>nullopt;</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true"></a>        }</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true"></a></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true"></a>        <span class="cf">if</span> (max_number &lt; <span class="dv">2</span>) {  <span class="co">// ガード節。2未満の素数はない</span></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{};</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true"></a>        }</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true"></a></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true"></a>        <span class="cf">return</span> prime_numbers(max_number);</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true"></a>    }</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true"></a></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true"></a>    TEST(DesignPatternA, Guard)</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true"></a>    {</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true"></a>        <span class="kw">auto</span> result = PrimeNumbers(<span class="dv">1</span>);</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true"></a>        ASSERT_TRUE(result);</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{}), *result);</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true"></a></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true"></a>        result = PrimeNumbers(<span class="dv">2</span>);</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true"></a>        ASSERT_TRUE(result);</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>}), *result);</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true"></a></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true"></a>        result = PrimeNumbers(<span class="dv">30</span>);</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true"></a>        ASSERT_TRUE(result);</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">29</span>}), *result);</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true"></a></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true"></a>        ASSERT_FALSE(PrimeNumbers(<span class="dv">65536</span>));</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_1">演習-ガード節</a>へ戻る。</li>
</ul>
<h3 id="解答例-bitmasktype">解答例-BitmaskType <a id="SS_20_9_2"></a></h3>
<div class="sourceCode" id="cb55"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/enum_bitmask.cpp 5</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true"></a>    <span class="co">// 下記関数ColorMask2Strはuint32_t型のビットマスクを引数に取る。</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true"></a>    <span class="co">// これはユーザが使用間違いを起こしやすい脆弱なインターフェースである。</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true"></a>    <span class="co">// enumによるビットマスク表現を使用しこの問題に対処せよ。</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true"></a>    <span class="kw">enum</span> <span class="kw">class</span> Color : <span class="dt">uint32_t</span> {</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true"></a>        RED    = <span class="bn">0b0001</span>,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true"></a>        YELLOW = <span class="bn">0b0010</span>,</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true"></a>        GREEN  = <span class="bn">0b0100</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true"></a>        BLUE   = <span class="bn">0b1000</span>,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true"></a>    };</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true"></a>    <span class="kw">constexpr</span> Color <span class="kw">operator</span>&amp;(Color x, Color y) <span class="kw">noexcept</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true"></a>    {</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true"></a>        <span class="cf">return</span> <span class="kw">static_cast</span>&lt;Color&gt;(<span class="kw">static_cast</span>&lt;<span class="dt">uint32_t</span>&gt;(x) &amp; <span class="kw">static_cast</span>&lt;<span class="dt">uint32_t</span>&gt;(y));</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true"></a>    }</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true"></a></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true"></a>    <span class="kw">constexpr</span> Color <span class="kw">operator</span>|(Color x, Color y) <span class="kw">noexcept</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true"></a>    {</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true"></a>        <span class="cf">return</span> <span class="kw">static_cast</span>&lt;Color&gt;(<span class="kw">static_cast</span>&lt;<span class="dt">uint32_t</span>&gt;(x) | <span class="kw">static_cast</span>&lt;<span class="dt">uint32_t</span>&gt;(y));</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true"></a>    }</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true"></a></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true"></a>    Color&amp; <span class="kw">operator</span>&amp;=(Color&amp; x, Color y) <span class="kw">noexcept</span> { <span class="cf">return</span> x = x &amp; y; }</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true"></a>    Color&amp; <span class="kw">operator</span>|=(Color&amp; x, Color y) <span class="kw">noexcept</span> { <span class="cf">return</span> x = x | y; }</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true"></a></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> IsTrue(Color x) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="kw">static_cast</span>&lt;<span class="dt">bool</span>&gt;(x); }</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true"></a></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true"></a>    <span class="bu">std::</span>string ColorMask2Str(Color color)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true"></a>    {</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true"></a>        <span class="kw">auto</span> ret = <span class="bu">std::</span>string{};</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true"></a></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true"></a>        <span class="cf">if</span> (IsTrue(Color::RED &amp; color)) {</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true"></a>            ret += <span class="st">&quot;RED&quot;</span>;</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true"></a>        }</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true"></a>        <span class="cf">if</span> (IsTrue(Color::YELLOW &amp; color)) {</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true"></a>            <span class="cf">if</span> (ret.size() != <span class="dv">0</span>) {</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true"></a>                ret += <span class="ch">&#39;,&#39;</span>;</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true"></a>            }</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true"></a>            ret += <span class="st">&quot;YELLOW&quot;</span>;</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true"></a>        }</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true"></a>        <span class="cf">if</span> (IsTrue(Color::GREEN &amp; color)) {</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true"></a>            <span class="cf">if</span> (ret.size() != <span class="dv">0</span>) {</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true"></a>                ret += <span class="ch">&#39;,&#39;</span>;</span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true"></a>            }</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true"></a>            ret += <span class="st">&quot;GREEN&quot;</span>;</span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true"></a>        }</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true"></a>        <span class="cf">if</span> (IsTrue(Color::BLUE &amp; color)) {</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true"></a>            <span class="cf">if</span> (ret.size() != <span class="dv">0</span>) {</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true"></a>                ret += <span class="ch">&#39;,&#39;</span>;</span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true"></a>            }</span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true"></a>            ret += <span class="st">&quot;BLUE&quot;</span>;</span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true"></a>        }</span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true"></a></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true"></a>    }</span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true"></a></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true"></a>    TEST(DesignPatternA, EnumBitmask)</span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true"></a>    {</span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;RED&quot;</span>, ColorMask2Str(Color::RED));</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;RED,YELLOW&quot;</span>, ColorMask2Str(Color::RED | Color::YELLOW));</span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;YELLOW&quot;</span>, ColorMask2Str(Color::YELLOW));</span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;YELLOW,GREEN,BLUE&quot;</span>, ColorMask2Str(Color::YELLOW | Color::GREEN | Color::BLUE));</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true"></a></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true"></a>        <span class="kw">auto</span> c = Color::GREEN;</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;GREEN&quot;</span>, ColorMask2Str(c));</span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true"></a></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true"></a>        c |= Color::RED;</span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;RED,GREEN&quot;</span>, ColorMask2Str(c));</span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true"></a></span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true"></a>        c &amp;= Color::RED;</span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;RED&quot;</span>, ColorMask2Str(c));</span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true"></a></span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true"></a>    <span class="pp">#if 0  </span><span class="co">// 間違った使い方はコンパイルさせない</span></span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true"></a><span class="co">        ASSERT_EQ(&quot;&quot;, ColorMask2Str(0b10000)); // 想定していない使用法</span></span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true"></a><span class="co">    </span><span class="pp">#endif</span></span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_2">演習-BitmaskType</a>へ戻る。</li>
</ul>
<h3 id="解答例-pimpl">解答例-Pimpl <a id="SS_20_9_3"></a></h3>
<div class="sourceCode" id="cb56"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/pimpl.cpp 5</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true"></a>    <span class="co">// [A] 下記クラスCollectionの宣言はクラスWidgetの宣言に依存している。</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true"></a>    <span class="co">// Pimplパターンを使用し、Collectionの宣言がWidgetの宣言に依存しないようにせよ。</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true"></a>    <span class="kw">class</span> Widget;</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true"></a>    <span class="kw">class</span> Collection {</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true"></a>        Collection();</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>* Name(<span class="dt">size_t</span> i) <span class="at">const</span>;</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true"></a>        <span class="dt">void</span>        AddName(<span class="dt">char</span> <span class="at">const</span>* name);</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true"></a>        <span class="dt">size_t</span>      Count() <span class="at">const</span> <span class="kw">noexcept</span>;</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true"></a>        <span class="kw">class</span> Pimpl;</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Pimpl&gt; <span class="va">pimpl_</span>{};</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true"></a>    };</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true"></a>    TEST(DesignPatternA, Pimpl)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true"></a>    {</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true"></a>        <span class="kw">auto</span> c = Collection{};</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true"></a></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, c.Count());</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true"></a>        ASSERT_THROW(c.Name(<span class="dv">0</span>), <span class="bu">std::</span>out_of_range);</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true"></a>        c.AddName(<span class="st">&quot;n0&quot;</span>);</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true"></a>        c.AddName(<span class="st">&quot;n1&quot;</span>);</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true"></a>        c.AddName(<span class="st">&quot;n2&quot;</span>);</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true"></a></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, c.Count());</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;n0&quot;</span>, c.Name(<span class="dv">0</span>));</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;n1&quot;</span>, c.Name(<span class="dv">1</span>));</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;n2&quot;</span>, c.Name(<span class="dv">2</span>));</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true"></a>        ASSERT_THROW(c.Name(<span class="dv">4</span>), <span class="bu">std::</span>out_of_range);</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true"></a>    }</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true"></a></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true"></a>    <span class="kw">class</span> Widget {</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true"></a>        <span class="kw">explicit</span> Widget(<span class="dt">char</span> <span class="at">const</span>* name) : <span class="va">name_</span>{name} {}</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>* Name() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name_</span>; }</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true"></a></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>* <span class="va">name_</span>;</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true"></a>    };</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true"></a></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true"></a>    <span class="kw">class</span> Collection::Pimpl {</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>* Name(<span class="dt">size_t</span> i) <span class="at">const</span> { <span class="cf">return</span> <span class="va">widgets_</span>.at(i).Name(); }</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true"></a>        <span class="dt">void</span>        AddName(<span class="dt">char</span> <span class="at">const</span>* name) { <span class="va">widgets_</span>.emplace_back(name); }</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true"></a></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true"></a>        <span class="dt">size_t</span> Count() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">widgets_</span>.size(); }</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true"></a></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;Widget&gt; <span class="va">widgets_</span>{};</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true"></a>    };</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true"></a></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true"></a>    Collection::Collection() : <span class="va">pimpl_</span>{<span class="bu">std::</span>make_unique&lt;Collection::Pimpl&gt;()} {}</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true"></a>    <span class="dt">char</span> <span class="at">const</span>* Collection::Name(<span class="dt">size_t</span> i) <span class="at">const</span> { <span class="cf">return</span> <span class="va">pimpl_</span>-&gt;Name(i); }</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true"></a>    <span class="dt">void</span>        Collection::AddName(<span class="dt">char</span> <span class="at">const</span>* name) { <span class="va">pimpl_</span>-&gt;AddName(name); }</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true"></a>    <span class="dt">size_t</span>      Collection::Count() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">pimpl_</span>-&gt;Count(); }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_3">演習-Pimpl</a>へ戻る。</li>
</ul>
<h3 id="解答-accessorの副作用">解答-Accessorの副作用 <a id="SS_20_9_4"></a></h3>
<ul>
<li>選択肢1</li>
<li>参照 <a href="design_pattern.html#SS_9_4">Accessor</a></li>
<li><a href="exercise_q.html#SS_19_9_4">演習-Accessorの副作用</a>へ戻る。</li>
</ul>
<h3 id="解答例-accessor">解答例-Accessor <a id="SS_20_9_5"></a></h3>
<div class="sourceCode" id="cb57"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/accessor.cpp 5</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true"></a>    <span class="co">// 下記クラスPrimeNumbersはAccessorの多用により、クラスのカプセル化が破壊されている例である。</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true"></a>    <span class="co">// これにより、このクラスは凝集性が低く、誤用を誘発しやすい。</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true"></a>    <span class="co">// この問題を解決するため、クラスPrimeNumbersや関数GetPrimeNumbersを修正せよ。</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true"></a>    <span class="co">// また、別の問題があれば合わせて修正せよ。</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true"></a>    <span class="co">// * Accessorについて</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true"></a>    <span class="co">//      * HasCache、Cashedを廃止。</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true"></a>    <span class="co">//        値(この場合は素数列prime_numbers_)をキャッシュしているかどうかの判断は、</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true"></a>    <span class="co">//        クラスに考えさせるべき。</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true"></a>    <span class="co">//      * SetMaxNumberの変更。</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true"></a>    <span class="co">//        SetMaxNumberで素数列を作っても良いが、一般に重い計算はなるべく遅延実行させた方が良い。</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true"></a>    <span class="co">// * その他の変更について</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true"></a>    <span class="co">//      * GetPrimeNumbersのGeneratePrimeNumbersへの名前変更。</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true"></a>    <span class="co">//        GetXXXはconstメンバ関数にすべきなので。</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true"></a>    <span class="co">//      * コンストラクタやcopy代入演算子等の自動生成関数は、何らかの定義・宣言をした方が良い。</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true"></a>    <span class="co">//      * メンバ変数は必ず初期化する。</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true"></a></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true"></a>    <span class="kw">class</span> PrimeNumbers {</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true"></a>        PrimeNumbers() = <span class="cf">default</span>;</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true"></a></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true"></a>        PrimeNumbers(PrimeNumbers <span class="at">const</span>&amp;)            = <span class="cf">default</span>;</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true"></a>        PrimeNumbers&amp; <span class="kw">operator</span>=(PrimeNumbers <span class="at">const</span>&amp;) = <span class="cf">default</span>;</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true"></a></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true"></a>        <span class="dt">uint32_t</span> GetMaxNumber() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">max_number_</span>; }</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true"></a>        <span class="dt">void</span>     SetMaxNumber(<span class="dt">uint32_t</span> max_number) <span class="kw">noexcept</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true"></a>        {</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true"></a>            <span class="cf">if</span> (max_number != <span class="va">max_number_</span>) {</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true"></a>                <span class="va">cached_</span>     = <span class="kw">false</span>;</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true"></a>                <span class="va">max_number_</span> = max_number;</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true"></a>            }</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true"></a>        }</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true"></a></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; <span class="at">const</span>&amp; GeneratePrimeNumbers();</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true"></a></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true"></a>        <span class="dt">uint32_t</span>              <span class="va">max_number_</span>{<span class="dv">0</span>};</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true"></a>        <span class="dt">bool</span>                  <span class="va">cached_</span>{<span class="kw">false</span>};</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; <span class="va">prime_numbers_</span>{};</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true"></a></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true"></a>        <span class="at">static</span> <span class="dt">uint32_t</span>              next_prime_num(<span class="dt">uint32_t</span>           curr_prime_num,</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true"></a>                                                    <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;&amp; is_num_prime) <span class="kw">noexcept</span>;</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; get_prime_numbers(<span class="dt">uint32_t</span> max_number);</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true"></a>    };</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true"></a></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true"></a>    <span class="dt">uint32_t</span> PrimeNumbers::next_prime_num(<span class="dt">uint32_t</span>           curr_prime_num,</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true"></a>                                          <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;&amp; is_num_prime) <span class="kw">noexcept</span></span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true"></a>    {</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i = <span class="dv">2</span> * curr_prime_num; i &lt; is_num_prime.size(); i += curr_prime_num) {</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true"></a>            is_num_prime[i] = <span class="kw">false</span>;  <span class="co">// 次の倍数は素数ではない</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true"></a>        }</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true"></a></span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num = curr_prime_num;</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true"></a></span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true"></a>        <span class="cf">do</span> {  <span class="co">// 次の素数の探索</span></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true"></a>            ++prime_num;</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true"></a>        } <span class="cf">while</span> (!is_num_prime[prime_num] &amp;&amp; (prime_num &lt; is_num_prime.size()));</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true"></a></span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true"></a>        <span class="cf">return</span> prime_num;</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true"></a>    }</span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true"></a></span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true"></a>    <span class="kw">inline</span> <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; PrimeNumbers::get_prime_numbers(<span class="dt">uint32_t</span> max_number)</span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true"></a>    {</span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true"></a>        <span class="kw">auto</span> result       = <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{};</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num    = <span class="dv">2</span><span class="bu">U</span>;                                       <span class="co">// 最初の素数</span></span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true"></a>        <span class="kw">auto</span> is_num_prime = <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;(max_number + <span class="dv">1</span>, <span class="kw">true</span>);  <span class="co">// falseなら素数でない。</span></span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true"></a>        is_num_prime[<span class="dv">0</span>] = is_num_prime[<span class="dv">1</span>] = <span class="kw">false</span>;</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true"></a></span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true"></a>        <span class="cf">do</span> {</span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true"></a>            result.emplace_back(prime_num);</span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true"></a>            prime_num = next_prime_num(prime_num, is_num_prime);</span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true"></a>        } <span class="cf">while</span> (prime_num &lt; is_num_prime.size());</span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true"></a></span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true"></a>        <span class="cf">return</span> result;</span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true"></a>    }</span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true"></a></span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true"></a>    <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; <span class="at">const</span>&amp; PrimeNumbers::GeneratePrimeNumbers()</span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true"></a>    {</span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true"></a>        <span class="cf">if</span> (<span class="va">cached_</span>) {</span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">prime_numbers_</span>;</span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true"></a>        }</span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true"></a></span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true"></a>        <span class="cf">if</span> (<span class="va">max_number_</span> &lt; <span class="dv">2</span>) {  <span class="co">// ガード節。2未満の素数はない。</span></span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true"></a>            <span class="va">prime_numbers_</span>.clear();</span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true"></a>        }</span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true"></a>        <span class="cf">else</span> {</span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true"></a>            <span class="va">prime_numbers_</span> = get_prime_numbers(<span class="va">max_number_</span>);</span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true"></a>        }</span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true"></a></span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true"></a>        <span class="va">cached_</span> = <span class="kw">true</span>;</span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true"></a></span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">prime_numbers_</span>;</span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true"></a>    }</span>
<span id="cb57-97"><a href="#cb57-97" aria-hidden="true"></a></span>
<span id="cb57-98"><a href="#cb57-98" aria-hidden="true"></a>    TEST(DesignPatternA, Accessor)</span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true"></a>    {</span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true"></a>        <span class="kw">auto</span> pm = PrimeNumbers{};</span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true"></a></span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true"></a>        pm.SetMaxNumber(<span class="dv">1</span>);</span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{}), pm.GeneratePrimeNumbers());</span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true"></a></span>
<span id="cb57-105"><a href="#cb57-105" aria-hidden="true"></a>        pm.SetMaxNumber(<span class="dv">3</span>);</span>
<span id="cb57-106"><a href="#cb57-106" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>}), pm.GeneratePrimeNumbers());</span>
<span id="cb57-107"><a href="#cb57-107" aria-hidden="true"></a></span>
<span id="cb57-108"><a href="#cb57-108" aria-hidden="true"></a>        pm.SetMaxNumber(<span class="dv">30</span>);</span>
<span id="cb57-109"><a href="#cb57-109" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">29</span>}),</span>
<span id="cb57-110"><a href="#cb57-110" aria-hidden="true"></a>                  pm.GeneratePrimeNumbers());</span>
<span id="cb57-111"><a href="#cb57-111" aria-hidden="true"></a></span>
<span id="cb57-112"><a href="#cb57-112" aria-hidden="true"></a>    <span class="pp">#if 0  </span><span class="co">// このテストパターンは廃止した</span></span>
<span id="cb57-113"><a href="#cb57-113" aria-hidden="true"></a><span class="co">        pm.SetMaxNumber(3);</span></span>
<span id="cb57-114"><a href="#cb57-114" aria-hidden="true"></a><span class="co">        GeneratePrimeNumbers(pm);  // pm.Cashed(false);しないので前のまま。</span></span>
<span id="cb57-115"><a href="#cb57-115" aria-hidden="true"></a><span class="co">                                   // このような用途は考えづらいので、おそらく仕様のバグ。</span></span>
<span id="cb57-116"><a href="#cb57-116" aria-hidden="true"></a></span>
<span id="cb57-117"><a href="#cb57-117" aria-hidden="true"></a><span class="co">        ASSERT_EQ((std::vector&lt;uint32_t&gt;{2, 3, 5, 7, 11, 13, 17, 19, 23, 29}), pm.GeneratePrimeNumbers());</span></span>
<span id="cb57-118"><a href="#cb57-118" aria-hidden="true"></a><span class="co">    </span><span class="pp">#else</span></span>
<span id="cb57-119"><a href="#cb57-119" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">29</span>}),</span>
<span id="cb57-120"><a href="#cb57-120" aria-hidden="true"></a>                  pm.GeneratePrimeNumbers());</span>
<span id="cb57-121"><a href="#cb57-121" aria-hidden="true"></a>    <span class="pp">#endif</span></span>
<span id="cb57-122"><a href="#cb57-122" aria-hidden="true"></a></span>
<span id="cb57-123"><a href="#cb57-123" aria-hidden="true"></a>        pm.SetMaxNumber(<span class="dv">3</span>);</span>
<span id="cb57-124"><a href="#cb57-124" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>}), pm.GeneratePrimeNumbers());</span>
<span id="cb57-125"><a href="#cb57-125" aria-hidden="true"></a></span>
<span id="cb57-126"><a href="#cb57-126" aria-hidden="true"></a>        <span class="kw">auto</span> pm3_copy = PrimeNumbers{pm};</span>
<span id="cb57-127"><a href="#cb57-127" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>}), pm3_copy.GeneratePrimeNumbers());</span>
<span id="cb57-128"><a href="#cb57-128" aria-hidden="true"></a></span>
<span id="cb57-129"><a href="#cb57-129" aria-hidden="true"></a>        <span class="kw">auto</span> pm5 = PrimeNumbers{};</span>
<span id="cb57-130"><a href="#cb57-130" aria-hidden="true"></a>        pm5.SetMaxNumber(<span class="dv">5</span>);</span>
<span id="cb57-131"><a href="#cb57-131" aria-hidden="true"></a>        pm = pm5;</span>
<span id="cb57-132"><a href="#cb57-132" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>}), pm.GeneratePrimeNumbers());</span>
<span id="cb57-133"><a href="#cb57-133" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_5">演習-Accessor</a>へ戻る。</li>
</ul>
<h3 id="解答例-copy-and-swap">解答例-Copy-And-Swap <a id="SS_20_9_6"></a></h3>
<div class="sourceCode" id="cb58"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/copy_and_swap.cpp 5</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true"></a>    <span class="co">// 以下のクラスCopyAndSwapの</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true"></a>    <span class="co">//  * copyコンストラクタ</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true"></a>    <span class="co">//  * copy代入演算子</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true"></a>    <span class="co">//  * moveコンストラクタ</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true"></a>    <span class="co">//  * move代入演算子</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true"></a>    <span class="co">// をCopy-And-Swapイデオムを使用して実装し、単体テストを行え。</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true"></a>    <span class="kw">class</span> CopyAndSwap <span class="kw">final</span> {</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true"></a>        <span class="kw">explicit</span> CopyAndSwap(<span class="dt">char</span> <span class="at">const</span>* name0, <span class="dt">char</span> <span class="at">const</span>* name1)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true"></a>            : <span class="va">name0_</span>{name0 == <span class="kw">nullptr</span> ? <span class="st">&quot;&quot;</span> : name0}, <span class="va">name1_</span>{name1 == <span class="kw">nullptr</span> ? <span class="st">&quot;&quot;</span> : name1}</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true"></a>        {</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true"></a>        }</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true"></a>        CopyAndSwap(CopyAndSwap <span class="at">const</span>&amp; rhs) : <span class="va">name0_</span>{rhs.<span class="va">name0_</span>}, <span class="va">name1_</span>{rhs.<span class="va">name1_</span>} {}</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true"></a></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true"></a>        CopyAndSwap(CopyAndSwap&amp;&amp; rhs) <span class="kw">noexcept</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true"></a>            : <span class="va">name0_</span>{<span class="bu">std::</span>exchange(rhs.<span class="va">name0_</span>, <span class="kw">nullptr</span>)}, <span class="va">name1_</span>{<span class="bu">std::</span>move(rhs.<span class="va">name1_</span>)}</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true"></a>        {</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true"></a>        }</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true"></a></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true"></a>        CopyAndSwap&amp; <span class="kw">operator</span>=(CopyAndSwap <span class="at">const</span>&amp; rhs)</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true"></a>        {</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="kw">this</span> == &amp;rhs) {</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true"></a>                <span class="cf">return</span> *<span class="kw">this</span>;</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true"></a>            }</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true"></a></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true"></a>            <span class="co">// copyコンストラクタの使用</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true"></a>            <span class="kw">auto</span> tmp = CopyAndSwap{rhs};  <span class="co">// ここでエクセプションが発生しても、tmp以外、壊れない</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true"></a></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true"></a>            Swap(tmp);</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true"></a></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true"></a>            <span class="cf">return</span> *<span class="kw">this</span>;</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true"></a>        }</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true"></a></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true"></a>        CopyAndSwap&amp; <span class="kw">operator</span>=(CopyAndSwap&amp;&amp; rhs) <span class="kw">noexcept</span></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true"></a>        {</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="kw">this</span> == &amp;rhs) {</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true"></a>                <span class="cf">return</span> *<span class="kw">this</span>;</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true"></a>            }</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true"></a></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true"></a>            <span class="kw">auto</span> tmp = CopyAndSwap{<span class="bu">std::</span>move(rhs)};  <span class="co">// moveコンストラクタ</span></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true"></a></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true"></a>            Swap(tmp);</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true"></a></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true"></a>            <span class="cf">return</span> *<span class="kw">this</span>;</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true"></a>        }</span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true"></a></span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true"></a>        <span class="dt">void</span> Swap(CopyAndSwap&amp; rhs) <span class="kw">noexcept</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true"></a>        {</span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true"></a>            <span class="bu">std::</span>swap(<span class="va">name0_</span>, rhs.<span class="va">name0_</span>);</span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true"></a>            <span class="bu">std::</span>swap(<span class="va">name1_</span>, rhs.<span class="va">name1_</span>);</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true"></a>        }</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true"></a></span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>* GetName0() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name0_</span>; }</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true"></a></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName1() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name1_</span>; }</span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true"></a></span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true"></a>        ~CopyAndSwap() = <span class="cf">default</span>;</span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true"></a></span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true"></a>        <span class="dt">char</span> <span class="at">const</span>* <span class="va">name0_</span>;</span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name1_</span>;</span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true"></a>    };</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true"></a></span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true"></a>    <span class="pp">#if defined(__clang__)  </span><span class="co">// clangコンパイルでの警告抑止</span></span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_BEGIN </span><span class="ot">_Pragma</span>(<span class="st">&quot;clang diagnostic push&quot;</span>)</span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_SELF_ASSIGN_OVERLOADED </span>\</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true"></a><span class="pp">        </span><span class="ot">_Pragma</span>(<span class="st">&quot;clang diagnostic ignored </span><span class="sc">\&quot;</span><span class="st">-Wself-assign-overloaded</span><span class="sc">\&quot;</span><span class="st">&quot;</span>)</span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_SELF_MOVE </span><span class="ot">_Pragma</span>(<span class="st">&quot;clang diagnostic ignored </span><span class="sc">\&quot;</span><span class="st">-Wself-move</span><span class="sc">\&quot;</span><span class="st">&quot;</span>)</span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_END </span><span class="ot">_Pragma</span>(<span class="st">&quot;clang diagnostic pop&quot;</span>)</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true"></a>    <span class="pp">#else</span></span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_BEGIN</span></span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_SELF_ASSIGN_OVERLOADED</span></span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_SELF_MOVE</span></span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true"></a>    <span class="pp">#define SUPPRESS_WARN_CLANG_END</span></span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true"></a>    <span class="pp">#endif</span></span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true"></a></span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true"></a>    <span class="co">// 本来は下記単体テストは分割すべきだが、紙面の都合上一つにまとめる。</span></span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true"></a>    TEST(DesignPatternA, CopyAndSwap)</span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true"></a>    {</span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true"></a>        <span class="co">// test for explicit CopyAndSwap(char const* name0, char const* name1)</span></span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true"></a>        <span class="kw">auto</span> n = CopyAndSwap{<span class="kw">nullptr</span>, <span class="kw">nullptr</span>};</span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;&quot;</span>, n.GetName0());</span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;&quot;</span>, n.GetName1());</span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true"></a></span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true"></a>        <span class="kw">auto</span> a = CopyAndSwap{<span class="st">&quot;a0&quot;</span>, <span class="st">&quot;a1&quot;</span>};</span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;a0&quot;</span>, a.GetName0());</span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;a1&quot;</span>, a.GetName1());</span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true"></a></span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true"></a>        <span class="co">// test for void Swap(CopyAndSwap&amp; rhs) noexcept</span></span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true"></a>        <span class="kw">auto</span> b = CopyAndSwap{<span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b1&quot;</span>};</span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true"></a></span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true"></a>        a.Swap(b);</span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;b0&quot;</span>, a.GetName0());</span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;b1&quot;</span>, a.GetName1());</span>
<span id="cb58-99"><a href="#cb58-99" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;a0&quot;</span>, b.GetName0());</span>
<span id="cb58-100"><a href="#cb58-100" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;a1&quot;</span>, b.GetName1());</span>
<span id="cb58-101"><a href="#cb58-101" aria-hidden="true"></a></span>
<span id="cb58-102"><a href="#cb58-102" aria-hidden="true"></a>        a.Swap(a);</span>
<span id="cb58-103"><a href="#cb58-103" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;b0&quot;</span>, a.GetName0());</span>
<span id="cb58-104"><a href="#cb58-104" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;b1&quot;</span>, a.GetName1());</span>
<span id="cb58-105"><a href="#cb58-105" aria-hidden="true"></a></span>
<span id="cb58-106"><a href="#cb58-106" aria-hidden="true"></a>        <span class="co">// test for CopyAndSwap(CopyAndSwap const&amp; rhs)</span></span>
<span id="cb58-107"><a href="#cb58-107" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> const_a = CopyAndSwap{<span class="st">&quot;const_a0&quot;</span>, <span class="st">&quot;const_a1&quot;</span>};</span>
<span id="cb58-108"><a href="#cb58-108" aria-hidden="true"></a></span>
<span id="cb58-109"><a href="#cb58-109" aria-hidden="true"></a>        <span class="kw">auto</span> b_copy = CopyAndSwap{const_a};</span>
<span id="cb58-110"><a href="#cb58-110" aria-hidden="true"></a></span>
<span id="cb58-111"><a href="#cb58-111" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;const_a0&quot;</span>, b_copy.GetName0());</span>
<span id="cb58-112"><a href="#cb58-112" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;const_a1&quot;</span>, b_copy.GetName1());</span>
<span id="cb58-113"><a href="#cb58-113" aria-hidden="true"></a></span>
<span id="cb58-114"><a href="#cb58-114" aria-hidden="true"></a>        <span class="co">// test for CopyAndSwap&amp; operator=(CopyAndSwap const&amp; rhs)</span></span>
<span id="cb58-115"><a href="#cb58-115" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> c = CopyAndSwap{<span class="st">&quot;c0&quot;</span>, <span class="st">&quot;c1&quot;</span>};</span>
<span id="cb58-116"><a href="#cb58-116" aria-hidden="true"></a></span>
<span id="cb58-117"><a href="#cb58-117" aria-hidden="true"></a>        b_copy = c;</span>
<span id="cb58-118"><a href="#cb58-118" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;c0&quot;</span>, b_copy.GetName0());</span>
<span id="cb58-119"><a href="#cb58-119" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;c1&quot;</span>, b_copy.GetName1());</span>
<span id="cb58-120"><a href="#cb58-120" aria-hidden="true"></a></span>
<span id="cb58-121"><a href="#cb58-121" aria-hidden="true"></a>        SUPPRESS_WARN_CLANG_BEGIN;</span>
<span id="cb58-122"><a href="#cb58-122" aria-hidden="true"></a>        SUPPRESS_WARN_CLANG_SELF_ASSIGN_OVERLOADED;</span>
<span id="cb58-123"><a href="#cb58-123" aria-hidden="true"></a></span>
<span id="cb58-124"><a href="#cb58-124" aria-hidden="true"></a>        b_copy = b_copy;</span>
<span id="cb58-125"><a href="#cb58-125" aria-hidden="true"></a></span>
<span id="cb58-126"><a href="#cb58-126" aria-hidden="true"></a>        SUPPRESS_WARN_CLANG_END;</span>
<span id="cb58-127"><a href="#cb58-127" aria-hidden="true"></a></span>
<span id="cb58-128"><a href="#cb58-128" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;c0&quot;</span>, b_copy.GetName0());</span>
<span id="cb58-129"><a href="#cb58-129" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;c1&quot;</span>, b_copy.GetName1());</span>
<span id="cb58-130"><a href="#cb58-130" aria-hidden="true"></a></span>
<span id="cb58-131"><a href="#cb58-131" aria-hidden="true"></a>        <span class="co">// test for CopyAndSwap(CopyAndSwap&amp;&amp; rhs) noexcept</span></span>
<span id="cb58-132"><a href="#cb58-132" aria-hidden="true"></a>        <span class="kw">auto</span> b_move = CopyAndSwap{<span class="bu">std::</span>move(b)};</span>
<span id="cb58-133"><a href="#cb58-133" aria-hidden="true"></a></span>
<span id="cb58-134"><a href="#cb58-134" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;a0&quot;</span>, b_move.GetName0());</span>
<span id="cb58-135"><a href="#cb58-135" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;a1&quot;</span>, b_move.GetName1());</span>
<span id="cb58-136"><a href="#cb58-136" aria-hidden="true"></a></span>
<span id="cb58-137"><a href="#cb58-137" aria-hidden="true"></a>    <span class="pp">#if !defined(__clang_analyzer__)  </span><span class="co">// move後のオブジェクトにリードアクセスするとscan-buildでエラー</span></span>
<span id="cb58-138"><a href="#cb58-138" aria-hidden="true"></a>        ASSERT_EQ(<span class="kw">nullptr</span>, b.GetName0());</span>
<span id="cb58-139"><a href="#cb58-139" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;&quot;</span>, b.GetName1());</span>
<span id="cb58-140"><a href="#cb58-140" aria-hidden="true"></a>    <span class="pp">#endif</span></span>
<span id="cb58-141"><a href="#cb58-141" aria-hidden="true"></a></span>
<span id="cb58-142"><a href="#cb58-142" aria-hidden="true"></a>        <span class="kw">auto</span> c_move = CopyAndSwap{<span class="bu">std::</span>move(const_a)};  <span class="co">// moveに見えるが実はコピー</span></span>
<span id="cb58-143"><a href="#cb58-143" aria-hidden="true"></a></span>
<span id="cb58-144"><a href="#cb58-144" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;const_a0&quot;</span>, const_a.GetName0());</span>
<span id="cb58-145"><a href="#cb58-145" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;const_a1&quot;</span>, const_a.GetName1());</span>
<span id="cb58-146"><a href="#cb58-146" aria-hidden="true"></a></span>
<span id="cb58-147"><a href="#cb58-147" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;const_a0&quot;</span>, c_move.GetName0());</span>
<span id="cb58-148"><a href="#cb58-148" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;const_a1&quot;</span>, c_move.GetName1());</span>
<span id="cb58-149"><a href="#cb58-149" aria-hidden="true"></a></span>
<span id="cb58-150"><a href="#cb58-150" aria-hidden="true"></a>        <span class="co">// test for CopyAndSwap&amp; operator=(CopyAndSwap&amp;&amp; rhs) noexcept</span></span>
<span id="cb58-151"><a href="#cb58-151" aria-hidden="true"></a>        c_move = <span class="bu">std::</span>move(b_move);</span>
<span id="cb58-152"><a href="#cb58-152" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;a0&quot;</span>, c_move.GetName0());</span>
<span id="cb58-153"><a href="#cb58-153" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;a1&quot;</span>, c_move.GetName1());</span>
<span id="cb58-154"><a href="#cb58-154" aria-hidden="true"></a></span>
<span id="cb58-155"><a href="#cb58-155" aria-hidden="true"></a>    <span class="pp">#if !defined(__clang_analyzer__)  </span><span class="co">// move後のオブジェクトにリードアクセスするとscan-buildでエラー</span></span>
<span id="cb58-156"><a href="#cb58-156" aria-hidden="true"></a>        ASSERT_EQ(<span class="kw">nullptr</span>, b_move.GetName0());</span>
<span id="cb58-157"><a href="#cb58-157" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;&quot;</span>, b_move.GetName1());</span>
<span id="cb58-158"><a href="#cb58-158" aria-hidden="true"></a>    <span class="pp">#endif</span></span>
<span id="cb58-159"><a href="#cb58-159" aria-hidden="true"></a></span>
<span id="cb58-160"><a href="#cb58-160" aria-hidden="true"></a>        SUPPRESS_WARN_CLANG_BEGIN;</span>
<span id="cb58-161"><a href="#cb58-161" aria-hidden="true"></a>        SUPPRESS_WARN_CLANG_SELF_MOVE;</span>
<span id="cb58-162"><a href="#cb58-162" aria-hidden="true"></a></span>
<span id="cb58-163"><a href="#cb58-163" aria-hidden="true"></a>        c_move = <span class="bu">std::</span>move(c_move);</span>
<span id="cb58-164"><a href="#cb58-164" aria-hidden="true"></a></span>
<span id="cb58-165"><a href="#cb58-165" aria-hidden="true"></a>        SUPPRESS_WARN_CLANG_END;</span>
<span id="cb58-166"><a href="#cb58-166" aria-hidden="true"></a></span>
<span id="cb58-167"><a href="#cb58-167" aria-hidden="true"></a>        ASSERT_STREQ(<span class="st">&quot;a0&quot;</span>, c_move.GetName0());</span>
<span id="cb58-168"><a href="#cb58-168" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;a1&quot;</span>, c_move.GetName1());</span>
<span id="cb58-169"><a href="#cb58-169" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_6">演習-Copy-And-Swap</a>へ戻る。</li>
</ul>
<h3 id="解答例-immutable">解答例-Immutable <a id="SS_20_9_7"></a></h3>
<div class="sourceCode" id="cb59"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/immutable.cpp 5</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true"></a>    <span class="co">// 下記クラスPrimeNumbersはSetMaxNumberにより状態が変わってしまうことがある。</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true"></a>    <span class="co">// 状態変更が必要ない場合、こういった仕様はない方が良い。</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true"></a>    <span class="co">// PrimeNumbersからSetMaxNumberを削除し、このクラスをimmutableにせよ。</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true"></a>    <span class="co">// * Immutableなクラスとは、生成後状態が変えられないクラスである。</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true"></a>    <span class="co">// * PrimeNumbersをImmutableにするには</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true"></a>    <span class="co">//      * SetMaxNumberを廃止し、メンバ変数をconstにする。</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true"></a>    <span class="co">//      * GeneratePrimeNumbersをconstメンバ関数にして、GetPrimeNumbersに変更する。</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true"></a>    <span class="co">//      * copy代入演算子を =deleteする(これがなくてもconstメンバならばコピーはできないが)</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true"></a></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true"></a>    <span class="kw">class</span> PrimeNumbers {</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true"></a>        <span class="kw">explicit</span> PrimeNumbers(<span class="dt">uint32_t</span> max_number = <span class="dv">2</span>);</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true"></a></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true"></a>        PrimeNumbers(PrimeNumbers <span class="at">const</span>&amp;)            = <span class="cf">default</span>;</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true"></a>        PrimeNumbers&amp; <span class="kw">operator</span>=(PrimeNumbers <span class="at">const</span>&amp;) = <span class="kw">delete</span>;  <span class="co">// constメンバはコピーできない。</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true"></a></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true"></a>        <span class="dt">uint32_t</span>                     GetMaxNumber() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">max_number_</span>; }</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; <span class="at">const</span>&amp; GetPrimeNumbers() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">prime_numbers_</span>; }</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true"></a></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true"></a>        <span class="dt">uint32_t</span> <span class="at">const</span>              <span class="va">max_number_</span>;</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; <span class="at">const</span> <span class="va">prime_numbers_</span>{};</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true"></a>        <span class="at">static</span> <span class="dt">uint32_t</span>              next_prime_num(<span class="dt">uint32_t</span>           curr_prime_num,</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true"></a>                                                    <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;&amp; is_num_prime) <span class="kw">noexcept</span>;</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; get_prime_numbers(<span class="dt">uint32_t</span> max_number);</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true"></a>    };</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true"></a></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true"></a>    <span class="dt">uint32_t</span> PrimeNumbers::next_prime_num(<span class="dt">uint32_t</span>           curr_prime_num,</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true"></a>                                          <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;&amp; is_num_prime) <span class="kw">noexcept</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true"></a>    {</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i = <span class="dv">2</span> * curr_prime_num; i &lt; is_num_prime.size(); i += curr_prime_num) {</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true"></a>            is_num_prime[i] = <span class="kw">false</span>;  <span class="co">// 次の倍数は素数ではない</span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true"></a>        }</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true"></a></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num = curr_prime_num;</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true"></a></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true"></a>        <span class="cf">do</span> {  <span class="co">// 次の素数の探索</span></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true"></a>            ++prime_num;</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true"></a>        } <span class="cf">while</span> (!is_num_prime[prime_num] &amp;&amp; (prime_num &lt; is_num_prime.size()));</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true"></a></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true"></a>        <span class="cf">return</span> prime_num;</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true"></a>    }</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true"></a></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true"></a>    <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt; PrimeNumbers::get_prime_numbers(<span class="dt">uint32_t</span> max_number)</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true"></a>    {</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true"></a>        <span class="kw">auto</span> result = <span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{};</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true"></a></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true"></a>        <span class="cf">if</span> (max_number &lt; <span class="dv">2</span>) {  <span class="co">// ガード節。2未満の素数はない。</span></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true"></a>            <span class="cf">return</span> result;</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true"></a>        }</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true"></a></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true"></a>        <span class="kw">auto</span> prime_num    = <span class="dv">2</span><span class="bu">U</span>;                                       <span class="co">// 最初の素数</span></span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true"></a>        <span class="kw">auto</span> is_num_prime = <span class="bu">std::</span>vector&lt;<span class="dt">bool</span>&gt;(max_number + <span class="dv">1</span>, <span class="kw">true</span>);  <span class="co">// falseなら素数でない。</span></span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true"></a>        is_num_prime[<span class="dv">0</span>] = is_num_prime[<span class="dv">1</span>] = <span class="kw">false</span>;</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true"></a></span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true"></a>        <span class="cf">do</span> {</span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true"></a>            result.emplace_back(prime_num);</span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true"></a>            prime_num = next_prime_num(prime_num, is_num_prime);</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true"></a>        } <span class="cf">while</span> (prime_num &lt; is_num_prime.size());</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true"></a></span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true"></a>        <span class="cf">return</span> result;</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true"></a>    }</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true"></a></span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true"></a>    PrimeNumbers::PrimeNumbers(<span class="dt">uint32_t</span> max_number)</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true"></a>        : <span class="va">max_number_</span>{max_number}, <span class="va">prime_numbers_</span>{get_prime_numbers(max_number)}</span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true"></a>    {</span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true"></a>    }</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true"></a></span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true"></a>    TEST(DesignPatternA, Immutable)</span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true"></a>    {</span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true"></a>        <span class="kw">auto</span> pm1 = PrimeNumbers{<span class="dv">1</span>};</span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{}), pm1.GetPrimeNumbers());</span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true"></a></span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true"></a>        <span class="kw">auto</span> pm3 = PrimeNumbers{<span class="dv">3</span>};</span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>}), pm3.GetPrimeNumbers());</span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true"></a></span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true"></a>        <span class="kw">auto</span> pm30 = PrimeNumbers{<span class="dv">30</span>};</span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">29</span>}), pm30.GetPrimeNumbers());</span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true"></a></span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">29</span>}), pm30.GetPrimeNumbers());</span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true"></a></span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true"></a>        <span class="kw">auto</span> pm3_copy = PrimeNumbers{pm3};</span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">uint32_t</span>&gt;{<span class="dv">2</span>, <span class="dv">3</span>}), pm3_copy.GetPrimeNumbers());</span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true"></a></span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true"></a>    <span class="pp">#if 0  </span><span class="co">// immutableなのでコピーはできない。</span></span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true"></a><span class="co">        auto pm  = PrimeNumbers{1};</span></span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true"></a><span class="co">        auto pm5 = PrimeNumbers{5};</span></span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true"></a><span class="co">        pm       = pm5;</span></span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true"></a><span class="co">        ASSERT_EQ((std::vector&lt;uint32_t&gt;{2, 3, 5}), pm.GetPrimeNumbers());</span></span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true"></a><span class="co">    </span><span class="pp">#endif</span></span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_7">演習-Immutable</a>へ戻る。</li>
</ul>
<h3 id="解答例-clone">解答例-Clone <a id="SS_20_9_8"></a></h3>
<div class="sourceCode" id="cb60"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/clone.cpp 7</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true"></a>    <span class="co">// </span><span class="al">TEST</span><span class="co">(DesignPatternQ, Clone)に記述したように、オブジェクトのスライシングによる影響で、</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true"></a>    <span class="co">// Base型ポインタに代入されたDerivedインスタンスへのコピーは部分的にしか行われない。</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true"></a>    <span class="co">// Cloneパターンを使用してこの問題を修正せよ。</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true"></a>    <span class="co">// また、その他の問題があれば合わせて修正せよ。</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true"></a>    <span class="kw">class</span> Base {</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true"></a>        <span class="kw">explicit</span> Base(<span class="bu">std::</span>string name) : <span class="va">name1_</span>{<span class="bu">std::</span>move(name)} {}</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Base() = <span class="cf">default</span>;</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name1_</span>; }</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>unique_ptr&lt;Base&gt; Clone() <span class="at">const</span> { <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;Base&gt;(<span class="va">name1_</span>); }</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true"></a>        Base(Base <span class="at">const</span>&amp;)            = <span class="kw">delete</span>;</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true"></a>        Base&amp; <span class="kw">operator</span>=(Base <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name1_</span>;</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true"></a>    };</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true"></a></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true"></a>    <span class="kw">class</span> Derived <span class="kw">final</span> : <span class="kw">public</span> Base {</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true"></a>        <span class="kw">explicit</span> Derived(<span class="bu">std::</span>string name1 = <span class="st">&quot;&quot;</span>, <span class="bu">std::</span>string name2 = <span class="st">&quot;&quot;</span>)</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true"></a>            : Base{<span class="bu">std::</span>move(name1)}, <span class="va">name2_</span>{<span class="bu">std::</span>move(name2)}</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true"></a>        {</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true"></a>        }</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Derived() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName() <span class="at">const</span> <span class="kw">noexcept</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="va">name2_</span>; }</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true"></a></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>unique_ptr&lt;Base&gt; Clone() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> CloneOwn(); }</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true"></a></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Derived&gt; CloneOwn() <span class="at">const</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true"></a>        {</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;Derived&gt;(Base::GetName(), <span class="va">name2_</span>);</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true"></a>        }</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true"></a></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name2_</span>;</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true"></a>    };</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true"></a></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true"></a>    TEST(DesignPatternA, Clone)</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true"></a>    {</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true"></a>        Derived d1{<span class="st">&quot;name1&quot;</span>, <span class="st">&quot;name2&quot;</span>};</span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true"></a></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name1&quot;</span>, d1.Base::GetName());</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name2&quot;</span>, d1.GetName());</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true"></a></span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Derived&gt; d2 = d1.CloneOwn();</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name1&quot;</span>, d2-&gt;Base::GetName());</span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name2&quot;</span>, d2-&gt;GetName());</span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true"></a></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Base&gt; b3 = d1.Clone();  <span class="co">// コピーの代わりにクローン</span></span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true"></a></span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name1&quot;</span>, b3-&gt;Base::GetName());</span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name2&quot;</span>, b3-&gt;GetName());  <span class="co">// ちゃんとコピーされた。</span></span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_8">演習-Clone</a>へ戻る。</li>
</ul>
<h3 id="解答例-nvi">解答例-NVI <a id="SS_20_9_9"></a></h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/nvi.cpp 7</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true"></a>    <span class="co">// 下記クラスBase、Derived、DerivedDerivedの前処理はクローンコードになっている。</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true"></a>    <span class="co">// NVIを用いて、この問題に対処せよ。</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true"></a>    <span class="kw">class</span> Base {</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true"></a>        <span class="kw">explicit</span> Base(<span class="bu">std::</span>string name) : <span class="va">name1_</span>{name} {}</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Base() = <span class="cf">default</span>;</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName1() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name1_</span>; }</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true"></a>        <span class="dt">bool</span> IsEqual(Base <span class="at">const</span>&amp; rhs) <span class="at">const</span> <span class="kw">noexcept</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true"></a>        {</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="kw">this</span> == &amp;rhs) {</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true"></a>                <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true"></a>            }</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="kw">typeid</span>(*<span class="kw">this</span>) != <span class="kw">typeid</span>(rhs)) {</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true"></a>                <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true"></a>            }</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true"></a></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true"></a>            <span class="cf">return</span> is_equal(rhs);</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true"></a>        }</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true"></a></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true"></a>    <span class="kw">protected</span>:</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">bool</span> is_equal(Base <span class="at">const</span>&amp; rhs) <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name1_</span> == rhs.<span class="va">name1_</span>; }</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true"></a></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name1_</span>;</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true"></a>    };</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true"></a></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true"></a>    <span class="kw">class</span> Derived : <span class="kw">public</span> Base {</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true"></a>        <span class="kw">explicit</span> Derived(<span class="bu">std::</span>string name1 = <span class="st">&quot;&quot;</span>, <span class="bu">std::</span>string name2 = <span class="st">&quot;&quot;</span>) : Base{name1}, <span class="va">name2_</span>{name2} {}</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Derived() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName2() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name2_</span>; }</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true"></a></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true"></a>    <span class="kw">protected</span>:</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">bool</span> is_equal(Base <span class="at">const</span>&amp; rhs) <span class="at">const</span> <span class="kw">noexcept</span> <span class="kw">override</span></span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true"></a>        {</span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true"></a>            <span class="cf">if</span> (!Base::is_equal(rhs)) {</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true"></a>                <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true"></a>            }</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true"></a></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true"></a>            <span class="kw">auto</span> rhs_d = <span class="kw">dynamic_cast</span>&lt;Derived <span class="at">const</span>*&gt;(&amp;rhs);</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true"></a></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true"></a>            <span class="cf">return</span> (rhs_d != <span class="kw">nullptr</span>) &amp;&amp; (<span class="va">name2_</span> == rhs_d-&gt;<span class="va">name2_</span>);</span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true"></a>        }</span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true"></a></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name2_</span>;</span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true"></a>    };</span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true"></a></span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true"></a>    <span class="kw">class</span> DerivedDerived : <span class="kw">public</span> Derived {</span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true"></a>        <span class="kw">explicit</span> DerivedDerived(<span class="bu">std::</span>string name1 = <span class="st">&quot;&quot;</span>, <span class="bu">std::</span>string name2 = <span class="st">&quot;&quot;</span>, <span class="bu">std::</span>string name3 = <span class="st">&quot;&quot;</span>)</span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true"></a>            : Derived{name1, name2}, <span class="va">name3_</span>{name3}</span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true"></a>        {</span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true"></a>        }</span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true"></a>        <span class="kw">virtual</span> ~DerivedDerived() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName3() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name3_</span>; }</span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true"></a></span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true"></a>    <span class="kw">protected</span>:</span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">bool</span> is_equal(Base <span class="at">const</span>&amp; rhs) <span class="at">const</span> <span class="kw">noexcept</span> <span class="kw">override</span></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true"></a>        {</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true"></a>            <span class="cf">if</span> (!Derived::is_equal(rhs)) {</span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true"></a>                <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true"></a>            }</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true"></a></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true"></a>            <span class="kw">auto</span> rhs_d = <span class="kw">dynamic_cast</span>&lt;DerivedDerived <span class="at">const</span>*&gt;(&amp;rhs);</span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true"></a></span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true"></a>            <span class="cf">return</span> (rhs_d != <span class="kw">nullptr</span>) &amp;&amp; (<span class="va">name3_</span> == rhs_d-&gt;<span class="va">name3_</span>);</span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true"></a>        }</span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true"></a></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name3_</span>;</span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true"></a>    };</span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true"></a></span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true"></a>    TEST(DesignPatternA, NVI)</span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true"></a>    {</span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true"></a>        <span class="kw">auto</span> b1 = Base{<span class="st">&quot;b1&quot;</span>};</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true"></a></span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true"></a>        ASSERT_TRUE(b1.IsEqual(Base{b1}));</span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true"></a>        ASSERT_TRUE(b1.IsEqual(Base{<span class="st">&quot;b1&quot;</span>}));</span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true"></a>        ASSERT_FALSE(b1.IsEqual(Base{<span class="st">&quot;b2&quot;</span>}));</span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true"></a>        ASSERT_FALSE(b1.IsEqual(Derived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>}));</span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true"></a></span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true"></a>        <span class="kw">auto</span> d1 = Derived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>};</span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true"></a></span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true"></a>        ASSERT_FALSE(d1.IsEqual(Base{<span class="st">&quot;b1&quot;</span>}));</span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true"></a>        ASSERT_TRUE(d1.IsEqual(d1));</span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true"></a>        ASSERT_TRUE(d1.IsEqual(Derived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>}));</span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true"></a>        ASSERT_FALSE(d1.IsEqual(Derived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d2&quot;</span>}));</span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true"></a>        ASSERT_FALSE(d1.IsEqual(DerivedDerived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>, <span class="st">&quot;dd2&quot;</span>}));</span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true"></a></span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true"></a>        <span class="kw">auto</span> dd1 = DerivedDerived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>, <span class="st">&quot;dd1&quot;</span>};</span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true"></a></span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true"></a>        ASSERT_FALSE(dd1.IsEqual(Base{<span class="st">&quot;b1&quot;</span>}));</span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true"></a>        ASSERT_FALSE(dd1.IsEqual(Derived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>}));</span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true"></a>        ASSERT_TRUE(dd1.IsEqual(dd1));</span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true"></a>        ASSERT_TRUE(dd1.IsEqual(DerivedDerived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>, <span class="st">&quot;dd1&quot;</span>}));</span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true"></a>        ASSERT_FALSE(dd1.IsEqual(DerivedDerived{<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;d1&quot;</span>, <span class="st">&quot;dd2&quot;</span>}));</span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_9">演習-NVI</a>へ戻る。</li>
</ul>
<h3 id="解答-raiiの効果">解答-RAIIの効果 <a id="SS_20_9_10"></a></h3>
<ul>
<li>選択肢1</li>
<li>参照 <a href="design_pattern.html#SS_9_9">RAII(scoped guard)</a></li>
<li><a href="exercise_q.html#SS_19_9_10">演習-RAIIの効果</a>へ戻る。</li>
</ul>
<h3 id="解答例-raii">解答例-RAII <a id="SS_20_9_11"></a></h3>
<div class="sourceCode" id="cb62"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/raii.cpp 5</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true"></a>    <span class="co">// 下記クラスBase、Derivedはクローンパターンをしているが、Clone関数はnewしたオブジェクトであるため、</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true"></a>    <span class="co">// メモリーリークを起こしやすい。std::unique_ptrを使用してこの問題に対処せよ。</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true"></a>    <span class="kw">class</span> Base {</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true"></a>        <span class="kw">explicit</span> Base(<span class="bu">std::</span>string name) : <span class="va">name1_</span>{<span class="bu">std::</span>move(name)} {}</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Base() = <span class="cf">default</span>;</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">name1_</span>; }</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>unique_ptr&lt;Base&gt; Clone() <span class="at">const</span> { <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;Base&gt;(<span class="va">name1_</span>); }</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true"></a>        Base(Base <span class="at">const</span>&amp;)            = <span class="kw">delete</span>;</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true"></a>        Base&amp; <span class="kw">operator</span>=(Base <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true"></a></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name1_</span>;</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true"></a>    };</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true"></a></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true"></a>    <span class="kw">class</span> Derived <span class="kw">final</span> : <span class="kw">public</span> Base {</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true"></a>        <span class="kw">explicit</span> Derived(<span class="bu">std::</span>string name1 = <span class="st">&quot;&quot;</span>, <span class="bu">std::</span>string name2 = <span class="st">&quot;&quot;</span>)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true"></a>            : Base{<span class="bu">std::</span>move(name1)}, <span class="va">name2_</span>{<span class="bu">std::</span>move(name2)}</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true"></a>        {</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true"></a>        }</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Derived() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; GetName() <span class="at">const</span> <span class="kw">noexcept</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="va">name2_</span>; }</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true"></a></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>unique_ptr&lt;Base&gt; Clone() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> CloneOwn(); }</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true"></a></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Derived&gt; CloneOwn() <span class="at">const</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true"></a>        {</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;Derived&gt;(Base::GetName(), <span class="va">name2_</span>);</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true"></a>        }</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true"></a></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">name2_</span>;</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true"></a>    };</span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true"></a></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true"></a>    TEST(DesignPatternA, RAII)</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true"></a>    {</span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true"></a>        Derived                  d1{<span class="st">&quot;name1&quot;</span>, <span class="st">&quot;name2&quot;</span>};</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Derived&gt; d2{d1.CloneOwn()};</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true"></a></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name1&quot;</span>, d2-&gt;Base::GetName());</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name2&quot;</span>, d2-&gt;GetName());</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true"></a></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Base&gt; b3 = d1.Clone();</span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true"></a></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name1&quot;</span>, b3-&gt;Base::GetName());</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;name2&quot;</span>, b3-&gt;GetName());</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_11">演習-RAII</a>へ戻る。</li>
</ul>
<h3 id="解答例-future">解答例-Future <a id="SS_20_9_12"></a></h3>
<div class="sourceCode" id="cb63"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/future.cpp 25</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true"></a>    <span class="co">// 下記のfind_files_concurrentlyはスレッドの出力の結果をキャプチャリファレンスで受け取るため、</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true"></a>    <span class="co">// 入出力の関係が明確でない。Futureパターンを使用しそれを明確にするリファクタリングを行え。</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true"></a>    <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; find_files_concurrently()</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true"></a>    {</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true"></a>        <span class="bu">std::</span>future&lt;<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;&gt; result0</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true"></a>            = <span class="bu">std::</span>async(<span class="bu">std::</span>launch<span class="bu">::</span>async, [] { <span class="cf">return</span> find_files(<span class="st">&quot;../programming_convention_a/&quot;</span>); });</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true"></a>        <span class="bu">std::</span>future&lt;<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;&gt; result1</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true"></a>            = <span class="bu">std::</span>async(<span class="bu">std::</span>launch<span class="bu">::</span>async, [] { <span class="cf">return</span> find_files(<span class="st">&quot;../programming_convention_q/&quot;</span>); });</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true"></a>        <span class="kw">auto</span> pca = result0.get();</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true"></a>        <span class="kw">auto</span> pcq = result1.get();</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true"></a>        pca.insert(pca.end(), pcq.begin(), pcq.end());</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true"></a></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true"></a>        <span class="cf">return</span> pca;</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true"></a>    }</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true"></a></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true"></a>    TEST(DesignPatternA, Future)</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true"></a>    {</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true"></a>        <span class="kw">auto</span> files = find_files_concurrently();</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true"></a></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true"></a>        ASSERT_GT(files.size(), <span class="dv">10</span>);</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_12">演習-Future</a>へ戻る。</li>
</ul>
<h3 id="解答例-di">解答例-DI <a id="SS_20_9_13"></a></h3>
<div class="sourceCode" id="cb64"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/di.cpp 10</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true"></a>    <span class="co">// CppFilesはLsCppを直に生成するため、LsCpp::FileList()がエラーした場合の単体テスト実施が</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true"></a>    <span class="co">// 困難である。CppFilesにDIパターンを適用するとともに、LsCppを適切に変更することによって、</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true"></a>    <span class="co">// LsCpp::FileList()がエラーした場合のCppFilesの単体テストを行え。</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true"></a>    <span class="kw">class</span> LsCpp {</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true"></a>        <span class="kw">virtual</span> ~LsCpp() {}</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; FileList() { <span class="cf">return</span> file_list(); }</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true"></a></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">files_</span>{};</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; file_list()  <span class="co">// 単体テストのためにvirtual</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true"></a>        {</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="va">files_</span>.size() != <span class="dv">0</span>) {  <span class="co">// キャッシュを使う</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true"></a>                <span class="cf">return</span> <span class="va">files_</span>;</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true"></a>            }</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true"></a></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true"></a>            <span class="kw">auto</span> stream</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true"></a>                = <span class="bu">std::</span>unique_ptr&lt;<span class="dt">FILE</span>, <span class="kw">decltype</span>(&amp;fclose)&gt;{popen(<span class="st">&quot;ls ../ut_data/*.cpp&quot;</span>, <span class="st">&quot;r&quot;</span>), fclose};</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true"></a></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true"></a>            <span class="cf">if</span> (stream.get() == NULL) {</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true"></a>                <span class="cf">throw</span> <span class="bu">std::</span>exception{};</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true"></a>            }</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true"></a>            <span class="dt">char</span> buff[<span class="dv">256</span>];</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true"></a>            <span class="cf">while</span> (fgets(buff, <span class="kw">sizeof</span>(buff) - <span class="dv">1</span>, stream.get()) != NULL) {</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true"></a>                <span class="va">files_</span> += buff;</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true"></a>            }</span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true"></a></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">files_</span>;</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true"></a>        }</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true"></a>    };</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true"></a></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true"></a>    <span class="kw">class</span> CppFiles {</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true"></a>        <span class="kw">explicit</span> CppFiles(<span class="bu">std::</span>unique_ptr&lt;LsCpp&gt;&amp;&amp; ls_cpp = <span class="bu">std::</span>make_unique&lt;LsCpp&gt;())</span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true"></a>            : <span class="va">ls_cpp_</span>{<span class="bu">std::</span>move(ls_cpp)}</span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true"></a>        {</span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true"></a>        }</span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true"></a></span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; FileList() <span class="at">const</span></span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true"></a>        {</span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true"></a>            <span class="kw">auto</span> files = <span class="bu">std::</span>string{};</span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true"></a></span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true"></a>            <span class="cf">try</span> {</span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true"></a>                files = <span class="va">ls_cpp_</span>-&gt;FileList();</span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true"></a>            }</span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true"></a>            <span class="cf">catch</span> (...) {</span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true"></a>                ;  <span class="co">// 例外発生時には空のベクタを返すので何もしない。</span></span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true"></a>            }</span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true"></a></span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true"></a>            <span class="cf">return</span> split_cr(files);</span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true"></a>        }</span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true"></a></span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;LsCpp&gt; <span class="va">ls_cpp_</span>;</span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true"></a></span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; split_cr(<span class="bu">std::</span>string <span class="at">const</span>&amp; str)</span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true"></a>        {</span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true"></a>            <span class="kw">auto</span> ss  = <span class="bu">std::</span>stringstream{str};</span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true"></a>            <span class="kw">auto</span> ret = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{};</span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true"></a></span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="bu">std::</span>string line; <span class="bu">std::</span>getline(ss, line);) {</span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true"></a>                ret.emplace_back(line);</span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true"></a>            }</span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true"></a></span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true"></a>            <span class="cf">return</span> ret;</span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true"></a>        }</span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true"></a>    };</span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true"></a></span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true"></a>    <span class="kw">class</span> LsCppError : <span class="kw">public</span> LsCpp {</span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true"></a>        LsCppError() <span class="kw">noexcept</span> {}</span>
<span id="cb64-78"><a href="#cb64-78" aria-hidden="true"></a>        <span class="kw">virtual</span> ~LsCppError() <span class="kw">override</span> {}</span>
<span id="cb64-79"><a href="#cb64-79" aria-hidden="true"></a></span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb64-81"><a href="#cb64-81" aria-hidden="true"></a>        [[<span class="at">noreturn</span>]] <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; file_list() <span class="kw">override</span> { <span class="cf">throw</span> <span class="bu">std::</span>exception{}; }</span>
<span id="cb64-82"><a href="#cb64-82" aria-hidden="true"></a>    };</span>
<span id="cb64-83"><a href="#cb64-83" aria-hidden="true"></a></span>
<span id="cb64-84"><a href="#cb64-84" aria-hidden="true"></a>    TEST(DesignPatternA, DI)</span>
<span id="cb64-85"><a href="#cb64-85" aria-hidden="true"></a>    {</span>
<span id="cb64-86"><a href="#cb64-86" aria-hidden="true"></a>        <span class="kw">auto</span>        files = CppFiles{};</span>
<span id="cb64-87"><a href="#cb64-87" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; act   = files.FileList();</span>
<span id="cb64-88"><a href="#cb64-88" aria-hidden="true"></a>        <span class="kw">auto</span>        exp   = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;../ut_data/a.cpp&quot;</span>, <span class="st">&quot;../ut_data/abc.cpp&quot;</span>,</span>
<span id="cb64-89"><a href="#cb64-89" aria-hidden="true"></a>                                                     <span class="st">&quot;../ut_data/efghij.cpp&quot;</span>};</span>
<span id="cb64-90"><a href="#cb64-90" aria-hidden="true"></a></span>
<span id="cb64-91"><a href="#cb64-91" aria-hidden="true"></a>        ASSERT_EQ(exp, act);</span>
<span id="cb64-92"><a href="#cb64-92" aria-hidden="true"></a></span>
<span id="cb64-93"><a href="#cb64-93" aria-hidden="true"></a>        <span class="co">// エラー系のテスト</span></span>
<span id="cb64-94"><a href="#cb64-94" aria-hidden="true"></a>        <span class="kw">auto</span> files2 = CppFiles{<span class="bu">std::</span>make_unique&lt;LsCppError&gt;()};</span>
<span id="cb64-95"><a href="#cb64-95" aria-hidden="true"></a></span>
<span id="cb64-96"><a href="#cb64-96" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">0</span>, files2.FileList().size());</span>
<span id="cb64-97"><a href="#cb64-97" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_13">演習-DI</a>へ戻る。</li>
</ul>
<h3 id="解答例-singleton">解答例-Singleton <a id="SS_20_9_14"></a></h3>
<div class="sourceCode" id="cb65"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/singleton.cpp 5</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true"></a>    <span class="co">// 下記AppConfigはアプリケーション全体の設定を管理するためのクラスである。</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true"></a>    <span class="co">// 目的上、そのインスタンスAppConfigは広域のアクセスが必要であり、</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true"></a>    <span class="co">// グローバルインスタンスとして実装している。</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true"></a>    <span class="co">// グローバルインスタンスは、初期化の順番が標準化されておらず、</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true"></a>    <span class="co">// 多くの処理系ではリンクの順番に依存しているため、</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true"></a>    <span class="co">// アプリケーション立ち上げ時に様々な問題を起こすことがある。</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true"></a>    <span class="co">// こういった問題を回避するため、AppConfigをSingleton化せよ。</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true"></a>    <span class="co">// また他の問題があれば合わせて修正せよ。</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true"></a>    <span class="co">// * AppConfigをSingletonにした。</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true"></a>    <span class="co">//      * インスタンスを返すInst()と同じインスタンスをconst修飾したものを返すInstConst()を追加。</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true"></a>    <span class="co">//      * コンストラクタをprivateにした。</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true"></a>    <span class="co">//      * copyコンストラクタを= deleteした(こうすればmoveコンストラクタも= deleteされる)。</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true"></a>    <span class="co">// * リファクタリング</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true"></a>    <span class="co">//      * BaseColorをスコープドenumにした。</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true"></a>    <span class="co">//      * GetXxxをconst関数にした。</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true"></a>    <span class="co">//      * GetUserNameの戻りをconstリファレンスにした。</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true"></a>    <span class="co">//      * コピー演算子を使用しSetDefaultをシンプルにした。</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true"></a></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true"></a>    <span class="kw">class</span> AppConfig {</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true"></a>        <span class="at">static</span> AppConfig&amp; Inst()</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true"></a>        {</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true"></a>            <span class="at">static</span> <span class="kw">auto</span> inst = AppConfig{};</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true"></a></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true"></a>            <span class="cf">return</span> inst;</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true"></a>        }</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true"></a></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true"></a>        <span class="at">static</span> AppConfig <span class="at">const</span>&amp; InstConst() { <span class="cf">return</span> Inst(); }</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true"></a></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true"></a>        <span class="kw">enum</span> <span class="kw">class</span> BaseColor { Red, Green, Black };</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true"></a></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true"></a>        <span class="dt">void</span>      SetBaseColor(BaseColor color) <span class="kw">noexcept</span> { <span class="va">color_</span> = color; }</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true"></a>        BaseColor GetBaseColor() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">color_</span>; }</span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true"></a></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true"></a>        <span class="dt">void</span>               SetUserName(<span class="bu">std::</span>string_view username) { <span class="va">username_</span> = username; }</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetUserName() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">username_</span>; }</span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true"></a></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true"></a>        <span class="dt">void</span> Logging(<span class="dt">bool</span> is_logging) <span class="kw">noexcept</span> { <span class="va">is_logging_</span> = is_logging; }</span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true"></a>        <span class="dt">bool</span> IsLoggin() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">is_logging_</span>; }</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true"></a></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true"></a>        <span class="co">// 他の設定値は省略</span></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true"></a></span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true"></a>        <span class="dt">void</span> SetDefault() { *<span class="kw">this</span> = AppConfig{}; }</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true"></a></span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true"></a>        <span class="co">// これがないとcopyコンストラクタやmoveコンストラクタで別のインスタンスが作れる。</span></span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true"></a>        <span class="co">//    AppConfig app{AppConfig::Inst()};</span></span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true"></a>        <span class="co">//    AppConfig app{std::move(AppConfig::Inst())};</span></span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true"></a>        AppConfig(AppConfig <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true"></a></span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true"></a>        BaseColor   <span class="va">color_</span>{BaseColor::Red};</span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">username_</span>{<span class="st">&quot;No Name&quot;</span>};</span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true"></a>        <span class="dt">bool</span>        <span class="va">is_logging_</span>{<span class="kw">false</span>};</span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true"></a></span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true"></a>        AppConfig()                            = <span class="cf">default</span>;</span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true"></a>        AppConfig&amp; <span class="kw">operator</span>=(AppConfig <span class="at">const</span>&amp;) = <span class="cf">default</span>;</span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true"></a>    };</span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true"></a></span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true"></a>    <span class="kw">class</span> DesignPatternA_F : <span class="kw">public</span> ::testing::Test {</span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true"></a>    <span class="kw">protected</span>:</span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> SetUp() <span class="kw">override</span> { AppConfig::Inst().SetDefault(); }</span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true"></a></span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> TearDown() <span class="kw">override</span> { AppConfig::Inst().SetDefault(); }</span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true"></a>    };</span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true"></a></span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true"></a>    TEST_F(DesignPatternA_F, Singleton)</span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true"></a>    {</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true"></a>        ASSERT_EQ(AppConfig::BaseColor::Red, AppConfig::InstConst().GetBaseColor());</span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;No Name&quot;</span>, AppConfig::InstConst().GetUserName());</span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true"></a>        ASSERT_FALSE(AppConfig::InstConst().IsLoggin());</span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true"></a></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true"></a>        AppConfig::Inst().SetBaseColor(AppConfig::BaseColor::Green);</span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true"></a>        ASSERT_EQ(AppConfig::BaseColor::Green, AppConfig::InstConst().GetBaseColor());</span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true"></a></span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true"></a>        AppConfig::Inst().SetUserName(<span class="st">&quot;Stroustrup&quot;</span>);</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;Stroustrup&quot;</span>, AppConfig::InstConst().GetUserName());</span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true"></a></span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true"></a>        AppConfig::Inst().Logging(<span class="kw">true</span>);</span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true"></a>        ASSERT_TRUE(AppConfig::InstConst().IsLoggin());</span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true"></a></span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true"></a>        AppConfig::Inst().SetDefault();</span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true"></a>        ASSERT_EQ(AppConfig::BaseColor::Red, AppConfig::InstConst().GetBaseColor());</span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;No Name&quot;</span>, AppConfig::InstConst().GetUserName());</span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true"></a>        ASSERT_FALSE(AppConfig::InstConst().IsLoggin());</span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_14">演習-Singleton</a>へ戻る。</li>
</ul>
<h3 id="解答例-state">解答例-State <a id="SS_20_9_15"></a></h3>
<div class="sourceCode" id="cb66"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/state.cpp 5</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true"></a>    <span class="co">// 下記クラスGreetingにはlang_に対する同型のswitch文が3個ある。</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true"></a>    <span class="co">// これは機能追加時にバグが混入しやすいアンチパターンであるため、</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true"></a>    <span class="co">// Stateパターンを用いリファクタリングせよ。</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true"></a>    <span class="co">// また、他の問題があれば合わせて修正せよ。</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true"></a>    <span class="kw">enum</span> <span class="kw">class</span> Language { English, Japanese, French };</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true"></a>    <span class="kw">class</span> GreetingState {</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true"></a>        <span class="kw">virtual</span> ~GreetingState() = <span class="cf">default</span>;</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true"></a>        <span class="bu">std::</span>string GoodMorning() { <span class="cf">return</span> good_morning(); }</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true"></a>        <span class="bu">std::</span>string Hello() { <span class="cf">return</span> hello(); }</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true"></a>        <span class="bu">std::</span>string GoodEvening() { <span class="cf">return</span> good_evening(); }</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_morning() <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string hello() <span class="at">const</span>        = <span class="dv">0</span>;</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_evening() <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true"></a>    };</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true"></a></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true"></a>    <span class="kw">class</span> GreetingState_English : <span class="kw">public</span> GreetingState {</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_morning() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;good morning&quot;</span>; }</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string hello() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;hello&quot;</span>; }</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_evening() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;good evening&quot;</span>; }</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true"></a>    };</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true"></a></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true"></a>    <span class="kw">class</span> GreetingState_Japanese : <span class="kw">public</span> GreetingState {</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_morning() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;おはよう&quot;</span>; }</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string hello() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;こんにちは&quot;</span>; }</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_evening() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;こんばんは&quot;</span>; }</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true"></a>    };</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true"></a></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true"></a>    <span class="kw">class</span> GreetingState_French : <span class="kw">public</span> GreetingState {</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_morning() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;Bonjour&quot;</span>; }</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string hello() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;Bonjour&quot;</span>; }</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string good_evening() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">u8&quot;bonne soirée&quot;</span>; }</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true"></a>    };</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true"></a></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true"></a>    <span class="kw">class</span> Greeting {</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true"></a>        <span class="kw">explicit</span> Greeting(Language lang = Language::English) : <span class="va">state_</span>{new_state(lang)} {}</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true"></a>        <span class="dt">void</span> SetLanguage(Language lang) { <span class="va">state_</span> = new_state(lang); }</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true"></a></span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true"></a>        <span class="bu">std::</span>string GoodMorning() <span class="at">const</span> { <span class="cf">return</span> <span class="va">state_</span>-&gt;GoodMorning(); }</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true"></a>        <span class="bu">std::</span>string Hello() <span class="at">const</span> { <span class="cf">return</span> <span class="va">state_</span>-&gt;Hello(); }</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true"></a>        <span class="bu">std::</span>string GoodEvening() <span class="at">const</span> { <span class="cf">return</span> <span class="va">state_</span>-&gt;GoodEvening(); }</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true"></a></span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;GreetingState&gt; <span class="va">state_</span>;</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true"></a></span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>unique_ptr&lt;GreetingState&gt; new_state(Language lang)</span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true"></a>        {</span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true"></a>            <span class="cf">switch</span> (lang) {</span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true"></a>            <span class="cf">case</span> Language::Japanese:</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true"></a>                <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;GreetingState_Japanese&gt;();</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true"></a>            <span class="cf">case</span> Language::French:</span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true"></a>                <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;GreetingState_French&gt;();</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true"></a>            <span class="cf">case</span> Language::English:</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true"></a>            <span class="cf">default</span>:</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true"></a>                <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;GreetingState_English&gt;();</span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true"></a>            }</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true"></a>        }</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true"></a>    };</span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true"></a></span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true"></a>    TEST(DesignPatternA, State)</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true"></a>    {</span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true"></a>        <span class="kw">auto</span> greeting = Greeting{};</span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true"></a></span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;good morning&quot;</span>, greeting.GoodMorning());</span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;hello&quot;</span>, greeting.Hello());</span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;good evening&quot;</span>, greeting.GoodEvening());</span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true"></a></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true"></a>        greeting.SetLanguage(Language::Japanese);</span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;おはよう&quot;</span>, greeting.GoodMorning());</span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;こんにちは&quot;</span>, greeting.Hello());</span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;こんばんは&quot;</span>, greeting.GoodEvening());</span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true"></a></span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true"></a>        greeting.SetLanguage(Language::French);</span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;Bonjour&quot;</span>, greeting.GoodMorning());</span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;Bonjour&quot;</span>, greeting.Hello());</span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;bonne soirée&quot;</span>, greeting.GoodEvening());</span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true"></a></span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true"></a>        greeting.SetLanguage(Language::English);</span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;good morning&quot;</span>, greeting.GoodMorning());</span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;hello&quot;</span>, greeting.Hello());</span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;good evening&quot;</span>, greeting.GoodEvening());</span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_15">演習-State</a>へ戻る。</li>
</ul>
<h3 id="解答例-null-object">解答例-Null Object <a id="SS_20_9_16"></a></h3>
<div class="sourceCode" id="cb67"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/null_object.cpp 38</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true"></a>    <span class="co">// 下記クラスPersonにはgreeting_のヌルチェックを行う三項演算子が3つある。</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true"></a>    <span class="co">// これはヌルポインタアクセスを起こしやすいアンチパターンであるため、</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true"></a>    <span class="co">// Null Objectパターンを用いリファクタリングせよ。</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true"></a>    <span class="co">// また、他の問題があれば合わせて修正せよ。</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true"></a>    <span class="co">// * 通常Null Objectパターンは</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true"></a>    <span class="co">//      if(object_ptr != nullptr) { ... }</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true"></a>    <span class="co">//   のようなコードが頻繁に存在する場合にそのコードの繰り返しを無くすためのものであるが、</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true"></a>    <span class="co">//   本例では対象が生のポインタでなくスマートポインタに適用した。</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true"></a>    <span class="co">// * 本例では、GoodMorning等が単純であるためGreetingにNVIを適用していないが、NVIを適用しても良い。</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true"></a>    <span class="co">// * 本例では、ヌルかどうかの同型条件分岐が3個しかないコードにNull Objectパターンを適用した。</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true"></a>    <span class="co">//   例題のためそうしたが、この程度の単純なコードにこのパターンを適用するのはやりすぎである。</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true"></a>    <span class="co">//   この程度のコードクローンであれば一つのヘルパー関数にまとめた方が実践的である。</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true"></a></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true"></a>    <span class="kw">class</span> Greeting {</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true"></a>        <span class="kw">explicit</span> Greeting(Language lang = Language::English) : <span class="va">state_</span>{new_state(lang)} {}</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Greeting() = <span class="cf">default</span>;</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true"></a>        <span class="dt">void</span> SetLanguage(Language lang) { <span class="va">state_</span> = new_state(lang); }</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true"></a></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string GoodMorning() <span class="at">const</span> { <span class="cf">return</span> <span class="va">state_</span>-&gt;GoodMorning(); }</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string Hello() <span class="at">const</span> { <span class="cf">return</span> <span class="va">state_</span>-&gt;Hello(); }</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string GoodEvening() <span class="at">const</span> { <span class="cf">return</span> <span class="va">state_</span>-&gt;GoodEvening(); }</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true"></a></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;GreetingState&gt; <span class="va">state_</span>;</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true"></a></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>unique_ptr&lt;GreetingState&gt; new_state(Language lang)</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true"></a>        {</span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true"></a>            <span class="cf">switch</span> (lang) {</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true"></a>            <span class="cf">case</span> Language::Japanese:</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true"></a>                <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;GreetingState_Japanese&gt;();</span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true"></a>            <span class="cf">case</span> Language::French:</span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true"></a>                <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;GreetingState_French&gt;();</span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true"></a>            <span class="cf">case</span> Language::English:</span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true"></a>            <span class="cf">default</span>:</span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true"></a>                <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;GreetingState_English&gt;();</span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true"></a>            }</span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true"></a>        }</span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true"></a>    };</span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true"></a></span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true"></a>    <span class="kw">class</span> GreetingSilent : <span class="kw">public</span> Greeting {</span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true"></a>        <span class="kw">explicit</span> GreetingSilent()          = <span class="cf">default</span>;</span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true"></a>        <span class="kw">virtual</span> ~GreetingSilent() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true"></a></span>
<span id="cb67-50"><a href="#cb67-50" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string GoodMorning() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">&quot;&quot;</span>; }</span>
<span id="cb67-51"><a href="#cb67-51" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string Hello() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">&quot;&quot;</span>; }</span>
<span id="cb67-52"><a href="#cb67-52" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string GoodEvening() <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> <span class="st">&quot;&quot;</span>; }</span>
<span id="cb67-53"><a href="#cb67-53" aria-hidden="true"></a>    };</span>
<span id="cb67-54"><a href="#cb67-54" aria-hidden="true"></a></span>
<span id="cb67-55"><a href="#cb67-55" aria-hidden="true"></a>    <span class="kw">class</span> Person {</span>
<span id="cb67-56"><a href="#cb67-56" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb67-57"><a href="#cb67-57" aria-hidden="true"></a>        <span class="kw">explicit</span> Person(Language lang, <span class="dt">bool</span> silent = <span class="kw">false</span>)</span>
<span id="cb67-58"><a href="#cb67-58" aria-hidden="true"></a>            : <span class="va">greeting_</span>{silent ? <span class="bu">std::</span>make_unique&lt;GreetingSilent&gt;() : <span class="bu">std::</span>make_unique&lt;Greeting&gt;(lang)}</span>
<span id="cb67-59"><a href="#cb67-59" aria-hidden="true"></a>        {</span>
<span id="cb67-60"><a href="#cb67-60" aria-hidden="true"></a>        }</span>
<span id="cb67-61"><a href="#cb67-61" aria-hidden="true"></a></span>
<span id="cb67-62"><a href="#cb67-62" aria-hidden="true"></a>        <span class="bu">std::</span>string GoodMorning() <span class="at">const</span> { <span class="cf">return</span> <span class="va">greeting_</span>-&gt;GoodMorning(); }</span>
<span id="cb67-63"><a href="#cb67-63" aria-hidden="true"></a>        <span class="bu">std::</span>string Hello() <span class="at">const</span> { <span class="cf">return</span> <span class="va">greeting_</span>-&gt;Hello(); }</span>
<span id="cb67-64"><a href="#cb67-64" aria-hidden="true"></a>        <span class="bu">std::</span>string GoodEvening() <span class="at">const</span> { <span class="cf">return</span> <span class="va">greeting_</span>-&gt;GoodEvening(); }</span>
<span id="cb67-65"><a href="#cb67-65" aria-hidden="true"></a></span>
<span id="cb67-66"><a href="#cb67-66" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb67-67"><a href="#cb67-67" aria-hidden="true"></a>        <span class="bu">std::</span>unique_ptr&lt;Greeting&gt; <span class="va">greeting_</span>;</span>
<span id="cb67-68"><a href="#cb67-68" aria-hidden="true"></a>    };</span>
<span id="cb67-69"><a href="#cb67-69" aria-hidden="true"></a></span>
<span id="cb67-70"><a href="#cb67-70" aria-hidden="true"></a>    TEST(DesignPatternA, NullObject)</span>
<span id="cb67-71"><a href="#cb67-71" aria-hidden="true"></a>    {</span>
<span id="cb67-72"><a href="#cb67-72" aria-hidden="true"></a>        <span class="kw">auto</span> e = Person{Language::English};</span>
<span id="cb67-73"><a href="#cb67-73" aria-hidden="true"></a></span>
<span id="cb67-74"><a href="#cb67-74" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;good morning&quot;</span>, e.GoodMorning());</span>
<span id="cb67-75"><a href="#cb67-75" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;hello&quot;</span>, e.Hello());</span>
<span id="cb67-76"><a href="#cb67-76" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;good evening&quot;</span>, e.GoodEvening());</span>
<span id="cb67-77"><a href="#cb67-77" aria-hidden="true"></a></span>
<span id="cb67-78"><a href="#cb67-78" aria-hidden="true"></a>        <span class="kw">auto</span> j = Person{Language::Japanese};</span>
<span id="cb67-79"><a href="#cb67-79" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;おはよう&quot;</span>, j.GoodMorning());</span>
<span id="cb67-80"><a href="#cb67-80" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;こんにちは&quot;</span>, j.Hello());</span>
<span id="cb67-81"><a href="#cb67-81" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;こんばんは&quot;</span>, j.GoodEvening());</span>
<span id="cb67-82"><a href="#cb67-82" aria-hidden="true"></a></span>
<span id="cb67-83"><a href="#cb67-83" aria-hidden="true"></a>        <span class="kw">auto</span> f = Person{Language::French};</span>
<span id="cb67-84"><a href="#cb67-84" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;Bonjour&quot;</span>, f.GoodMorning());</span>
<span id="cb67-85"><a href="#cb67-85" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;Bonjour&quot;</span>, f.Hello());</span>
<span id="cb67-86"><a href="#cb67-86" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;bonne soirée&quot;</span>, f.GoodEvening());</span>
<span id="cb67-87"><a href="#cb67-87" aria-hidden="true"></a></span>
<span id="cb67-88"><a href="#cb67-88" aria-hidden="true"></a>        <span class="kw">auto</span> e_s = Person{Language::English, <span class="kw">true</span>};</span>
<span id="cb67-89"><a href="#cb67-89" aria-hidden="true"></a></span>
<span id="cb67-90"><a href="#cb67-90" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;&quot;</span>, e_s.GoodMorning());</span>
<span id="cb67-91"><a href="#cb67-91" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;&quot;</span>, e_s.Hello());</span>
<span id="cb67-92"><a href="#cb67-92" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">u8&quot;&quot;</span>, e_s.GoodEvening());</span>
<span id="cb67-93"><a href="#cb67-93" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_16">演習-Null Object</a>へ戻る。</li>
</ul>
<h3 id="解答例-templateメソッド">解答例-Templateメソッド <a id="SS_20_9_17"></a></h3>
<div class="sourceCode" id="cb68"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/template_method.cpp 5</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true"></a>    <span class="co">// 下記クラスXxxDataFormatterXml、XxxDataFormatterCsvは同様の処理を行い、</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true"></a>    <span class="co">// それぞれのフォーマットで文字列を出力する。このような処理のクローンはTemplate Method</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true"></a>    <span class="co">// パターンにより排除できる。</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true"></a>    <span class="co">// このパターンを用い、下記2クラスをリファクタリングせよ。</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true"></a>    <span class="co">// また、他の問題があれば合わせて修正せよ。</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true"></a>    <span class="co">// * Template Methodのインターフェースクラスとして、XxxDataFormatterIFを定義した。</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true"></a>    <span class="co">//      * header()、footer()はstd::stringのリファレンスを返すが、</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true"></a>    <span class="co">//        body()は返すstd::stringが引数に依存して変わるため、実態を返す。</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true"></a>    <span class="co">// * その他の修正</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true"></a>    <span class="co">//      * header_やfooter_はそれぞれのクラスで同じオブジェクトであるため、</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true"></a>    <span class="co">//        static constインスタンスとして、それぞれheader()、footer()の内部で定義した。</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true"></a>    <span class="co">//      * XxxDataFormatterXml、XxxDataFormatterCsvはそれ以上派生する必要がないためfinalとした。</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true"></a></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true"></a>    <span class="kw">struct</span> XxxData {</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true"></a>        <span class="dt">int</span> a;</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true"></a>        <span class="dt">int</span> b;</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true"></a>        <span class="dt">int</span> c;</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true"></a>    };</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true"></a></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true"></a>    <span class="kw">class</span> XxxDataFormatterIF {</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true"></a>        XxxDataFormatterIF() <span class="kw">noexcept</span>                            = <span class="cf">default</span>;</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true"></a>        <span class="kw">virtual</span> ~XxxDataFormatterIF()                            = <span class="cf">default</span>;</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true"></a>        XxxDataFormatterIF(XxxDataFormatterIF <span class="at">const</span>&amp;)            = <span class="kw">delete</span>;</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true"></a>        XxxDataFormatterIF&amp; <span class="kw">operator</span>=(XxxDataFormatterIF <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true"></a></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true"></a>        <span class="bu">std::</span>string ToString(XxxData <span class="at">const</span>&amp; xxx_data) <span class="at">const</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true"></a>        {</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true"></a>            <span class="cf">return</span> header() + body(xxx_data) + footer();</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true"></a>        }</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true"></a></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true"></a>        <span class="bu">std::</span>string ToString(<span class="bu">std::</span>vector&lt;XxxData&gt; <span class="at">const</span>&amp; xxx_datas) <span class="at">const</span></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true"></a>        {</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true"></a>            <span class="kw">auto</span> ret = <span class="bu">std::</span>string{header()};</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true"></a></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; xxx_data : xxx_datas) {</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true"></a>                ret += body(xxx_data);</span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true"></a>            }</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true"></a></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true"></a>            <span class="cf">return</span> ret + footer();</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true"></a>        }</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true"></a></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; header() <span class="at">const</span>                      = <span class="dv">0</span>;</span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; footer() <span class="at">const</span>                      = <span class="dv">0</span>;</span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string        body(XxxData <span class="at">const</span>&amp; xxx_data) <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true"></a>    };</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true"></a></span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true"></a>    <span class="kw">class</span> XxxDataFormatterXml <span class="kw">final</span> : <span class="kw">public</span> XxxDataFormatterIF {</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true"></a>        XxxDataFormatterXml()                   = <span class="cf">default</span>;</span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true"></a>        <span class="kw">virtual</span> ~XxxDataFormatterXml() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true"></a></span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; header() <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true"></a>        {</span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true"></a>            <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> header</span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true"></a>                = <span class="bu">std::</span>string{<span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st"> ?&gt;</span><span class="sc">\n</span><span class="st">&lt;XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true"></a></span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true"></a>            <span class="cf">return</span> header;</span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true"></a>        }</span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true"></a></span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; footer() <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true"></a>        {</span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true"></a>            <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> footer = <span class="bu">std::</span>string{<span class="st">&quot;&lt;/XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true"></a></span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true"></a>            <span class="cf">return</span> footer;</span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true"></a>        }</span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true"></a></span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string body(XxxData <span class="at">const</span>&amp; xxx_data) <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true"></a>        {</span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true"></a>            <span class="kw">auto</span> content = <span class="bu">std::</span>string{<span class="st">&quot;&lt;Item&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true"></a></span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true"></a>            content += <span class="st">&quot;    &lt;XxxData a=</span><span class="sc">\&quot;</span><span class="st">&quot;</span> + <span class="bu">std::</span>to_string(xxx_data.a) + <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true"></a>            content += <span class="st">&quot;    &lt;XxxData b=</span><span class="sc">\&quot;</span><span class="st">&quot;</span> + <span class="bu">std::</span>to_string(xxx_data.b) + <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true"></a>            content += <span class="st">&quot;    &lt;XxxData c=</span><span class="sc">\&quot;</span><span class="st">&quot;</span> + <span class="bu">std::</span>to_string(xxx_data.c) + <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true"></a></span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true"></a>            <span class="cf">return</span> content + <span class="st">&quot;&lt;/Itemp&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true"></a>        }</span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true"></a>    };</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true"></a></span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true"></a>    <span class="kw">class</span> XxxDataFormatterCsv <span class="kw">final</span> : <span class="kw">public</span> XxxDataFormatterIF {</span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true"></a>        XxxDataFormatterCsv()                   = <span class="cf">default</span>;</span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true"></a>        <span class="kw">virtual</span> ~XxxDataFormatterCsv() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true"></a></span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; header() <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true"></a>        {</span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true"></a>            <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> header = <span class="bu">std::</span>string{<span class="st">&quot;a, b, c</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true"></a></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true"></a>            <span class="cf">return</span> header;</span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true"></a>        }</span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true"></a></span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; footer() <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true"></a>        {</span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true"></a>            <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> footer = <span class="bu">std::</span>string{};</span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true"></a></span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true"></a>            <span class="cf">return</span> footer;</span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true"></a>        }</span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true"></a></span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string body(XxxData <span class="at">const</span>&amp; xxx_data) <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true"></a>        {</span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>string{<span class="bu">std::</span>to_string(xxx_data.a) + <span class="st">&quot;, &quot;</span> + <span class="bu">std::</span>to_string(xxx_data.b) + <span class="st">&quot;, &quot;</span></span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true"></a>                               + <span class="bu">std::</span>to_string(xxx_data.b) + <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true"></a>        }</span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true"></a>    };</span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true"></a></span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true"></a>    TEST(DesignPatternA, TemplateMethod)</span>
<span id="cb68-114"><a href="#cb68-114" aria-hidden="true"></a>    {</span>
<span id="cb68-115"><a href="#cb68-115" aria-hidden="true"></a>        <span class="kw">auto</span> xml = XxxDataFormatterXml{};</span>
<span id="cb68-116"><a href="#cb68-116" aria-hidden="true"></a>        {</span>
<span id="cb68-117"><a href="#cb68-117" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_scalar = <span class="bu">std::</span>string{</span>
<span id="cb68-118"><a href="#cb68-118" aria-hidden="true"></a>                <span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st"> ?&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-119"><a href="#cb68-119" aria-hidden="true"></a>                <span class="st">&quot;&lt;XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-120"><a href="#cb68-120" aria-hidden="true"></a>                <span class="st">&quot;&lt;Item&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-121"><a href="#cb68-121" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData a=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-122"><a href="#cb68-122" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData b=</span><span class="sc">\&quot;</span><span class="st">100</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-123"><a href="#cb68-123" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData c=</span><span class="sc">\&quot;</span><span class="st">10</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-124"><a href="#cb68-124" aria-hidden="true"></a>                <span class="st">&quot;&lt;/Itemp&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-125"><a href="#cb68-125" aria-hidden="true"></a>                <span class="st">&quot;&lt;/XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-126"><a href="#cb68-126" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_scalar = xml.ToString({<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>});</span>
<span id="cb68-127"><a href="#cb68-127" aria-hidden="true"></a>            ASSERT_EQ(expect_scalar, actual_scalar);</span>
<span id="cb68-128"><a href="#cb68-128" aria-hidden="true"></a></span>
<span id="cb68-129"><a href="#cb68-129" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_array = <span class="bu">std::</span>string{</span>
<span id="cb68-130"><a href="#cb68-130" aria-hidden="true"></a>                <span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st"> ?&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-131"><a href="#cb68-131" aria-hidden="true"></a>                <span class="st">&quot;&lt;XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-132"><a href="#cb68-132" aria-hidden="true"></a>                <span class="st">&quot;&lt;Item&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-133"><a href="#cb68-133" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData a=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-134"><a href="#cb68-134" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData b=</span><span class="sc">\&quot;</span><span class="st">100</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-135"><a href="#cb68-135" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData c=</span><span class="sc">\&quot;</span><span class="st">10</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-136"><a href="#cb68-136" aria-hidden="true"></a>                <span class="st">&quot;&lt;/Itemp&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-137"><a href="#cb68-137" aria-hidden="true"></a>                <span class="st">&quot;&lt;Item&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-138"><a href="#cb68-138" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData a=</span><span class="sc">\&quot;</span><span class="st">2</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-139"><a href="#cb68-139" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData b=</span><span class="sc">\&quot;</span><span class="st">200</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-140"><a href="#cb68-140" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData c=</span><span class="sc">\&quot;</span><span class="st">20</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-141"><a href="#cb68-141" aria-hidden="true"></a>                <span class="st">&quot;&lt;/Itemp&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-142"><a href="#cb68-142" aria-hidden="true"></a>                <span class="st">&quot;&lt;/XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-143"><a href="#cb68-143" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_array = xml.ToString({{<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>}, {<span class="dv">2</span>, <span class="dv">200</span>, <span class="dv">20</span>}});</span>
<span id="cb68-144"><a href="#cb68-144" aria-hidden="true"></a>            ASSERT_EQ(expect_array, actual_array);</span>
<span id="cb68-145"><a href="#cb68-145" aria-hidden="true"></a>        }</span>
<span id="cb68-146"><a href="#cb68-146" aria-hidden="true"></a></span>
<span id="cb68-147"><a href="#cb68-147" aria-hidden="true"></a>        <span class="kw">auto</span> csv = XxxDataFormatterCsv{};</span>
<span id="cb68-148"><a href="#cb68-148" aria-hidden="true"></a>        {</span>
<span id="cb68-149"><a href="#cb68-149" aria-hidden="true"></a>            <span class="kw">auto</span> expect_scalar = <span class="bu">std::</span>string{</span>
<span id="cb68-150"><a href="#cb68-150" aria-hidden="true"></a>                <span class="st">&quot;a, b, c</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-151"><a href="#cb68-151" aria-hidden="true"></a>                <span class="st">&quot;1, 100, 100</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-152"><a href="#cb68-152" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_scalar = csv.ToString({<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>});</span>
<span id="cb68-153"><a href="#cb68-153" aria-hidden="true"></a>            ASSERT_EQ(expect_scalar, actual_scalar);</span>
<span id="cb68-154"><a href="#cb68-154" aria-hidden="true"></a></span>
<span id="cb68-155"><a href="#cb68-155" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_array = <span class="bu">std::</span>string{</span>
<span id="cb68-156"><a href="#cb68-156" aria-hidden="true"></a>                <span class="st">&quot;a, b, c</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-157"><a href="#cb68-157" aria-hidden="true"></a>                <span class="st">&quot;1, 100, 100</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb68-158"><a href="#cb68-158" aria-hidden="true"></a>                <span class="st">&quot;2, 200, 200</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb68-159"><a href="#cb68-159" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_array = csv.ToString({{<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>}, {<span class="dv">2</span>, <span class="dv">200</span>, <span class="dv">20</span>}});</span>
<span id="cb68-160"><a href="#cb68-160" aria-hidden="true"></a>            ASSERT_EQ(expect_array, actual_array);</span>
<span id="cb68-161"><a href="#cb68-161" aria-hidden="true"></a>        }</span>
<span id="cb68-162"><a href="#cb68-162" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_17">演習-Templateメソッド</a>へ戻る。</li>
</ul>
<h3 id="解答例-factory">解答例-Factory <a id="SS_20_9_18"></a></h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/factory_lib.h 43</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true"></a>    <span class="co">// 下記クラスXxxDataFormatterXml、XxxDataFormatterCsvはヘッダファイルで宣言・定義を行ったために</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true"></a>    <span class="co">// 他の.cppファイルから直接アクセスできてしまう。</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true"></a>    <span class="co">// Factoryパターンを用いて、XxxDataFormatterXml、XxxDataFormatterCsvを他の.cppファイルから</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true"></a>    <span class="co">// 直接アクセスできないようにせよ。</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true"></a>    <span class="co">// 一般的には、Factory関数は</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true"></a>    <span class="co">//      std::unique_ptr&lt;XxxDataFormatterIF&gt; XxxDataFormatterFactory(XxxDataFormatterType type);</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true"></a>    <span class="co">// のような形状になるが、今回の例では生成オブジェクトの提供するサービスがconst関数のみであるため、</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true"></a>    <span class="co">// constなunique_ptrを返している。</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true"></a>    <span class="co">// また、さらにこの考え方を進め、newしてオブジェクトの生成をする必要はないことに気づけば、</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true"></a>    <span class="co">// XxxDataFormatterFactory2のようにconstリファレンスを返すこともできる。</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true"></a>    <span class="kw">enum</span> <span class="kw">class</span> XxxDataFormatterType { Xml, Csv };</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true"></a></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true"></a>    <span class="bu">std::</span>unique_ptr&lt;XxxDataFormatterIF <span class="at">const</span>&gt; XxxDataFormatterFactory(XxxDataFormatterType type);</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true"></a>    XxxDataFormatterIF <span class="at">const</span>&amp; XxxDataFormatterFactory2(XxxDataFormatterType type) <span class="kw">noexcept</span>;</span></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/factory_lib.cpp 77</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true"></a>    <span class="bu">std::</span>unique_ptr&lt;XxxDataFormatterIF <span class="at">const</span>&gt; XxxDataFormatterFactory(XxxDataFormatterType type)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true"></a>    {</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true"></a>        <span class="cf">switch</span> (type) {</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true"></a>        <span class="cf">case</span> XxxDataFormatterType::Xml:</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;XxxDataFormatterXml&gt;();</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true"></a>        <span class="cf">case</span> XxxDataFormatterType::Csv:</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>make_unique&lt;XxxDataFormatterCsv&gt;();</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true"></a>        <span class="cf">default</span>:</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true"></a>            <span class="ot">assert</span>(<span class="st">&quot;unknown type&quot;</span>);</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>unique_ptr&lt;XxxDataFormatterIF <span class="at">const</span>&gt;{};</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true"></a>        }</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true"></a>    }</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true"></a></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true"></a>    XxxDataFormatterIF <span class="at">const</span>&amp; XxxDataFormatterFactory2(XxxDataFormatterType type) <span class="kw">noexcept</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true"></a>    {</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> xml = XxxDataFormatterXml{};</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> csv = XxxDataFormatterCsv{};</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true"></a>        <span class="cf">switch</span> (type) {</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true"></a>        <span class="cf">case</span> XxxDataFormatterType::Xml:</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true"></a>            <span class="cf">return</span> xml;</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true"></a>        <span class="cf">case</span> XxxDataFormatterType::Csv:</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true"></a>            <span class="cf">return</span> csv;</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true"></a>        <span class="cf">default</span>:</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true"></a>            <span class="ot">assert</span>(<span class="st">&quot;unknown type&quot;</span>);</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true"></a>            <span class="cf">return</span> csv;</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true"></a>        }</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/factory.cpp 9</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true"></a>    TEST(DesignPatternA, Factory)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true"></a>    {</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true"></a>        <span class="kw">auto</span> xml = XxxDataFormatterFactory(XxxDataFormatterType::Xml);</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true"></a>        {</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_scalar = <span class="bu">std::</span>string{</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true"></a>                <span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st"> ?&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true"></a>                <span class="st">&quot;&lt;XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true"></a>                <span class="st">&quot;&lt;Item&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData a=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData b=</span><span class="sc">\&quot;</span><span class="st">100</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData c=</span><span class="sc">\&quot;</span><span class="st">10</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true"></a>                <span class="st">&quot;&lt;/Itemp&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true"></a>                <span class="st">&quot;&lt;/XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_scalar = xml-&gt;ToString({<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>});</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true"></a></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true"></a>            ASSERT_EQ(expect_scalar, actual_scalar);</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true"></a>        }</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true"></a></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true"></a>        <span class="kw">auto</span> csv = XxxDataFormatterFactory(XxxDataFormatterType::Csv);</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true"></a>        {</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_array = <span class="bu">std::</span>string{</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true"></a>                <span class="st">&quot;a, b, c</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true"></a>                <span class="st">&quot;1, 100, 100</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true"></a>                <span class="st">&quot;2, 200, 200</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_array = csv-&gt;ToString({{<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>}, {<span class="dv">2</span>, <span class="dv">200</span>, <span class="dv">20</span>}});</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true"></a></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true"></a>            ASSERT_EQ(expect_array, actual_array);</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true"></a>        }</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true"></a>    }</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true"></a></span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true"></a>    TEST(DesignPatternA, Factory2)</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true"></a>    {</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; xml = XxxDataFormatterFactory2(XxxDataFormatterType::Xml);</span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true"></a>        {</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_scalar = <span class="bu">std::</span>string{</span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true"></a>                <span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st"> ?&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true"></a>                <span class="st">&quot;&lt;XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true"></a>                <span class="st">&quot;&lt;Item&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData a=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData b=</span><span class="sc">\&quot;</span><span class="st">100</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData c=</span><span class="sc">\&quot;</span><span class="st">10</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true"></a>                <span class="st">&quot;&lt;/Itemp&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true"></a>                <span class="st">&quot;&lt;/XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_scalar = xml.ToString({<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>});</span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true"></a></span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true"></a>            ASSERT_EQ(expect_scalar, actual_scalar);</span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true"></a>        }</span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true"></a></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; csv = XxxDataFormatterFactory2(XxxDataFormatterType::Csv);</span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true"></a>        {</span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_array = <span class="bu">std::</span>string{</span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true"></a>                <span class="st">&quot;a, b, c</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true"></a>                <span class="st">&quot;1, 100, 100</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true"></a>                <span class="st">&quot;2, 200, 200</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_array = csv.ToString({{<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>}, {<span class="dv">2</span>, <span class="dv">200</span>, <span class="dv">20</span>}});</span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true"></a></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true"></a>            ASSERT_EQ(expect_array, actual_array);</span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true"></a>        }</span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_18">演習-Factory</a>へ戻る。</li>
</ul>
<h3 id="解答例-named-constructor">解答例-Named Constructor <a id="SS_20_9_19"></a></h3>
<div class="sourceCode" id="cb72"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/named_constructor_lib.h 14</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true"></a>    <span class="co">// 下記関数XxxDataFormatterFactoryはインターフェースクラスXxxDataFormatterIFのファクトリ関数</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true"></a>    <span class="co">// である。これをnamed constructorパターンで実装しなおせ。</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true"></a>    <span class="co">// * XxxDataFormatterIFの特性から、Named ConstructorはXxxDataFormatterIFのconstリファレンスを返す</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true"></a>    <span class="co">//   仕様としたが、戻すオブジェクトの特性より戻り値型は以下のようにすべき。</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true"></a>    <span class="co">//      const/非const | 静的/動的 | 戻す型</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true"></a>    <span class="co">//      --------------+-----------+-----------------------------------</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true"></a>    <span class="co">//      const         | 静的      | XxxDataFormatterIFのconstリファレンス</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true"></a>    <span class="co">//                    | 動的      | std::unique_ptr&lt;const XxxDataFormatterIF&gt;</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true"></a>    <span class="co">//      非const       | 静的      | XxxDataFormatterIFのリファレンス</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true"></a>    <span class="co">//                    | 動的      | std::unique_ptr&lt;XxxDataFormatterIF&gt;</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true"></a>    <span class="co">// * FactoryとNamed Constructorはほぼ等価であり、どちらを使っても派生型の隠蔽という効果は等しい。</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true"></a>    <span class="co">// * 筆者は、今回の例のように静的オブジェクトを返す場合、Named Constructor、</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true"></a>    <span class="co">//   動的オブジェクトを返す場合、Factoryを使用している。</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true"></a></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true"></a>    <span class="kw">class</span> XxxDataFormatterIF {</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true"></a>        XxxDataFormatterIF() = <span class="cf">default</span>;</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true"></a>        <span class="at">static</span> XxxDataFormatterIF <span class="at">const</span>&amp; Xml() <span class="kw">noexcept</span>;</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true"></a>        <span class="at">static</span> XxxDataFormatterIF <span class="at">const</span>&amp; Csv() <span class="kw">noexcept</span>;</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true"></a>        <span class="at">static</span> XxxDataFormatterIF <span class="at">const</span>&amp; Table() <span class="kw">noexcept</span>;</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true"></a></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true"></a>        <span class="kw">virtual</span> ~XxxDataFormatterIF()                            = <span class="cf">default</span>;</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true"></a>        XxxDataFormatterIF(XxxDataFormatterIF <span class="at">const</span>&amp;)            = <span class="kw">delete</span>;</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true"></a>        XxxDataFormatterIF&amp; <span class="kw">operator</span>=(XxxDataFormatterIF <span class="at">const</span>&amp;) = <span class="kw">delete</span>;</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true"></a></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true"></a>        <span class="bu">std::</span>string ToString(XxxData <span class="at">const</span>&amp; xxx_data) <span class="at">const</span></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true"></a>        {</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true"></a>            <span class="cf">return</span> header() + body(xxx_data) + footer();</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true"></a>        }</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true"></a></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true"></a>        <span class="bu">std::</span>string ToString(<span class="bu">std::</span>vector&lt;XxxData&gt; <span class="at">const</span>&amp; xxx_datas) <span class="at">const</span></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true"></a>        {</span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true"></a>            <span class="kw">auto</span> ret = header();</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true"></a></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; xxx_data : xxx_datas) {</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true"></a>                ret += body(xxx_data);</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true"></a>            }</span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true"></a></span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true"></a>            <span class="cf">return</span> ret + footer();</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true"></a>        }</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true"></a></span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; header() <span class="at">const</span>                      = <span class="dv">0</span>;</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string <span class="at">const</span>&amp; footer() <span class="at">const</span>                      = <span class="dv">0</span>;</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string        body(XxxData <span class="at">const</span>&amp; xxx_data) <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true"></a>    };</span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/named_constructor_lib.cpp 114</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true"></a>    XxxDataFormatterIF <span class="at">const</span>&amp; XxxDataFormatterIF::Xml() <span class="kw">noexcept</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true"></a>    {</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> inst = XxxDataFormatterXml{};</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true"></a>        <span class="cf">return</span> inst;</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true"></a>    }</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true"></a>    XxxDataFormatterIF <span class="at">const</span>&amp; XxxDataFormatterIF::Csv() <span class="kw">noexcept</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true"></a>    {</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> inst = XxxDataFormatterCsv{};</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true"></a>        <span class="cf">return</span> inst;</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true"></a>    }</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true"></a></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true"></a>    XxxDataFormatterIF <span class="at">const</span>&amp; XxxDataFormatterIF::Table() <span class="kw">noexcept</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true"></a>    {</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> inst = XxxDataFormatterTable{};</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true"></a>        <span class="cf">return</span> inst;</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb74"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/named_constructor.cpp 9</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true"></a>    TEST(DesignPatternA, NamedConstructor)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true"></a>    {</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; xml = XxxDataFormatterIF::Xml();</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true"></a>        {</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_scalar = <span class="bu">std::</span>string{</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true"></a>                <span class="st">&quot;&lt;?xml version=</span><span class="sc">\&quot;</span><span class="st">1.0</span><span class="sc">\&quot;</span><span class="st"> encoding=</span><span class="sc">\&quot;</span><span class="st">UTF-8</span><span class="sc">\&quot;</span><span class="st"> ?&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true"></a>                <span class="st">&quot;&lt;XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true"></a>                <span class="st">&quot;&lt;Item&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData a=</span><span class="sc">\&quot;</span><span class="st">1</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData b=</span><span class="sc">\&quot;</span><span class="st">100</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true"></a>                <span class="st">&quot;    &lt;XxxData c=</span><span class="sc">\&quot;</span><span class="st">10</span><span class="sc">\&quot;</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true"></a>                <span class="st">&quot;&lt;/Itemp&gt;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true"></a>                <span class="st">&quot;&lt;/XxxDataFormatterXml&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_scalar = xml.ToString({<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>});</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true"></a></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true"></a>            ASSERT_EQ(expect_scalar, actual_scalar);</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true"></a>        }</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true"></a></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; csv = XxxDataFormatterIF::Csv();</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true"></a>        {</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_array = <span class="bu">std::</span>string{</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true"></a>                <span class="st">&quot;a, b, c</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true"></a>                <span class="st">&quot;1, 100, 100</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true"></a>                <span class="st">&quot;2, 200, 200</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_array = csv.ToString({{<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">10</span>}, {<span class="dv">2</span>, <span class="dv">200</span>, <span class="dv">20</span>}});</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true"></a></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true"></a>            ASSERT_EQ(expect_array, actual_array);</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true"></a>        }</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true"></a></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>&amp; table = XxxDataFormatterIF::Table();</span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true"></a>        {</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> expect_array = <span class="bu">std::</span>string{</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true"></a>                <span class="st">&quot;+--------|--------|--------+</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true"></a>                <span class="st">&quot;| a      | b      | c      |</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true"></a>                <span class="st">&quot;+--------|--------|--------+</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true"></a>                <span class="st">&quot;| 3      | 300    | 30     |</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true"></a>                <span class="st">&quot;+--------|--------|--------+</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true"></a>                <span class="st">&quot;| 4      | 400    | 40     |</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true"></a>                <span class="st">&quot;+--------|--------|--------+</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true"></a>            <span class="kw">auto</span> <span class="at">const</span> actual_array = table.ToString({{<span class="dv">3</span>, <span class="dv">300</span>, <span class="dv">30</span>}, {<span class="dv">4</span>, <span class="dv">400</span>, <span class="dv">40</span>}});</span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true"></a></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true"></a>            ASSERT_EQ(expect_array, actual_array);</span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true"></a>        }</span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_19">演習-Named Constructor</a>へ戻る。</li>
</ul>
<h3 id="解答例-proxy">解答例-Proxy <a id="SS_20_9_20"></a></h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/proxy.cpp 8</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true"></a>    <span class="co">// 下記クラスLsDirのFileListはlsコマンドをpopenにより実行し、その戻り値をstd::stringで返す。</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true"></a>    <span class="co">// popenはコストの高いコールなので、パフォーマンスを上げるためにlsの戻り値をキャッシュしたいが、</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true"></a>    <span class="co">// 現行のLsDirも必要である。</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true"></a>    <span class="co">// Proxyパターンを使い、この問題に対処するためのLsDirCachedを作れ。</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true"></a>    <span class="pp">#define USE_ACCURATE_PROXY</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true"></a>    <span class="pp">#ifdef USE_ACCURATE_PROXY  </span><span class="co">// 本来#ifdefは問題を発生させるため使うべきではないが、例なので。</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true"></a>    <span class="kw">class</span> LsDirIF {</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true"></a>        LsDirIF()          = <span class="cf">default</span>;</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true"></a>        <span class="kw">virtual</span> ~LsDirIF() = <span class="cf">default</span>;</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true"></a></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true"></a>        <span class="dt">void</span>               SetArgs(<span class="bu">std::</span>string_view args) { <span class="va">args_</span> = args; }</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetArgs() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">args_</span>; }</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>  FileList() <span class="at">const</span> { <span class="cf">return</span> file_list(); }</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true"></a></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true"></a>        <span class="bu">std::</span>string         <span class="va">args_</span>{};</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string file_list() <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true"></a>    };</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true"></a>    <span class="kw">class</span> LsDir : <span class="kw">public</span> LsDirIF {</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true"></a>        LsDir()          = <span class="cf">default</span>;</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true"></a>        <span class="kw">virtual</span> ~LsDir() = <span class="cf">default</span>;</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true"></a></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string file_list() <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true"></a>        {</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true"></a>            <span class="kw">auto</span> cmd      = <span class="bu">std::</span>string{<span class="st">&quot;ls &quot;</span>} + GetArgs();</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true"></a>            <span class="kw">auto</span> to_close = [](<span class="dt">FILE</span>* f) { fclose(f); };</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true"></a>            <span class="kw">auto</span> stream = <span class="bu">std::</span>unique_ptr&lt;<span class="dt">FILE</span>, <span class="kw">decltype</span>(to_close)&gt;{popen(cmd.c_str(), <span class="st">&quot;r&quot;</span>), to_close};</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true"></a></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true"></a>            <span class="kw">auto</span> files = <span class="bu">std::</span>string{};</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true"></a>            <span class="dt">char</span> buff[<span class="dv">256</span>];</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true"></a></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true"></a>            <span class="cf">while</span> (fgets(buff, <span class="kw">sizeof</span>(buff) - <span class="dv">1</span>, stream.get()) != NULL) {</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true"></a>                files += buff;</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true"></a>            }</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true"></a></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true"></a>            <span class="cf">return</span> files;</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true"></a>        }</span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true"></a>    };</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true"></a></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true"></a>    <span class="kw">class</span> LsDirCached : <span class="kw">public</span> LsDirIF {</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true"></a>        LsDirCached()                   = <span class="cf">default</span>;</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true"></a>        <span class="kw">virtual</span> ~LsDirCached() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true"></a></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true"></a>        <span class="at">mutable</span> <span class="bu">std::</span>string <span class="va">latest_ls_</span>{};</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true"></a>        <span class="at">mutable</span> LsDir       <span class="va">ld_no_cache_</span>{};</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true"></a></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string file_list() <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true"></a>        {</span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true"></a>            <span class="cf">if</span> (GetArgs() == <span class="va">ld_no_cache_</span>.GetArgs()) {</span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true"></a>                <span class="cf">return</span> <span class="va">latest_ls_</span>;</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true"></a>            }</span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true"></a></span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true"></a>            <span class="va">ld_no_cache_</span>.SetArgs(GetArgs());</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true"></a>            <span class="va">latest_ls_</span> = <span class="va">ld_no_cache_</span>.FileList();</span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true"></a></span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">latest_ls_</span>;</span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true"></a>        }</span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true"></a>    };</span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true"></a>    <span class="pp">#else  </span><span class="co">// not USE_ACCURATE_PROXY</span></span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true"></a>    <span class="kw">class</span> LsDir {</span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true"></a>        LsDir()          = <span class="cf">default</span>;</span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true"></a>        <span class="kw">virtual</span> ~LsDir() = <span class="cf">default</span>;</span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true"></a></span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true"></a>        <span class="dt">void</span>               SetArgs(<span class="bu">std::</span>string_view args) { <span class="va">args_</span> = args; }</span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; GetArgs() <span class="at">const</span> { <span class="cf">return</span> <span class="va">args_</span>; }</span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>  FileList() <span class="at">const</span> { <span class="cf">return</span> file_list(); }</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true"></a></span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true"></a>    <span class="kw">protected</span>:</span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string file_list() <span class="at">const</span></span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true"></a>        {</span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true"></a>            <span class="kw">auto</span> cmd      = <span class="bu">std::</span>string{<span class="st">&quot;ls &quot;</span>} + GetArgs();</span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true"></a>            <span class="kw">auto</span> to_close = [](<span class="dt">FILE</span>* f) { fclose(f); };</span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true"></a>            <span class="kw">auto</span> stream = <span class="bu">std::</span>unique_ptr&lt;<span class="dt">FILE</span>, <span class="kw">decltype</span>(to_close)&gt;{popen(cmd.c_str(), <span class="st">&quot;r&quot;</span>), to_close};</span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true"></a></span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true"></a>            <span class="kw">auto</span> files = <span class="bu">std::</span>string{};</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true"></a>            <span class="dt">char</span> buff[<span class="dv">256</span>];</span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true"></a></span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true"></a>            <span class="cf">while</span> (fgets(buff, <span class="kw">sizeof</span>(buff) - <span class="dv">1</span>, stream.get()) != NULL) {</span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true"></a>                files += buff;</span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true"></a>            }</span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true"></a></span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true"></a>            <span class="cf">return</span> files;</span>
<span id="cb75-93"><a href="#cb75-93" aria-hidden="true"></a>        }</span>
<span id="cb75-94"><a href="#cb75-94" aria-hidden="true"></a></span>
<span id="cb75-95"><a href="#cb75-95" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb75-96"><a href="#cb75-96" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="va">args_</span>{};</span>
<span id="cb75-97"><a href="#cb75-97" aria-hidden="true"></a>    };</span>
<span id="cb75-98"><a href="#cb75-98" aria-hidden="true"></a></span>
<span id="cb75-99"><a href="#cb75-99" aria-hidden="true"></a>    <span class="kw">class</span> LsDirCached : <span class="kw">public</span> LsDir {</span>
<span id="cb75-100"><a href="#cb75-100" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb75-101"><a href="#cb75-101" aria-hidden="true"></a>        LsDirCached()                   = <span class="cf">default</span>;</span>
<span id="cb75-102"><a href="#cb75-102" aria-hidden="true"></a>        <span class="kw">virtual</span> ~LsDirCached() <span class="kw">override</span> = <span class="cf">default</span>;</span>
<span id="cb75-103"><a href="#cb75-103" aria-hidden="true"></a></span>
<span id="cb75-104"><a href="#cb75-104" aria-hidden="true"></a>    <span class="kw">protected</span>:</span>
<span id="cb75-105"><a href="#cb75-105" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string file_list() <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb75-106"><a href="#cb75-106" aria-hidden="true"></a>        {</span>
<span id="cb75-107"><a href="#cb75-107" aria-hidden="true"></a>            <span class="cf">if</span> (GetArgs() == <span class="va">latest_args_</span>) {</span>
<span id="cb75-108"><a href="#cb75-108" aria-hidden="true"></a>                <span class="cf">return</span> <span class="va">latest_ls_</span>;</span>
<span id="cb75-109"><a href="#cb75-109" aria-hidden="true"></a>            }</span>
<span id="cb75-110"><a href="#cb75-110" aria-hidden="true"></a></span>
<span id="cb75-111"><a href="#cb75-111" aria-hidden="true"></a>            <span class="va">latest_args_</span> = GetArgs();</span>
<span id="cb75-112"><a href="#cb75-112" aria-hidden="true"></a>            <span class="va">latest_ls_</span>   = LsDir::file_list();</span>
<span id="cb75-113"><a href="#cb75-113" aria-hidden="true"></a></span>
<span id="cb75-114"><a href="#cb75-114" aria-hidden="true"></a>            <span class="cf">return</span> <span class="va">latest_ls_</span>;</span>
<span id="cb75-115"><a href="#cb75-115" aria-hidden="true"></a>        }</span>
<span id="cb75-116"><a href="#cb75-116" aria-hidden="true"></a></span>
<span id="cb75-117"><a href="#cb75-117" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb75-118"><a href="#cb75-118" aria-hidden="true"></a>        <span class="at">mutable</span> <span class="bu">std::</span>string <span class="va">latest_ls_</span>{};</span>
<span id="cb75-119"><a href="#cb75-119" aria-hidden="true"></a>        <span class="at">mutable</span> <span class="bu">std::</span>string <span class="va">latest_args_</span>{};</span>
<span id="cb75-120"><a href="#cb75-120" aria-hidden="true"></a>    };</span>
<span id="cb75-121"><a href="#cb75-121" aria-hidden="true"></a>    <span class="pp">#endif</span></span>
<span id="cb75-122"><a href="#cb75-122" aria-hidden="true"></a></span>
<span id="cb75-123"><a href="#cb75-123" aria-hidden="true"></a>    TEST(DesignPatternA, Proxy)</span>
<span id="cb75-124"><a href="#cb75-124" aria-hidden="true"></a>    {</span>
<span id="cb75-125"><a href="#cb75-125" aria-hidden="true"></a>        <span class="kw">auto</span> ld = LsDir{};</span>
<span id="cb75-126"><a href="#cb75-126" aria-hidden="true"></a></span>
<span id="cb75-127"><a href="#cb75-127" aria-hidden="true"></a>        {</span>
<span id="cb75-128"><a href="#cb75-128" aria-hidden="true"></a>            ld.SetArgs(<span class="st">&quot;../ut_data/&quot;</span>);</span>
<span id="cb75-129"><a href="#cb75-129" aria-hidden="true"></a></span>
<span id="cb75-130"><a href="#cb75-130" aria-hidden="true"></a>            <span class="kw">auto</span> exp = <span class="bu">std::</span>string{<span class="st">&quot;a.cpp</span><span class="sc">\n</span><span class="st">a.h</span><span class="sc">\n</span><span class="st">abc.cpp</span><span class="sc">\n</span><span class="st">abc.h</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">efghij.cpp</span><span class="sc">\n</span><span class="st">efghij.h</span><span class="sc">\n</span><span class="st">lib</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb75-131"><a href="#cb75-131" aria-hidden="true"></a>            <span class="kw">auto</span> act = ld.FileList();</span>
<span id="cb75-132"><a href="#cb75-132" aria-hidden="true"></a></span>
<span id="cb75-133"><a href="#cb75-133" aria-hidden="true"></a>            ASSERT_EQ(exp, act);</span>
<span id="cb75-134"><a href="#cb75-134" aria-hidden="true"></a>            ASSERT_EQ(act, ld.FileList());</span>
<span id="cb75-135"><a href="#cb75-135" aria-hidden="true"></a>        }</span>
<span id="cb75-136"><a href="#cb75-136" aria-hidden="true"></a>        {</span>
<span id="cb75-137"><a href="#cb75-137" aria-hidden="true"></a>            ld.SetArgs(<span class="st">&quot;../ut_data/lib/&quot;</span>);</span>
<span id="cb75-138"><a href="#cb75-138" aria-hidden="true"></a></span>
<span id="cb75-139"><a href="#cb75-139" aria-hidden="true"></a>            <span class="kw">auto</span> exp = <span class="bu">std::</span>string{<span class="st">&quot;lib.cpp</span><span class="sc">\n</span><span class="st">lib.h</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb75-140"><a href="#cb75-140" aria-hidden="true"></a>            <span class="kw">auto</span> act = ld.FileList();</span>
<span id="cb75-141"><a href="#cb75-141" aria-hidden="true"></a></span>
<span id="cb75-142"><a href="#cb75-142" aria-hidden="true"></a>            ASSERT_EQ(exp, act);</span>
<span id="cb75-143"><a href="#cb75-143" aria-hidden="true"></a>            ASSERT_EQ(act, ld.FileList());</span>
<span id="cb75-144"><a href="#cb75-144" aria-hidden="true"></a>        }</span>
<span id="cb75-145"><a href="#cb75-145" aria-hidden="true"></a>    }</span>
<span id="cb75-146"><a href="#cb75-146" aria-hidden="true"></a></span>
<span id="cb75-147"><a href="#cb75-147" aria-hidden="true"></a>    TEST(DesignPatternA, Proxy2)</span>
<span id="cb75-148"><a href="#cb75-148" aria-hidden="true"></a>    {</span>
<span id="cb75-149"><a href="#cb75-149" aria-hidden="true"></a>        <span class="kw">auto</span> ld = LsDirCached{};</span>
<span id="cb75-150"><a href="#cb75-150" aria-hidden="true"></a></span>
<span id="cb75-151"><a href="#cb75-151" aria-hidden="true"></a>        {</span>
<span id="cb75-152"><a href="#cb75-152" aria-hidden="true"></a>            ld.SetArgs(<span class="st">&quot;../ut_data/&quot;</span>);</span>
<span id="cb75-153"><a href="#cb75-153" aria-hidden="true"></a></span>
<span id="cb75-154"><a href="#cb75-154" aria-hidden="true"></a>            <span class="kw">auto</span> exp = <span class="bu">std::</span>string{<span class="st">&quot;a.cpp</span><span class="sc">\n</span><span class="st">a.h</span><span class="sc">\n</span><span class="st">abc.cpp</span><span class="sc">\n</span><span class="st">abc.h</span><span class="sc">\n</span><span class="st">d</span><span class="sc">\n</span><span class="st">efghij.cpp</span><span class="sc">\n</span><span class="st">efghij.h</span><span class="sc">\n</span><span class="st">lib</span><span class="sc">\n</span><span class="st">o</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb75-155"><a href="#cb75-155" aria-hidden="true"></a>            <span class="kw">auto</span> act = ld.FileList();</span>
<span id="cb75-156"><a href="#cb75-156" aria-hidden="true"></a></span>
<span id="cb75-157"><a href="#cb75-157" aria-hidden="true"></a>            ASSERT_EQ(exp, act);</span>
<span id="cb75-158"><a href="#cb75-158" aria-hidden="true"></a>            ASSERT_EQ(act, ld.FileList());</span>
<span id="cb75-159"><a href="#cb75-159" aria-hidden="true"></a>        }</span>
<span id="cb75-160"><a href="#cb75-160" aria-hidden="true"></a>        {</span>
<span id="cb75-161"><a href="#cb75-161" aria-hidden="true"></a>            ld.SetArgs(<span class="st">&quot;../ut_data/lib/&quot;</span>);</span>
<span id="cb75-162"><a href="#cb75-162" aria-hidden="true"></a></span>
<span id="cb75-163"><a href="#cb75-163" aria-hidden="true"></a>            <span class="kw">auto</span> exp = <span class="bu">std::</span>string{<span class="st">&quot;lib.cpp</span><span class="sc">\n</span><span class="st">lib.h</span><span class="sc">\n</span><span class="st">&quot;</span>};</span>
<span id="cb75-164"><a href="#cb75-164" aria-hidden="true"></a>            <span class="kw">auto</span> act = ld.FileList();</span>
<span id="cb75-165"><a href="#cb75-165" aria-hidden="true"></a></span>
<span id="cb75-166"><a href="#cb75-166" aria-hidden="true"></a>            ASSERT_EQ(exp, act);</span>
<span id="cb75-167"><a href="#cb75-167" aria-hidden="true"></a>            ASSERT_EQ(act, ld.FileList());</span>
<span id="cb75-168"><a href="#cb75-168" aria-hidden="true"></a>        }</span>
<span id="cb75-169"><a href="#cb75-169" aria-hidden="true"></a>    }</span>
<span id="cb75-170"><a href="#cb75-170" aria-hidden="true"></a></span>
<span id="cb75-171"><a href="#cb75-171" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> LSDIR&gt;</span>
<span id="cb75-172"><a href="#cb75-172" aria-hidden="true"></a>    <span class="dt">uint32_t</span> measure_performance(LSDIR <span class="at">const</span>&amp; ls_dir, <span class="dt">uint32_t</span> count) <span class="kw">noexcept</span></span>
<span id="cb75-173"><a href="#cb75-173" aria-hidden="true"></a>    {</span>
<span id="cb75-174"><a href="#cb75-174" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> start = <span class="bu">std::</span>chrono<span class="bu">::</span>system_clock<span class="bu">::</span>now();</span>
<span id="cb75-175"><a href="#cb75-175" aria-hidden="true"></a>        {</span>
<span id="cb75-176"><a href="#cb75-176" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">decltype</span>(count) i = <span class="dv">0</span>; i &lt; count; ++i) {</span>
<span id="cb75-177"><a href="#cb75-177" aria-hidden="true"></a>                <span class="at">volatile</span> <span class="kw">auto</span> <span class="at">const</span> list = ls_dir.FileList();</span>
<span id="cb75-178"><a href="#cb75-178" aria-hidden="true"></a>            }</span>
<span id="cb75-179"><a href="#cb75-179" aria-hidden="true"></a>        }</span>
<span id="cb75-180"><a href="#cb75-180" aria-hidden="true"></a></span>
<span id="cb75-181"><a href="#cb75-181" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> stop = <span class="bu">std::</span>chrono<span class="bu">::</span>system_clock<span class="bu">::</span>now();</span>
<span id="cb75-182"><a href="#cb75-182" aria-hidden="true"></a></span>
<span id="cb75-183"><a href="#cb75-183" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">std::</span>chrono<span class="bu">::</span>duration_cast&lt;<span class="bu">std::</span>chrono<span class="bu">::</span>microseconds&gt;(stop - start).count();</span>
<span id="cb75-184"><a href="#cb75-184" aria-hidden="true"></a>    }</span>
<span id="cb75-185"><a href="#cb75-185" aria-hidden="true"></a></span>
<span id="cb75-186"><a href="#cb75-186" aria-hidden="true"></a>    TEST(DesignPatternA, ProxyPerformance)</span>
<span id="cb75-187"><a href="#cb75-187" aria-hidden="true"></a>    {</span>
<span id="cb75-188"><a href="#cb75-188" aria-hidden="true"></a>        <span class="kw">auto</span> ld               = LsDir{};</span>
<span id="cb75-189"><a href="#cb75-189" aria-hidden="true"></a>        <span class="kw">auto</span> elapsed_no_cache = <span class="dt">uint32_t</span>{measure_performance(ld, <span class="dv">10</span>)};</span>
<span id="cb75-190"><a href="#cb75-190" aria-hidden="true"></a>        <span class="bu">std::</span>cout &lt;&lt; <span class="st">&quot;No Cache Elapse:&quot;</span> &lt;&lt; elapsed_no_cache &lt;&lt; <span class="st">&quot; usec&quot;</span> &lt;&lt; <span class="bu">std::</span>endl;</span>
<span id="cb75-191"><a href="#cb75-191" aria-hidden="true"></a></span>
<span id="cb75-192"><a href="#cb75-192" aria-hidden="true"></a>        <span class="kw">auto</span> ldc           = LsDirCached{};</span>
<span id="cb75-193"><a href="#cb75-193" aria-hidden="true"></a>        <span class="kw">auto</span> elapsed_cache = <span class="dt">uint32_t</span>{measure_performance(ldc, <span class="dv">10</span>)};</span>
<span id="cb75-194"><a href="#cb75-194" aria-hidden="true"></a>        <span class="bu">std::</span>cout &lt;&lt; <span class="st">&quot;Cached Elapse:&quot;</span> &lt;&lt; elapsed_cache &lt;&lt; <span class="st">&quot; usec&quot;</span> &lt;&lt; <span class="bu">std::</span>endl;</span>
<span id="cb75-195"><a href="#cb75-195" aria-hidden="true"></a></span>
<span id="cb75-196"><a href="#cb75-196" aria-hidden="true"></a>        ASSERT_LT(<span class="dv">30</span> * elapsed_cache, elapsed_no_cache);  <span class="co">// 30倍に理由はない。</span></span>
<span id="cb75-197"><a href="#cb75-197" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_20">演習-Proxy</a>へ戻る。</li>
</ul>
<h3 id="解答例-strategy">解答例-Strategy <a id="SS_20_9_21"></a></h3>
<div class="sourceCode" id="cb76"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/strategy.cpp 12</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true"></a>    <span class="co">// 下記find_filesは醜悪であるだけでなく、拡張性もない。</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true"></a>    <span class="co">// Strategyパターンを用い、この問題に対処せよ。</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true"></a>    <span class="kw">using</span> FindCondition = <span class="bu">std::</span>function&lt;<span class="dt">bool</span>(<span class="bu">std::</span>filesystem<span class="bu">::</span>path <span class="at">const</span>&amp;)&gt;;</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true"></a>    <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt; find_files(<span class="bu">std::</span>string <span class="at">const</span>&amp; path, FindCondition condition)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true"></a>    {</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true"></a>        <span class="kw">auto</span> files = <span class="bu">std::</span>vector&lt;fs::path&gt;{};</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true"></a>        <span class="co">// recursive_directory_iteratorはファイルシステム依存するため、その依存を排除する他の処理</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true"></a>        <span class="bu">std::</span>copy(fs::recursive_directory_iterator{path}, fs::recursive_directory_iterator{},</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true"></a>                  <span class="bu">std::</span>back_inserter(files));</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true"></a>        <span class="bu">std::</span>sort(files.begin(), files.end());</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true"></a></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true"></a>        <span class="kw">auto</span> ret = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{};</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true"></a></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true"></a>        <span class="bu">std::</span>for_each(files.cbegin(), files.cend(), [&amp;](fs::path <span class="at">const</span>&amp; p) {</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true"></a>            <span class="cf">if</span> (condition(p)) {</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true"></a>                ret.emplace_back(p.generic_string());</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true"></a>            }</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true"></a>        });</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true"></a>    }</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true"></a></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true"></a>    <span class="dt">bool</span> is_cpp_file(<span class="bu">std::</span>filesystem<span class="bu">::</span>path <span class="at">const</span>&amp; path)</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true"></a>    {</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span>        filename = path.filename().generic_string();</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">auto</span> <span class="at">const</span> cpp_file = <span class="bu">std::</span>string{<span class="st">&quot;.cpp&quot;</span>};</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true"></a></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true"></a>        <span class="cf">return</span> (filename.length() &gt; cpp_file.length())</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true"></a>               &amp;&amp; (filename.substr(filename.length() - cpp_file.length()) == cpp_file);</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true"></a>    }</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true"></a></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true"></a>    TEST(DesignPatternA, Strategy)</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true"></a>    {</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true"></a>        <span class="kw">auto</span> sort = [](<span class="kw">auto</span>&amp;&amp; v) {</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true"></a>            <span class="bu">std::</span>sort(v.begin(), v.end());</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true"></a>            <span class="cf">return</span> v;</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true"></a>        };</span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true"></a></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true"></a>        {</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true"></a>            <span class="kw">auto</span> exp = sort(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true"></a>                <span class="st">&quot;../ut_data/a.cpp&quot;</span>, <span class="st">&quot;../ut_data/a.h&quot;</span>, <span class="st">&quot;../ut_data/abc.cpp&quot;</span>, <span class="st">&quot;../ut_data/abc.h&quot;</span>,</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true"></a>                <span class="st">&quot;../ut_data/d/a.d&quot;</span>, <span class="st">&quot;../ut_data/efghij.cpp&quot;</span>, <span class="st">&quot;../ut_data/efghij.h&quot;</span>,</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true"></a>                <span class="st">&quot;../ut_data/lib/lib.cpp&quot;</span>, <span class="st">&quot;../ut_data/lib/lib.h&quot;</span>, <span class="st">&quot;../ut_data/o/a.o&quot;</span>});</span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true"></a>            <span class="kw">auto</span> act = find_files(<span class="st">&quot;../ut_data&quot;</span>,</span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true"></a>                                  [](fs::path <span class="at">const</span>&amp; p) <span class="kw">noexcept</span> { <span class="cf">return</span> fs::is_regular_file(p); });</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true"></a></span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true"></a>            ASSERT_EQ(exp, act);</span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true"></a>        }</span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true"></a>        {</span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true"></a>            <span class="kw">auto</span> exp = sort(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;../ut_data/d&quot;</span>, <span class="st">&quot;../ut_data/lib&quot;</span>, <span class="st">&quot;../ut_data/o&quot;</span>});</span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true"></a>            <span class="kw">auto</span> act = find_files(<span class="st">&quot;../ut_data&quot;</span>,</span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true"></a>                                  [](fs::path <span class="at">const</span>&amp; p) <span class="kw">noexcept</span> { <span class="cf">return</span> fs::is_directory(p); });</span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true"></a></span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true"></a>            ASSERT_EQ(exp, act);</span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true"></a>        }</span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true"></a>        {</span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true"></a>            <span class="kw">auto</span> exp</span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true"></a>                = sort(<span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;../ut_data/a.cpp&quot;</span>, <span class="st">&quot;../ut_data/abc.cpp&quot;</span>,</span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true"></a>                                                <span class="st">&quot;../ut_data/efghij.cpp&quot;</span>, <span class="st">&quot;../ut_data/lib/lib.cpp&quot;</span>});</span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true"></a>            <span class="kw">auto</span> act = find_files(<span class="st">&quot;../ut_data&quot;</span>, is_cpp_file);</span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true"></a></span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true"></a>            ASSERT_EQ(exp, act);</span>
<span id="cb76-69"><a href="#cb76-69" aria-hidden="true"></a>        }</span>
<span id="cb76-70"><a href="#cb76-70" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_21">演習-Strategy</a>へ戻る。</li>
</ul>
<h3 id="解答例-visitor">解答例-Visitor <a id="SS_20_9_22"></a></h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/visitor.cpp 9</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true"></a>    <span class="co">// 下記クラスFile、Dir、OtherEntityはクラスFileEntityから派生し、</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true"></a>    <span class="co">// それぞれが自身をstd::stringに変換するアルゴリズム関数</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true"></a>    <span class="co">//      * to_string_normal()</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true"></a>    <span class="co">//      * to_string_with_char()</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true"></a>    <span class="co">//      * to_string_with_children()</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true"></a>    <span class="co">// をオーバーライドしている。これはポリモーフィズムの使用方法としては正しいが、</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true"></a>    <span class="co">// to_string_xxx系統のインターフェースがが大量に増えた場合に、</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true"></a>    <span class="co">// FileEntityのインターフェースがそれに比例して増えてしまう問題を持っている。</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true"></a>    <span class="co">// Visitorパターンを使用しこれに対処せよ。</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true"></a>    <span class="co">// * 通常の例では、Visitor::Visit()の戻り値はvoidになっていることが多いが、この例では</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true"></a>    <span class="co">//   std::stringにした。Visitorパターンは戻り値が同じでなければ適用できない。</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true"></a>    <span class="co">// * Visitorパターンは静的型付け言語のダブルディスパッチと呼ばれるテクニックを使っている。</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true"></a>    <span class="co">//      * 1つ目のディスパッチは、Visitor::Visitのオーバーロードによって行われる。</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true"></a>    <span class="co">//      * 2つ目のディスパッチは、Visitorの派生クラスのオーバーライドによって行われる。</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true"></a>    <span class="co">// * デザインパターンとはそういうものであるが、この例でもVisitorの導入によって返って複雑になった。</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true"></a>    <span class="co">//   しかし、to_string_xxxのようなアルゴリズムが10個、20個とあるような場合等には、</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true"></a>    <span class="co">//   クラスの肥大化を防ぐ有用な手段となる。</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true"></a>    <span class="kw">class</span> Visitor;</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true"></a></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true"></a>    <span class="kw">class</span> FileEntity {</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true"></a>        <span class="kw">explicit</span> FileEntity(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : <span class="va">pathname_</span>{strip(pathname)} {}</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true"></a>        <span class="kw">virtual</span> ~FileEntity() = <span class="cf">default</span>;</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; Pathname() <span class="at">const</span> <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="va">pathname_</span>; }</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true"></a>        <span class="bu">std::</span>string        ToString(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span> { <span class="cf">return</span> to_string(to_s); }</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true"></a></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span> <span class="va">pathname_</span>;</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true"></a></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string to_string(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>string  strip(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname)</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true"></a>        {</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>regex_replace(pathname, <span class="bu">std::</span>regex{<span class="st">R&quot;(/+$)&quot;</span>}, <span class="st">&quot;&quot;</span>);</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true"></a>        }</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true"></a>    };</span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true"></a></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true"></a>    <span class="kw">class</span> File;</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true"></a>    <span class="kw">class</span> Dir;</span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true"></a>    <span class="kw">class</span> OtherEntity;</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true"></a></span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true"></a>    <span class="kw">class</span> Visitor {</span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Visitor() = <span class="cf">default</span>;</span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true"></a>        <span class="bu">std::</span>string Visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> { <span class="cf">return</span> visit(file); }</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true"></a>        <span class="bu">std::</span>string Visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> { <span class="cf">return</span> visit(dir); }</span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true"></a>        <span class="bu">std::</span>string Visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> { <span class="cf">return</span> visit(other); }</span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true"></a></span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span>     = <span class="dv">0</span>;</span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span>       = <span class="dv">0</span>;</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; f) <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true"></a>    };</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true"></a></span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true"></a>    <span class="kw">class</span> File <span class="kw">final</span> : <span class="kw">public</span> FileEntity {</span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true"></a>        <span class="kw">explicit</span> File(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : FileEntity{pathname} {}</span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true"></a></span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string to_string(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span> { <span class="cf">return</span> to_s.Visit(*<span class="kw">this</span>); }</span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true"></a>    };</span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true"></a></span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true"></a>    <span class="kw">class</span> Dir <span class="kw">final</span> : <span class="kw">public</span> FileEntity {</span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true"></a>        <span class="kw">explicit</span> Dir(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : FileEntity{pathname} {}</span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true"></a></span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string to_string(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span> { <span class="cf">return</span> to_s.Visit(*<span class="kw">this</span>); }</span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true"></a>    };</span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true"></a></span>
<span id="cb77-75"><a href="#cb77-75" aria-hidden="true"></a>    <span class="kw">class</span> OtherEntity <span class="kw">final</span> : <span class="kw">public</span> FileEntity {</span>
<span id="cb77-76"><a href="#cb77-76" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb77-77"><a href="#cb77-77" aria-hidden="true"></a>        <span class="kw">explicit</span> OtherEntity(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : FileEntity{pathname} {}</span>
<span id="cb77-78"><a href="#cb77-78" aria-hidden="true"></a></span>
<span id="cb77-79"><a href="#cb77-79" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-80"><a href="#cb77-80" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string to_string(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span> { <span class="cf">return</span> to_s.Visit(*<span class="kw">this</span>); }</span>
<span id="cb77-81"><a href="#cb77-81" aria-hidden="true"></a>    };</span>
<span id="cb77-82"><a href="#cb77-82" aria-hidden="true"></a></span>
<span id="cb77-83"><a href="#cb77-83" aria-hidden="true"></a>    <span class="kw">class</span> ToStringNormal : <span class="kw">public</span> Visitor {</span>
<span id="cb77-84"><a href="#cb77-84" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-85"><a href="#cb77-85" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> file.Pathname(); }</span>
<span id="cb77-86"><a href="#cb77-86" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> dir.Pathname() + <span class="ch">&#39;/&#39;</span>; }</span>
<span id="cb77-87"><a href="#cb77-87" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> other.Pathname(); }</span>
<span id="cb77-88"><a href="#cb77-88" aria-hidden="true"></a>    };</span>
<span id="cb77-89"><a href="#cb77-89" aria-hidden="true"></a></span>
<span id="cb77-90"><a href="#cb77-90" aria-hidden="true"></a>    <span class="kw">class</span> ToStringWithChar : <span class="kw">public</span> Visitor {</span>
<span id="cb77-91"><a href="#cb77-91" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-92"><a href="#cb77-92" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> file.Pathname(); }</span>
<span id="cb77-93"><a href="#cb77-93" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> dir.Pathname() + <span class="ch">&#39;/&#39;</span>; }</span>
<span id="cb77-94"><a href="#cb77-94" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb77-95"><a href="#cb77-95" aria-hidden="true"></a>        {</span>
<span id="cb77-96"><a href="#cb77-96" aria-hidden="true"></a>            <span class="cf">return</span> other.Pathname() + <span class="ch">&#39;+&#39;</span>;</span>
<span id="cb77-97"><a href="#cb77-97" aria-hidden="true"></a>        }</span>
<span id="cb77-98"><a href="#cb77-98" aria-hidden="true"></a>    };</span>
<span id="cb77-99"><a href="#cb77-99" aria-hidden="true"></a></span>
<span id="cb77-100"><a href="#cb77-100" aria-hidden="true"></a>    <span class="kw">class</span> ToStringWithChildren : <span class="kw">public</span> Visitor {</span>
<span id="cb77-101"><a href="#cb77-101" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb77-102"><a href="#cb77-102" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> file.Pathname(); }</span>
<span id="cb77-103"><a href="#cb77-103" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> find_files(dir.Pathname()); }</span>
<span id="cb77-104"><a href="#cb77-104" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> other.Pathname(); }</span>
<span id="cb77-105"><a href="#cb77-105" aria-hidden="true"></a></span>
<span id="cb77-106"><a href="#cb77-106" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>string find_files(<span class="bu">std::</span>string <span class="at">const</span>&amp; dir)</span>
<span id="cb77-107"><a href="#cb77-107" aria-hidden="true"></a>        {</span>
<span id="cb77-108"><a href="#cb77-108" aria-hidden="true"></a>            <span class="kw">namespace</span> fs = <span class="bu">std::</span>filesystem;</span>
<span id="cb77-109"><a href="#cb77-109" aria-hidden="true"></a></span>
<span id="cb77-110"><a href="#cb77-110" aria-hidden="true"></a>            <span class="kw">auto</span> files = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{};</span>
<span id="cb77-111"><a href="#cb77-111" aria-hidden="true"></a></span>
<span id="cb77-112"><a href="#cb77-112" aria-hidden="true"></a>            <span class="bu">std::</span>for_each(fs::recursive_directory_iterator{dir}, fs::recursive_directory_iterator{},</span>
<span id="cb77-113"><a href="#cb77-113" aria-hidden="true"></a>                          [&amp;files](fs::path <span class="at">const</span>&amp; p) { files.emplace_back(p.generic_string()); });</span>
<span id="cb77-114"><a href="#cb77-114" aria-hidden="true"></a></span>
<span id="cb77-115"><a href="#cb77-115" aria-hidden="true"></a>            <span class="bu">std::</span>sort(files.begin(), files.end());</span>
<span id="cb77-116"><a href="#cb77-116" aria-hidden="true"></a></span>
<span id="cb77-117"><a href="#cb77-117" aria-hidden="true"></a>            <span class="kw">auto</span> ret = <span class="bu">std::</span>string{dir};</span>
<span id="cb77-118"><a href="#cb77-118" aria-hidden="true"></a></span>
<span id="cb77-119"><a href="#cb77-119" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> f : files) {</span>
<span id="cb77-120"><a href="#cb77-120" aria-hidden="true"></a>                ret += <span class="ch">&#39; &#39;</span> + f;</span>
<span id="cb77-121"><a href="#cb77-121" aria-hidden="true"></a>            }</span>
<span id="cb77-122"><a href="#cb77-122" aria-hidden="true"></a></span>
<span id="cb77-123"><a href="#cb77-123" aria-hidden="true"></a>            <span class="cf">return</span> ret;</span>
<span id="cb77-124"><a href="#cb77-124" aria-hidden="true"></a>        }</span>
<span id="cb77-125"><a href="#cb77-125" aria-hidden="true"></a>    };</span>
<span id="cb77-126"><a href="#cb77-126" aria-hidden="true"></a></span>
<span id="cb77-127"><a href="#cb77-127" aria-hidden="true"></a>    TEST(DesignPatternA, Visitor)</span>
<span id="cb77-128"><a href="#cb77-128" aria-hidden="true"></a>    {</span>
<span id="cb77-129"><a href="#cb77-129" aria-hidden="true"></a>        <span class="kw">auto</span> ts_normal   = ToStringNormal{};</span>
<span id="cb77-130"><a href="#cb77-130" aria-hidden="true"></a>        <span class="kw">auto</span> ts_char     = ToStringWithChar{};</span>
<span id="cb77-131"><a href="#cb77-131" aria-hidden="true"></a>        <span class="kw">auto</span> ts_children = ToStringWithChildren{};</span>
<span id="cb77-132"><a href="#cb77-132" aria-hidden="true"></a></span>
<span id="cb77-133"><a href="#cb77-133" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> f0 = File{<span class="st">&quot;../ut_data/a.cpp&quot;</span>};</span>
<span id="cb77-134"><a href="#cb77-134" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> f1 = File{<span class="st">&quot;../ut_data/a.cpp///&quot;</span>};</span>
<span id="cb77-135"><a href="#cb77-135" aria-hidden="true"></a></span>
<span id="cb77-136"><a href="#cb77-136" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.Pathname());</span>
<span id="cb77-137"><a href="#cb77-137" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.Pathname());</span>
<span id="cb77-138"><a href="#cb77-138" aria-hidden="true"></a></span>
<span id="cb77-139"><a href="#cb77-139" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.ToString(ts_normal));</span>
<span id="cb77-140"><a href="#cb77-140" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.ToString(ts_char));</span>
<span id="cb77-141"><a href="#cb77-141" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.ToString(ts_children));</span>
<span id="cb77-142"><a href="#cb77-142" aria-hidden="true"></a></span>
<span id="cb77-143"><a href="#cb77-143" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> dir = Dir{<span class="st">&quot;../ut_data/lib/&quot;</span>};</span>
<span id="cb77-144"><a href="#cb77-144" aria-hidden="true"></a></span>
<span id="cb77-145"><a href="#cb77-145" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib&quot;</span>, dir.Pathname());</span>
<span id="cb77-146"><a href="#cb77-146" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib/&quot;</span>, dir.ToString(ts_normal));</span>
<span id="cb77-147"><a href="#cb77-147" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib/&quot;</span>, dir.ToString(ts_char));</span>
<span id="cb77-148"><a href="#cb77-148" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib ../ut_data/lib/lib.cpp ../ut_data/lib/lib.h&quot;</span>,</span>
<span id="cb77-149"><a href="#cb77-149" aria-hidden="true"></a>                  dir.ToString(ts_children));</span>
<span id="cb77-150"><a href="#cb77-150" aria-hidden="true"></a></span>
<span id="cb77-151"><a href="#cb77-151" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> other = OtherEntity{<span class="st">&quot;symbolic_link&quot;</span>};</span>
<span id="cb77-152"><a href="#cb77-152" aria-hidden="true"></a></span>
<span id="cb77-153"><a href="#cb77-153" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link&quot;</span>, other.Pathname());</span>
<span id="cb77-154"><a href="#cb77-154" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link&quot;</span>, other.ToString(ts_normal));</span>
<span id="cb77-155"><a href="#cb77-155" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link+&quot;</span>, other.ToString(ts_char));</span>
<span id="cb77-156"><a href="#cb77-156" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link&quot;</span>, other.ToString(ts_children));</span>
<span id="cb77-157"><a href="#cb77-157" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_22">演習-Visitor</a>へ戻る。</li>
</ul>
<h3 id="解答例-crtp">解答例-CRTP <a id="SS_20_9_23"></a></h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/crtp.cpp 9</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true"></a>    <span class="co">// 下記クラスFileEntityから派生しクラスFile、Dir、OtherEntityは、</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true"></a>    <span class="co">// Visitorパターンを利用しているため、そのすべてで下記のコードクローンを持つ。</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true"></a>    <span class="co">//    virtual std::string to_string(Visitor const&amp; to_s) const { return to_s.Visit(*this); }</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true"></a>    <span class="co">//</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true"></a>    <span class="co">// このコードクローンのthisの型は、それぞれFile、Dir、OtherEntityとなるため、</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true"></a>    <span class="co">// この関数をFileEntityで定義すると動作が変わってしまい、単純には統一できない。</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true"></a>    <span class="co">// CRTPを用い、このクローンを削除せよ。</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true"></a>    <span class="co">// 下記のクラステンプレートAcceptableFileEntityと、</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true"></a>    <span class="co">// それから派生したFile、Dir、OtherEntityがCRTPを実装し、コードクローンを排除した。</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true"></a>    <span class="kw">class</span> Visitor;</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true"></a></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true"></a>    <span class="kw">class</span> FileEntity {</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true"></a>        <span class="kw">explicit</span> FileEntity(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : <span class="va">pathname_</span>{strip(pathname)} {}</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true"></a>        <span class="kw">virtual</span> ~FileEntity() = <span class="cf">default</span>;</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span>&amp; Pathname() <span class="at">const</span> { <span class="cf">return</span> <span class="va">pathname_</span>; }</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true"></a>        <span class="bu">std::</span>string        ToString(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span> { <span class="cf">return</span> to_string(to_s); }</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true"></a></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true"></a>        <span class="bu">std::</span>string <span class="at">const</span> <span class="va">pathname_</span>;</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true"></a></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string to_string(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>string  strip(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname)</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true"></a>        {</span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true"></a>            <span class="cf">return</span> <span class="bu">std::</span>regex_replace(pathname, <span class="bu">std::</span>regex{<span class="st">R&quot;(/+$)&quot;</span>}, <span class="st">&quot;&quot;</span>);</span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true"></a>        }</span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true"></a>    };</span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true"></a></span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true"></a>    <span class="kw">class</span> File;</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true"></a>    <span class="kw">class</span> Dir;</span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true"></a>    <span class="kw">class</span> OtherEntity;</span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true"></a></span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true"></a>    <span class="kw">class</span> Visitor {</span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true"></a>        <span class="kw">virtual</span> ~Visitor() = <span class="cf">default</span>;</span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true"></a>        <span class="bu">std::</span>string Visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> { <span class="cf">return</span> visit(file); }</span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true"></a>        <span class="bu">std::</span>string Visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> { <span class="cf">return</span> visit(dir); }</span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true"></a>        <span class="bu">std::</span>string Visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> { <span class="cf">return</span> visit(other); }</span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true"></a></span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span>     = <span class="dv">0</span>;</span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span>       = <span class="dv">0</span>;</span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; f) <span class="at">const</span> = <span class="dv">0</span>;</span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true"></a>    };</span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true"></a></span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true"></a>    <span class="kw">class</span> AcceptableFileEntity : <span class="kw">public</span> FileEntity {  <span class="co">// CRTP</span></span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string to_string(Visitor <span class="at">const</span>&amp; to_s) <span class="at">const</span></span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true"></a>        {</span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true"></a>            <span class="cf">return</span> to_s.Visit(*<span class="kw">static_cast</span>&lt;T <span class="at">const</span>*&gt;(<span class="kw">this</span>));</span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true"></a>        }</span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true"></a></span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true"></a>        <span class="co">// T : public AcceptableFileEntity&lt;T&gt; { ... };</span></span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true"></a>        <span class="co">// 以外の使い方をコンパイルエラーにする</span></span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true"></a>        AcceptableFileEntity(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : FileEntity{pathname} {}</span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true"></a>        <span class="kw">friend</span> T;</span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true"></a>    };</span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true"></a></span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true"></a>    <span class="kw">class</span> File <span class="kw">final</span> : <span class="kw">public</span> AcceptableFileEntity&lt;File&gt; {</span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true"></a>        File(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : AcceptableFileEntity{pathname} {}</span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true"></a>    };</span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true"></a></span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true"></a>    <span class="kw">class</span> Dir <span class="kw">final</span> : <span class="kw">public</span> AcceptableFileEntity&lt;Dir&gt; {</span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true"></a>        Dir(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : AcceptableFileEntity{pathname} {}</span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true"></a>    };</span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true"></a></span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true"></a>    <span class="kw">class</span> OtherEntity <span class="kw">final</span> : <span class="kw">public</span> AcceptableFileEntity&lt;OtherEntity&gt; {</span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true"></a>        OtherEntity(<span class="bu">std::</span>string <span class="at">const</span>&amp; pathname) : AcceptableFileEntity{pathname} {}</span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true"></a>    };</span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true"></a></span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true"></a>    <span class="kw">class</span> ToStringNormal : <span class="kw">public</span> Visitor {</span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> file.Pathname(); }</span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> dir.Pathname() + <span class="ch">&#39;/&#39;</span>; }</span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> other.Pathname(); }</span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true"></a>    };</span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true"></a></span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true"></a>    <span class="kw">class</span> ToStringWithChar : <span class="kw">public</span> Visitor {</span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> file.Pathname(); }</span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> dir.Pathname() + <span class="ch">&#39;/&#39;</span>; }</span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> <span class="kw">override</span></span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true"></a>        {</span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true"></a>            <span class="cf">return</span> other.Pathname() + <span class="ch">&#39;+&#39;</span>;</span>
<span id="cb78-95"><a href="#cb78-95" aria-hidden="true"></a>        }</span>
<span id="cb78-96"><a href="#cb78-96" aria-hidden="true"></a>    };</span>
<span id="cb78-97"><a href="#cb78-97" aria-hidden="true"></a></span>
<span id="cb78-98"><a href="#cb78-98" aria-hidden="true"></a>    <span class="kw">class</span> ToStringWithChildren : <span class="kw">public</span> Visitor {</span>
<span id="cb78-99"><a href="#cb78-99" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb78-100"><a href="#cb78-100" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(File <span class="at">const</span>&amp; file) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> file.Pathname(); }</span>
<span id="cb78-101"><a href="#cb78-101" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(Dir <span class="at">const</span>&amp; dir) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> find_files(dir.Pathname()); }</span>
<span id="cb78-102"><a href="#cb78-102" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="bu">std::</span>string visit(OtherEntity <span class="at">const</span>&amp; other) <span class="at">const</span> <span class="kw">override</span> { <span class="cf">return</span> other.Pathname(); }</span>
<span id="cb78-103"><a href="#cb78-103" aria-hidden="true"></a></span>
<span id="cb78-104"><a href="#cb78-104" aria-hidden="true"></a>        <span class="at">static</span> <span class="bu">std::</span>string find_files(<span class="bu">std::</span>string <span class="at">const</span>&amp; dir)</span>
<span id="cb78-105"><a href="#cb78-105" aria-hidden="true"></a>        {</span>
<span id="cb78-106"><a href="#cb78-106" aria-hidden="true"></a>            <span class="kw">namespace</span> fs = <span class="bu">std::</span>filesystem;</span>
<span id="cb78-107"><a href="#cb78-107" aria-hidden="true"></a></span>
<span id="cb78-108"><a href="#cb78-108" aria-hidden="true"></a>            <span class="kw">auto</span> files = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>string&gt;{};</span>
<span id="cb78-109"><a href="#cb78-109" aria-hidden="true"></a></span>
<span id="cb78-110"><a href="#cb78-110" aria-hidden="true"></a>            <span class="bu">std::</span>for_each(fs::recursive_directory_iterator{dir}, fs::recursive_directory_iterator{},</span>
<span id="cb78-111"><a href="#cb78-111" aria-hidden="true"></a>                          [&amp;files](fs::path <span class="at">const</span>&amp; p) { files.emplace_back(p.generic_string()); });</span>
<span id="cb78-112"><a href="#cb78-112" aria-hidden="true"></a></span>
<span id="cb78-113"><a href="#cb78-113" aria-hidden="true"></a>            <span class="bu">std::</span>sort(files.begin(), files.end());</span>
<span id="cb78-114"><a href="#cb78-114" aria-hidden="true"></a></span>
<span id="cb78-115"><a href="#cb78-115" aria-hidden="true"></a>            <span class="kw">auto</span> ret = <span class="bu">std::</span>string{dir};</span>
<span id="cb78-116"><a href="#cb78-116" aria-hidden="true"></a></span>
<span id="cb78-117"><a href="#cb78-117" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span> f : files) {</span>
<span id="cb78-118"><a href="#cb78-118" aria-hidden="true"></a>                ret += <span class="ch">&#39; &#39;</span> + f;</span>
<span id="cb78-119"><a href="#cb78-119" aria-hidden="true"></a>            }</span>
<span id="cb78-120"><a href="#cb78-120" aria-hidden="true"></a></span>
<span id="cb78-121"><a href="#cb78-121" aria-hidden="true"></a>            <span class="cf">return</span> ret;</span>
<span id="cb78-122"><a href="#cb78-122" aria-hidden="true"></a>        }</span>
<span id="cb78-123"><a href="#cb78-123" aria-hidden="true"></a>    };</span>
<span id="cb78-124"><a href="#cb78-124" aria-hidden="true"></a></span>
<span id="cb78-125"><a href="#cb78-125" aria-hidden="true"></a>    TEST(DesignPatternA, CRTP)</span>
<span id="cb78-126"><a href="#cb78-126" aria-hidden="true"></a>    {</span>
<span id="cb78-127"><a href="#cb78-127" aria-hidden="true"></a>        <span class="kw">auto</span> ts_normal   = ToStringNormal{};</span>
<span id="cb78-128"><a href="#cb78-128" aria-hidden="true"></a>        <span class="kw">auto</span> ts_char     = ToStringWithChar{};</span>
<span id="cb78-129"><a href="#cb78-129" aria-hidden="true"></a>        <span class="kw">auto</span> ts_children = ToStringWithChildren{};</span>
<span id="cb78-130"><a href="#cb78-130" aria-hidden="true"></a></span>
<span id="cb78-131"><a href="#cb78-131" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> f0 = File{<span class="st">&quot;../ut_data/a.cpp&quot;</span>};</span>
<span id="cb78-132"><a href="#cb78-132" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> f1 = File{<span class="st">&quot;../ut_data/a.cpp///&quot;</span>};</span>
<span id="cb78-133"><a href="#cb78-133" aria-hidden="true"></a></span>
<span id="cb78-134"><a href="#cb78-134" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.Pathname());</span>
<span id="cb78-135"><a href="#cb78-135" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.Pathname());</span>
<span id="cb78-136"><a href="#cb78-136" aria-hidden="true"></a></span>
<span id="cb78-137"><a href="#cb78-137" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.ToString(ts_normal));</span>
<span id="cb78-138"><a href="#cb78-138" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.ToString(ts_char));</span>
<span id="cb78-139"><a href="#cb78-139" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/a.cpp&quot;</span>, f0.ToString(ts_children));</span>
<span id="cb78-140"><a href="#cb78-140" aria-hidden="true"></a></span>
<span id="cb78-141"><a href="#cb78-141" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> dir = Dir{<span class="st">&quot;../ut_data/lib/&quot;</span>};</span>
<span id="cb78-142"><a href="#cb78-142" aria-hidden="true"></a></span>
<span id="cb78-143"><a href="#cb78-143" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib&quot;</span>, dir.Pathname());</span>
<span id="cb78-144"><a href="#cb78-144" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib/&quot;</span>, dir.ToString(ts_normal));</span>
<span id="cb78-145"><a href="#cb78-145" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib/&quot;</span>, dir.ToString(ts_char));</span>
<span id="cb78-146"><a href="#cb78-146" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;../ut_data/lib ../ut_data/lib/lib.cpp ../ut_data/lib/lib.h&quot;</span>,</span>
<span id="cb78-147"><a href="#cb78-147" aria-hidden="true"></a>                  dir.ToString(ts_children));</span>
<span id="cb78-148"><a href="#cb78-148" aria-hidden="true"></a></span>
<span id="cb78-149"><a href="#cb78-149" aria-hidden="true"></a>        <span class="kw">auto</span> <span class="at">const</span> other = OtherEntity{<span class="st">&quot;symbolic_link&quot;</span>};</span>
<span id="cb78-150"><a href="#cb78-150" aria-hidden="true"></a></span>
<span id="cb78-151"><a href="#cb78-151" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link&quot;</span>, other.Pathname());</span>
<span id="cb78-152"><a href="#cb78-152" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link&quot;</span>, other.ToString(ts_normal));</span>
<span id="cb78-153"><a href="#cb78-153" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link+&quot;</span>, other.ToString(ts_char));</span>
<span id="cb78-154"><a href="#cb78-154" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;symbolic_link&quot;</span>, other.ToString(ts_children));</span>
<span id="cb78-155"><a href="#cb78-155" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_23">演習-CRTP</a>へ戻る。</li>
</ul>
<h3 id="解答例-observer">解答例-Observer <a id="SS_20_9_24"></a></h3>
<div class="sourceCode" id="cb79"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/design_pattern_a/observer.cpp 9</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true"></a>    <span class="co">// 下記クラスはそれぞれが</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true"></a>    <span class="co">//      * ViewX、 ViewY : GUIへの出力(描画)</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true"></a>    <span class="co">//      * Model         : 何らかのビジネスロジックの演算</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true"></a>    <span class="co">//      * Controller    : OKボタンクリックイベントをModelへ通知</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true"></a>    <span class="co">// を行うことを模擬している。</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true"></a>    <span class="co">// 依存関係Model-&gt;ViewX、ViewYはMVCに逆行しているため下記のような問題を持つ。</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true"></a>    <span class="co">//      * ViewX、ViewYの変更がModelに伝搬してしまう。</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true"></a>    <span class="co">//      * この例は単純であるためViewX、ViewY-&gt;Modelへの依存関係は存在しないが、</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true"></a>    <span class="co">//        実際のアプリケーションではそのような依存関係が存在するため、依存関係が循環してしまう。</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true"></a>    <span class="co">//      * ModelがダイレクトにViewX、ViewYへ出力するため、単体テストの実施は困難である。</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true"></a>    <span class="co">//      * この依存関係が直接の原因ではないが、このような依存関係を持つアプリケーションのクラスは</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true"></a>    <span class="co">//        巨大になる。</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true"></a>    <span class="co">//  アプリケーションが小規模である時には、このような問題がバグや開発効率悪化の原因となることは稀</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true"></a>    <span class="co">//  であり放置されることが多いが、大規模化に伴いこのような潜在的問題が表出する。</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true"></a>    <span class="co">//  ModelにObserverパターンを適用する等をしてこの問題に対処するとともに、Modelの単体テストを行え。</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true"></a></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true"></a>    <span class="co">// [解説]</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true"></a>    <span class="co">// * Observerパターンの使用について</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true"></a>    <span class="co">//      * ObserverIFはModelを宣言、定義しているヘッダファイルに定義する。</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true"></a>    <span class="co">//      * 何らかの理由でそうしない場合は、ObserverIFはModelを含むパッケージ内に定義する。</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true"></a>    <span class="co">// * Observerパターンの導入により、</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true"></a>    <span class="co">//      * ModelはViewX、ViewYに依存しなくなったが、代わりにObserverIFに依存する。</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true"></a>    <span class="co">//      * この依存関係はObserverIFがModelヘッダに含まれることで問題にならない。</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true"></a>    <span class="co">// * その他</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true"></a>    <span class="co">//      * 通常は、Attachに対してDetachも定義するが、AttachされたオブジェクトをDetachしない</span></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true"></a>    <span class="co">//        場合は、今回の例のようにAttachされたオブジェクトの廃棄をModelにさせた方が良い。</span></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true"></a>    <span class="co">//      * こういった動作の確認にもForTestクラスを使用した。</span></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true"></a></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true"></a>    <span class="kw">class</span> ObserverIF {</span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true"></a>        <span class="dt">void</span> DisplaySomething(<span class="bu">std::</span>string <span class="at">const</span>&amp; result) { display_something(result); }</span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true"></a>        <span class="kw">virtual</span> ~ObserverIF() = <span class="cf">default</span>;</span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true"></a></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> display_something(<span class="bu">std::</span>string <span class="at">const</span>&amp;) = <span class="dv">0</span>;</span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true"></a>    };</span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true"></a></span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true"></a>    <span class="kw">class</span> Model {</span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true"></a>        Model() = <span class="cf">default</span>;</span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true"></a>        ~Model() { wait_future(); }</span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true"></a></span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true"></a>        <span class="co">// Detachできない仕様にする。その代わりにobserverの廃棄もModelに任せることができる。</span></span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true"></a>        <span class="dt">void</span> Attach(<span class="bu">std::</span>unique_ptr&lt;ObserverIF&gt; observer)</span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true"></a>        {</span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true"></a>            <span class="va">observers_</span>.emplace_back(<span class="bu">std::</span>move(observer));</span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true"></a>        }</span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true"></a></span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true"></a>        <span class="dt">void</span> DoSomething()</span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true"></a>        {</span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true"></a>            wait_future();</span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true"></a></span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true"></a>            <span class="va">future_</span> = <span class="bu">std::</span>async(<span class="bu">std::</span>launch<span class="bu">::</span>async, [<span class="kw">this</span>] {</span>
<span id="cb79-56"><a href="#cb79-56" aria-hidden="true"></a>                <span class="co">// 本来は非同期処理が必要な重い処理</span></span>
<span id="cb79-57"><a href="#cb79-57" aria-hidden="true"></a>                <span class="kw">auto</span> result = <span class="bu">std::</span>string{<span class="st">&quot;result of doing something&quot;</span>};</span>
<span id="cb79-58"><a href="#cb79-58" aria-hidden="true"></a></span>
<span id="cb79-59"><a href="#cb79-59" aria-hidden="true"></a>                notify(result);</span>
<span id="cb79-60"><a href="#cb79-60" aria-hidden="true"></a>            });</span>
<span id="cb79-61"><a href="#cb79-61" aria-hidden="true"></a>        }</span>
<span id="cb79-62"><a href="#cb79-62" aria-hidden="true"></a></span>
<span id="cb79-63"><a href="#cb79-63" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb79-64"><a href="#cb79-64" aria-hidden="true"></a>        <span class="bu">std::</span>future&lt;<span class="dt">void</span>&gt;                        <span class="va">future_</span>{};</span>
<span id="cb79-65"><a href="#cb79-65" aria-hidden="true"></a>        <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>unique_ptr&lt;ObserverIF&gt;&gt; <span class="va">observers_</span>{};</span>
<span id="cb79-66"><a href="#cb79-66" aria-hidden="true"></a></span>
<span id="cb79-67"><a href="#cb79-67" aria-hidden="true"></a>        <span class="dt">void</span> notify(<span class="bu">std::</span>string <span class="at">const</span>&amp; result) <span class="at">const</span></span>
<span id="cb79-68"><a href="#cb79-68" aria-hidden="true"></a>        {</span>
<span id="cb79-69"><a href="#cb79-69" aria-hidden="true"></a>            <span class="cf">for</span> (<span class="kw">auto</span>&amp; observer : <span class="va">observers_</span>) {</span>
<span id="cb79-70"><a href="#cb79-70" aria-hidden="true"></a>                observer-&gt;DisplaySomething(result);</span>
<span id="cb79-71"><a href="#cb79-71" aria-hidden="true"></a>            }</span>
<span id="cb79-72"><a href="#cb79-72" aria-hidden="true"></a>        }</span>
<span id="cb79-73"><a href="#cb79-73" aria-hidden="true"></a></span>
<span id="cb79-74"><a href="#cb79-74" aria-hidden="true"></a>        <span class="dt">void</span> wait_future()</span>
<span id="cb79-75"><a href="#cb79-75" aria-hidden="true"></a>        {</span>
<span id="cb79-76"><a href="#cb79-76" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="va">future_</span>.valid()) {</span>
<span id="cb79-77"><a href="#cb79-77" aria-hidden="true"></a>                <span class="va">future_</span>.wait();</span>
<span id="cb79-78"><a href="#cb79-78" aria-hidden="true"></a>            }</span>
<span id="cb79-79"><a href="#cb79-79" aria-hidden="true"></a>        }</span>
<span id="cb79-80"><a href="#cb79-80" aria-hidden="true"></a>    };</span>
<span id="cb79-81"><a href="#cb79-81" aria-hidden="true"></a></span>
<span id="cb79-82"><a href="#cb79-82" aria-hidden="true"></a>    <span class="kw">class</span> ViewX : <span class="kw">public</span> ObserverIF {</span>
<span id="cb79-83"><a href="#cb79-83" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb79-84"><a href="#cb79-84" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> display_something(<span class="bu">std::</span>string <span class="at">const</span>&amp;) <span class="kw">override</span> {}</span>
<span id="cb79-85"><a href="#cb79-85" aria-hidden="true"></a>    };</span>
<span id="cb79-86"><a href="#cb79-86" aria-hidden="true"></a></span>
<span id="cb79-87"><a href="#cb79-87" aria-hidden="true"></a>    <span class="kw">class</span> ViewY : <span class="kw">public</span> ObserverIF {</span>
<span id="cb79-88"><a href="#cb79-88" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb79-89"><a href="#cb79-89" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> display_something(<span class="bu">std::</span>string <span class="at">const</span>&amp;) <span class="kw">override</span> {}</span>
<span id="cb79-90"><a href="#cb79-90" aria-hidden="true"></a>    };</span>
<span id="cb79-91"><a href="#cb79-91" aria-hidden="true"></a></span>
<span id="cb79-92"><a href="#cb79-92" aria-hidden="true"></a>    <span class="kw">class</span> Controller {</span>
<span id="cb79-93"><a href="#cb79-93" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb79-94"><a href="#cb79-94" aria-hidden="true"></a>        Controller(Model&amp; model) : <span class="va">model_</span>{model} {}</span>
<span id="cb79-95"><a href="#cb79-95" aria-hidden="true"></a>        <span class="dt">void</span> OK_Clicked() { <span class="va">model_</span>.DoSomething(); }</span>
<span id="cb79-96"><a href="#cb79-96" aria-hidden="true"></a></span>
<span id="cb79-97"><a href="#cb79-97" aria-hidden="true"></a>        Model&amp; <span class="va">model_</span>;</span>
<span id="cb79-98"><a href="#cb79-98" aria-hidden="true"></a>    };</span>
<span id="cb79-99"><a href="#cb79-99" aria-hidden="true"></a></span>
<span id="cb79-100"><a href="#cb79-100" aria-hidden="true"></a>    <span class="kw">class</span> ForTest : <span class="kw">public</span> ObserverIF {</span>
<span id="cb79-101"><a href="#cb79-101" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb79-102"><a href="#cb79-102" aria-hidden="true"></a>        <span class="kw">explicit</span> ForTest(<span class="bu">std::</span>string&amp; result, <span class="dt">uint32_t</span>&amp; called, <span class="dt">bool</span>&amp; destructed)</span>
<span id="cb79-103"><a href="#cb79-103" aria-hidden="true"></a>            : <span class="va">result_</span>{result}, <span class="va">called_</span>{called}, <span class="va">destructed_</span>{destructed}</span>
<span id="cb79-104"><a href="#cb79-104" aria-hidden="true"></a>        {</span>
<span id="cb79-105"><a href="#cb79-105" aria-hidden="true"></a>        }</span>
<span id="cb79-106"><a href="#cb79-106" aria-hidden="true"></a>        <span class="kw">virtual</span> ~ForTest() <span class="kw">override</span> { <span class="va">destructed_</span> = <span class="kw">true</span>; }</span>
<span id="cb79-107"><a href="#cb79-107" aria-hidden="true"></a></span>
<span id="cb79-108"><a href="#cb79-108" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb79-109"><a href="#cb79-109" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> display_something(<span class="bu">std::</span>string <span class="at">const</span>&amp; result) <span class="kw">noexcept</span> <span class="kw">override</span></span>
<span id="cb79-110"><a href="#cb79-110" aria-hidden="true"></a>        {</span>
<span id="cb79-111"><a href="#cb79-111" aria-hidden="true"></a>            <span class="va">result_</span> = result;</span>
<span id="cb79-112"><a href="#cb79-112" aria-hidden="true"></a>            ++<span class="va">called_</span>;</span>
<span id="cb79-113"><a href="#cb79-113" aria-hidden="true"></a>        }</span>
<span id="cb79-114"><a href="#cb79-114" aria-hidden="true"></a></span>
<span id="cb79-115"><a href="#cb79-115" aria-hidden="true"></a>        <span class="bu">std::</span>string&amp; <span class="va">result_</span>;</span>
<span id="cb79-116"><a href="#cb79-116" aria-hidden="true"></a>        <span class="dt">uint32_t</span>&amp;    <span class="va">called_</span>;</span>
<span id="cb79-117"><a href="#cb79-117" aria-hidden="true"></a>        <span class="dt">bool</span>&amp;        <span class="va">destructed_</span>;</span>
<span id="cb79-118"><a href="#cb79-118" aria-hidden="true"></a>    };</span>
<span id="cb79-119"><a href="#cb79-119" aria-hidden="true"></a></span>
<span id="cb79-120"><a href="#cb79-120" aria-hidden="true"></a>    TEST(DesignPatternA, Observer)</span>
<span id="cb79-121"><a href="#cb79-121" aria-hidden="true"></a>    {</span>
<span id="cb79-122"><a href="#cb79-122" aria-hidden="true"></a>        <span class="kw">auto</span> result     = <span class="bu">std::</span>string{};</span>
<span id="cb79-123"><a href="#cb79-123" aria-hidden="true"></a>        <span class="kw">auto</span> called     = <span class="dv">0</span><span class="bu">U</span>;</span>
<span id="cb79-124"><a href="#cb79-124" aria-hidden="true"></a>        <span class="kw">auto</span> destructed = <span class="kw">false</span>;</span>
<span id="cb79-125"><a href="#cb79-125" aria-hidden="true"></a></span>
<span id="cb79-126"><a href="#cb79-126" aria-hidden="true"></a>        {</span>
<span id="cb79-127"><a href="#cb79-127" aria-hidden="true"></a>            <span class="kw">auto</span> model      = Model{};</span>
<span id="cb79-128"><a href="#cb79-128" aria-hidden="true"></a>            <span class="kw">auto</span> controller = Controller{model};</span>
<span id="cb79-129"><a href="#cb79-129" aria-hidden="true"></a></span>
<span id="cb79-130"><a href="#cb79-130" aria-hidden="true"></a>            model.Attach(<span class="bu">std::</span>make_unique&lt;ViewX&gt;());</span>
<span id="cb79-131"><a href="#cb79-131" aria-hidden="true"></a>            model.Attach(<span class="bu">std::</span>make_unique&lt;ViewY&gt;());</span>
<span id="cb79-132"><a href="#cb79-132" aria-hidden="true"></a>            model.Attach(<span class="bu">std::</span>make_unique&lt;ForTest&gt;(result, called, destructed));</span>
<span id="cb79-133"><a href="#cb79-133" aria-hidden="true"></a></span>
<span id="cb79-134"><a href="#cb79-134" aria-hidden="true"></a>            controller.OK_Clicked();</span>
<span id="cb79-135"><a href="#cb79-135" aria-hidden="true"></a>            controller.OK_Clicked();</span>
<span id="cb79-136"><a href="#cb79-136" aria-hidden="true"></a>            controller.OK_Clicked();</span>
<span id="cb79-137"><a href="#cb79-137" aria-hidden="true"></a>        }</span>
<span id="cb79-138"><a href="#cb79-138" aria-hidden="true"></a></span>
<span id="cb79-139"><a href="#cb79-139" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;result of doing something&quot;</span>, result);</span>
<span id="cb79-140"><a href="#cb79-140" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, called);</span>
<span id="cb79-141"><a href="#cb79-141" aria-hidden="true"></a>        ASSERT_TRUE(destructed);</span>
<span id="cb79-142"><a href="#cb79-142" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_9_24">演習-Observer</a>へ戻る。</li>
</ul>
<h3 id="解答-デザインパターン選択1">解答-デザインパターン選択1 <a id="SS_20_9_25"></a></h3>
<ul>
<li>選択肢2</li>
<li>参照 <a href="design_pattern.html#SS_9_13">State</a></li>
<li><a href="exercise_q.html#SS_19_9_25">演習-デザインパターン選択1</a>へ戻る。</li>
</ul>
<h3 id="解答-デザインパターン選択2">解答-デザインパターン選択2 <a id="SS_20_9_26"></a></h3>
<ul>
<li>選択肢4</li>
<li>参照 <a href="design_pattern.html#SS_9_14">Null Object</a></li>
<li><a href="exercise_q.html#SS_19_9_26">演習-デザインパターン選択2</a>へ戻る。</li>
</ul>
<h3 id="解答-デザインパターン選択3">解答-デザインパターン選択3 <a id="SS_20_9_27"></a></h3>
<ul>
<li>選択肢3</li>
<li>参照 <a href="design_pattern.html#SS_9_22">Observer</a></li>
<li><a href="exercise_q.html#SS_19_9_27">演習-デザインパターン選択3</a>へ戻る。</li>
</ul>
<h2 id="開発プロセスとインフラ全般">開発プロセスとインフラ(全般) <a id="SS_20_10"></a></h2>
<h3 id="解答-プロセス分類">解答-プロセス分類 <a id="SS_20_10_1"></a></h3>
<ul>
<li>選択肢対応
<ul>
<li>A - 1</li>
<li>B - 2</li>
<li>C - 3</li>
</ul></li>
<li>参照 <a href="process_and_infra.html#SS_11_1">プロセス</a></li>
<li><a href="exercise_q.html#SS_19_10_1">演習-プロセス分類</a>へ戻る。</li>
</ul>
<h3 id="解答-v字モデル">解答-V字モデル <a id="SS_20_10_2"></a></h3>
<ul>
<li>選択肢対応
<ul>
<li>フェーズA - 4</li>
<li>フェーズB - 2</li>
<li>フェーズC - 3</li>
<li>フェーズD - 1</li>
</ul></li>
<li>参照 <a href="process_and_infra.html#SS_11_1_1">ウォーターフォールモデル、V字モデル</a></li>
<li><a href="exercise_q.html#SS_19_10_2">演習-V字モデル</a>へ戻る。</li>
</ul>
<h3 id="解答-アジャイル">解答-アジャイル <a id="SS_20_10_3"></a></h3>
<ul>
<li>選択肢2</li>
<li>参照 <a href="process_and_infra.html#SS_11_1_2">アジャイル系プロセス</a></li>
<li><a href="exercise_q.html#SS_19_10_3">演習-アジャイル</a>へ戻る。</li>
</ul>
<h3 id="解答-自動化">解答-自動化 <a id="SS_20_10_4"></a></h3>
<ul>
<li>選択肢対応
<ul>
<li>A - 1</li>
<li>B - 4</li>
<li>C - 5</li>
</ul></li>
<li>参照 <a href="process_and_infra.html#SS_11_2_1">自動単体テスト</a></li>
<li><a href="exercise_q.html#SS_19_10_4">演習-自動化</a>へ戻る。</li>
</ul>
<h3 id="解答-単体テスト">解答-単体テスト <a id="SS_20_10_5"></a></h3>
<ul>
<li>選択肢4</li>
<li>参照 <a href="process_and_infra.html#SS_11_2_1">自動単体テスト</a></li>
<li><a href="exercise_q.html#SS_19_10_5">演習-単体テスト</a>へ戻る。</li>
</ul>
<h3 id="解答-リファクタリングに付随する活動">解答-リファクタリングに付随する活動 <a id="SS_20_10_6"></a></h3>
<ul>
<li>選択肢2</li>
<li>参照 <a href="process_and_infra.html#SS_11_2_2">リファクタリング</a></li>
<li><a href="exercise_q.html#SS_19_10_6">演習-リファクタリングに付随する活動</a>へ戻る。</li>
</ul>
<h3 id="解答-リファクタリング対象コード">解答-リファクタリング対象コード <a id="SS_20_10_7"></a></h3>
<ul>
<li>選択肢3</li>
<li>参照 <a href="process_and_infra.html#SS_11_2_2">リファクタリング</a></li>
<li><a href="exercise_q.html#SS_19_10_7">演習-リファクタリング対象コード</a>へ戻る。</li>
</ul>
<h3 id="解答-ci">解答-CI <a id="SS_20_10_8"></a></h3>
<ul>
<li>選択肢2, 4</li>
<li>参照 <a href="process_and_infra.html#SS_11_2_5">CI(継続的インテグレーション)</a></li>
<li><a href="exercise_q.html#SS_19_10_8">演習-CI</a>へ戻る。</li>
</ul>
<h2 id="テンプレートメタプログラミング">テンプレートメタプログラミング <a id="SS_20_11"></a></h2>
<h3 id="解答例-パラメータパック">解答例-パラメータパック <a id="SS_20_11_1"></a></h3>
<div class="sourceCode" id="cb80"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/parameter_pack.cpp 7</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true"></a>    <span class="co">// 下記の関数Maxは、単体テストが示す通り、2つのパラメータの大きい方を返す。</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true"></a>    <span class="co">// 任意の個数の引数を取れるようにMaxを修正せよ。</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true"></a>    <span class="co">// 解答例1</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true"></a>    <span class="co">// パラメータパックを使用しMaxを修正した例</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true"></a>    T Max(T <span class="at">const</span>&amp; t0, T <span class="at">const</span>&amp; t1) <span class="kw">noexcept</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true"></a>    {</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true"></a>        <span class="cf">return</span> t0 &gt; t1 ? t0 : t1;</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true"></a>    }</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true"></a></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> HEAD, <span class="kw">typename</span>... ARGS&gt;</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true"></a>    <span class="kw">auto</span> Max(HEAD <span class="at">const</span>&amp; head, ARGS <span class="at">const</span>&amp;... args) <span class="kw">noexcept</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true"></a>    {</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true"></a>        <span class="kw">auto</span> args_max = Max(args...);</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true"></a></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true"></a>        <span class="cf">return</span> head &gt; args_max ? head : args_max;</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true"></a>    }</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true"></a></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, parameter_pack)</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true"></a>    {</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">2</span>, Max(<span class="dv">1</span>, <span class="dv">2</span>));</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;bcd&quot;</span>, Max(<span class="bu">std::</span>string{<span class="st">&quot;abc&quot;</span>}, <span class="bu">std::</span>string{<span class="st">&quot;bcd&quot;</span>}));</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true"></a></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, Max(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>));</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;efg&quot;</span>, Max(<span class="bu">std::</span>string{<span class="st">&quot;abc&quot;</span>}, <span class="bu">std::</span>string{<span class="st">&quot;bcd&quot;</span>}, <span class="bu">std::</span>string{<span class="st">&quot;efg&quot;</span>}));</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true"></a>    }</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true"></a></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true"></a>    <span class="co">// 解答例2</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true"></a>    <span class="co">// std::initializer_listを使用しMaxを修正した例</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true"></a>    T Max(<span class="bu">std::</span>initializer_list&lt;T&gt; t_list) <span class="kw">noexcept</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true"></a>    {</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true"></a>        <span class="kw">auto</span> ret   = T{};</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true"></a>        <span class="kw">auto</span> first = <span class="kw">true</span>;</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true"></a></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> <span class="at">const</span>&amp; t : t_list) {</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true"></a>            <span class="cf">if</span> (<span class="bu">std::</span>exchange(first, <span class="kw">false</span>)) {</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true"></a>                ret = t;</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true"></a>            }</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true"></a>            <span class="cf">else</span> {</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true"></a>                ret = Max(ret, t);</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true"></a>            }</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true"></a>        }</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true"></a></span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true"></a>        <span class="cf">return</span> ret;</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true"></a>    }</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true"></a></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, initializer_list)</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true"></a>    {</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">2</span>, Max({<span class="dv">1</span>, <span class="dv">2</span>}));</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;bcd&quot;</span>, Max({<span class="bu">std::</span>string{<span class="st">&quot;abc&quot;</span>}, <span class="bu">std::</span>string{<span class="st">&quot;bcd&quot;</span>}}));</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true"></a></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, Max({<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}));</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;efg&quot;</span>, Max({<span class="bu">std::</span>string{<span class="st">&quot;abc&quot;</span>}, <span class="bu">std::</span>string{<span class="st">&quot;bcd&quot;</span>}, <span class="bu">std::</span>string{<span class="st">&quot;efg&quot;</span>}}));</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_1">演習-パラメータパック</a>へ戻る。</li>
</ul>
<h3 id="解答例-エイリアステンプレート">解答例-エイリアステンプレート <a id="SS_20_11_2"></a></h3>
<div class="sourceCode" id="cb81"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/template_alias.cpp 5</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true"></a>    <span class="co">// 下記の単体テストでしているstd::vector&lt;std::vector&lt;XXX&gt;&gt;を、</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true"></a>    <span class="co">// テンプレートエイリアスによって簡潔に記述せよ。</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true"></a></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true"></a>    <span class="co">// 解説</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true"></a>    <span class="co">// 下記のVect1Dはstd::vectorに対して簡潔な記述方法を提供しているとは言えないが、</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true"></a>    <span class="co">// Vect2Dと同じような場面で使用することが明示されるため、ソースコードに一貫性を与える。</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true"></a>    <span class="kw">using</span> Vect2D = <span class="bu">std::</span>vector&lt;<span class="bu">std::</span>vector&lt;T&gt;&gt;;</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true"></a>    <span class="kw">using</span> Vect1D = <span class="bu">std::</span>vector&lt;T&gt;;</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true"></a></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, template_alias)</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true"></a>    {</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true"></a>        {</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true"></a>            <span class="kw">auto</span> vv = Vect2D&lt;<span class="dt">int</span>&gt;{{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}, {<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>}};</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">2</span>, vv.size());</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true"></a>            ASSERT_EQ((Vect1D&lt;<span class="dt">int</span>&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}), vv[<span class="dv">0</span>]);</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true"></a>            ASSERT_EQ((Vect1D&lt;<span class="dt">int</span>&gt;{<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>}), vv[<span class="dv">1</span>]);</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">5</span>, vv[<span class="dv">1</span>][<span class="dv">2</span>]);</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true"></a>        }</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true"></a>        {</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true"></a>            <span class="kw">auto</span> vv = Vect2D&lt;<span class="dt">float</span>&gt;{{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}, {<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>}};</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">2</span>, vv.size());</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true"></a>            ASSERT_EQ((Vect1D&lt;<span class="dt">float</span>&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}), vv[<span class="dv">0</span>]);</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true"></a>            ASSERT_EQ((Vect1D&lt;<span class="dt">float</span>&gt;{<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>}), vv[<span class="dv">1</span>]);</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">5</span>, vv[<span class="dv">1</span>][<span class="dv">2</span>]);</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true"></a>        }</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true"></a>        {</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true"></a>            <span class="kw">auto</span> vv = Vect2D&lt;<span class="bu">std::</span>string&gt;{{<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>}, {<span class="st">&quot;3&quot;</span>, <span class="st">&quot;4&quot;</span>, <span class="st">&quot;5&quot;</span>}};</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true"></a>            ASSERT_EQ(<span class="dv">2</span>, vv.size());</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true"></a>            ASSERT_EQ((Vect1D&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>}), vv[<span class="dv">0</span>]);</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true"></a>            ASSERT_EQ((Vect1D&lt;<span class="bu">std::</span>string&gt;{<span class="st">&quot;3&quot;</span>, <span class="st">&quot;4&quot;</span>, <span class="st">&quot;5&quot;</span>}), vv[<span class="dv">1</span>]);</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;5&quot;</span>, vv[<span class="dv">1</span>][<span class="dv">2</span>]);</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true"></a>        }</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true"></a>    }</span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_2">演習-エイリアステンプレート</a>へ戻る。</li>
</ul>
<h3 id="解答例-名前空間による修飾不要なoperator">解答例-名前空間による修飾不要なoperator&lt;&lt; <a id="SS_20_11_3"></a></h3>
<div class="sourceCode" id="cb82"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/put_to.cpp 3</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true"></a>    <span class="co">// 下記のように名前空間TemplateMP、エイリアスInts_tとそのoperator&lt;&lt;が定義されている場合、</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true"></a>    <span class="co">// 単体テストで示した通り、Ints_tのoperator&lt;&lt;を使用するためには、</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true"></a>    <span class="co">// 名前空間による修飾やusing宣言/ディレクティブの記述が必要になる。</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true"></a>    <span class="co">// Ints_tをstd::vectorから継承したクラスとして定義することにより、このような記述を不要にせよ。</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true"></a></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true"></a>    <span class="kw">namespace</span> TemplateMP {</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true"></a>    <span class="kw">struct</span> <span class="dt">Ints_t</span> : <span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt; {</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true"></a>        <span class="kw">using</span> <span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt;::vector;  <span class="co">// 継承コンストラクタ</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true"></a>    };</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true"></a></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true"></a>    <span class="bu">std::</span>ostream&amp; <span class="kw">operator</span>&lt;&lt;(<span class="bu">std::</span>ostream&amp; os, <span class="dt">Ints_t</span> <span class="at">const</span>&amp; ints)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true"></a>    {</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true"></a>        <span class="kw">auto</span> first = <span class="kw">true</span>;</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="kw">auto</span> i : ints) {</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true"></a>            <span class="cf">if</span> (!<span class="bu">std::</span>exchange(first, <span class="kw">false</span>)) {</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true"></a>                os &lt;&lt; <span class="st">&quot; : &quot;</span>;</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true"></a>            }</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true"></a>            os &lt;&lt; i;</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true"></a>        }</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true"></a></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true"></a>        <span class="cf">return</span> os;</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true"></a>    }</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true"></a>    }  <span class="co">// namespace TemplateMP</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true"></a></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, put_to)</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true"></a>    {</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true"></a>        {</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true"></a>            <span class="kw">auto</span> oss  = <span class="bu">std::</span>ostringstream{};</span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true"></a>            <span class="kw">auto</span> ints = TemplateMP::<span class="dt">Ints_t</span>{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>};</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true"></a></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true"></a>            oss &lt;&lt; ints;  <span class="co">// ADLによるname lookup</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true"></a></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true"></a>            ASSERT_EQ(<span class="st">&quot;1 : 2 : 3&quot;</span>, oss.str());</span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true"></a>        }</span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true"></a>    }</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_3">演習-名前空間による修飾不要なoperator&lt;&lt;</a>へ戻る。</li>
</ul>
<h3 id="解答例-stdarrayの継承">解答例-std::arrayの継承 <a id="SS_20_11_4"></a></h3>
<div class="sourceCode" id="cb83"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/safe_array.cpp 5</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true"></a>    <span class="co">// std::array、std::vector、std::string等のSTLの配列型コンテナはインデックスアクセスに対して、</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true"></a>    <span class="co">// レンジのチェックをしないため、不正なメモリアクセスをしてしまうことがある。</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true"></a>    <span class="co">// std::arrayを使用して、このような問題のないSafeArrayを作り、単体テストを行え。</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="bu">std::</span>size_t N&gt;</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true"></a>    <span class="kw">struct</span> SafeArray : <span class="bu">std::</span>array&lt;T, N&gt; {</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true"></a>        <span class="kw">using</span> <span class="bu">std::</span>array&lt;T, N&gt;::array;  <span class="co">// 継承コンストラクタ</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true"></a>        <span class="kw">template</span> &lt;<span class="kw">typename</span>... ARGS&gt;  <span class="co">// コンストラクタを定義</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true"></a>        SafeArray(ARGS... args) <span class="kw">noexcept</span>(<span class="bu">std::</span>is_nothrow_constructible_v&lt;T, ARGS...&gt;)</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true"></a>            : <span class="dt">base_type</span>{args...}</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true"></a>        {</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true"></a>        }</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true"></a></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true"></a>        <span class="kw">using</span> <span class="dt">base_type</span> = <span class="bu">std::</span>array&lt;T, N&gt;;</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true"></a>        <span class="kw">using</span> <span class="dt">size_type</span> = <span class="kw">typename</span> <span class="dt">base_type</span>::<span class="dt">size_type</span>;</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true"></a></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true"></a>        <span class="kw">typename</span> <span class="dt">base_type</span>::reference       <span class="kw">operator</span>[](<span class="dt">size_type</span> i) { <span class="cf">return</span> <span class="kw">this</span>-&gt;at(i); }</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true"></a>        <span class="kw">typename</span> <span class="dt">base_type</span>::const_reference <span class="kw">operator</span>[](<span class="dt">size_type</span> i) <span class="at">const</span> { <span class="cf">return</span> <span class="kw">this</span>-&gt;at(i); }</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true"></a>    };</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true"></a></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, safe_array)</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true"></a>    {</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true"></a>        <span class="kw">auto</span> sa = SafeArray&lt;<span class="dt">int</span>, <span class="dv">3</span>&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>};</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true"></a></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true"></a>        <span class="kw">static_assert</span>(<span class="bu">std::</span>is_nothrow_constructible_v&lt;<span class="kw">decltype</span>(sa), <span class="dt">int</span>&gt;);</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, sa.size());</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">1</span>, sa[<span class="dv">0</span>]);</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">2</span>, sa[<span class="dv">1</span>]);</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">3</span>, sa[<span class="dv">2</span>]);</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true"></a>        ASSERT_THROW(sa[<span class="dv">3</span>], <span class="bu">std::</span>out_of_range);</span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true"></a></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true"></a>        <span class="kw">auto</span> sa2 = SafeArray&lt;<span class="bu">std::</span>string, <span class="dv">2</span>&gt;{<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>};</span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true"></a></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!<span class="bu">std::</span>is_nothrow_constructible_v&lt;<span class="kw">decltype</span>(sa2), <span class="dt">char</span> <span class="at">const</span>*&gt;);</span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true"></a>        ASSERT_EQ(<span class="dv">2</span>, sa2.size());</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;1&quot;</span>, sa2[<span class="dv">0</span>]);</span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true"></a>        ASSERT_EQ(<span class="st">&quot;2&quot;</span>, sa2[<span class="dv">1</span>]);</span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true"></a>        ASSERT_THROW(sa2[<span class="dv">2</span>], <span class="bu">std::</span>out_of_range);</span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true"></a>    }</span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_4">演習-std::arrayの継承</a>へ戻る。</li>
</ul>
<h3 id="解答例-sfinaeを利用しない関数テンプレートの特殊化によるis_void">解答例-SFINAEを利用しない関数テンプレートの特殊化によるis_void <a id="SS_20_11_5"></a></h3>
<div class="sourceCode" id="cb84"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/is_void.cpp 3</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true"></a>    <span class="co">// 下記の仕様を満たす関数テンプレートis_void_f&lt;T&gt;と定数テンプレートis_void_f_v&lt;T&gt;を作れ。</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidの場合、trueを返す</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidでない場合、falseを返す</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true"></a>    <span class="co">//    * std::is_sameを使わない</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true"></a>    <span class="co">//    * 下記の単体テストをパスする(#if 0を削除してもコンパイルできる)</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_void_f() <span class="kw">noexcept</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true"></a>    {</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true"></a>        <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true"></a>    }</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true"></a></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true"></a>    <span class="kw">template</span> &lt;&gt;</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_void_f&lt;<span class="dt">void</span>&gt;() <span class="kw">noexcept</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true"></a>    {</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true"></a>        <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true"></a>    }</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true"></a></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_void_f_v{is_void_f&lt;T&gt;()};</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true"></a></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true"></a>    <span class="kw">namespace</span> IsVoidTest {</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true"></a>    <span class="dt">void</span>        test_func_0() <span class="kw">noexcept</span> {};</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true"></a>    <span class="bu">std::</span>string test_func_1() { <span class="cf">return</span> <span class="st">&quot;test&quot;</span>; };</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true"></a>    }  <span class="co">// namespace IsVoidTest</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true"></a></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true"></a></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, is_void_f)</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true"></a>    {</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_f_v&lt;<span class="dt">int</span>&gt;);</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_f_v&lt;<span class="dt">void</span>&gt;);</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_f_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_0())&gt;);</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_f_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_1())&gt;);</span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true"></a>    }</span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_5">演習-SFINAEを利用しない関数テンプレートの特殊化によるis_void</a>へ戻る。</li>
</ul>
<h3 id="解答例-sfinaeを利用しないクラステンプレートの特殊化によるis_void">解答例-SFINAEを利用しないクラステンプレートの特殊化によるis_void <a id="SS_20_11_6"></a></h3>
<div class="sourceCode" id="cb85"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/is_void.cpp 43</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true"></a>    <span class="co">// 下記の仕様を満たすクラステンプレートis_void_s&lt;T&gt;と定数テンプレートis_void_s_v&lt;T&gt;を作れ。</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidの場合、メンバvalueがtrueになる</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidでない場合、メンバvalueがtrueになる</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true"></a>    <span class="co">//    * std::is_sameを使わない</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true"></a>    <span class="co">//    * std::true_type/std::false_typeを利用する</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true"></a>    <span class="co">//    * 下記の単体テストをパスする(#if 0を削除してもコンパイルできる)</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true"></a>    <span class="kw">struct</span> is_void_s : <span class="bu">std::</span>false_type {</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true"></a>    };</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true"></a></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true"></a>    <span class="kw">template</span> &lt;&gt;</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true"></a>    <span class="kw">struct</span> is_void_s&lt;<span class="dt">void</span>&gt; : <span class="bu">std::</span>true_type {</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true"></a>    };</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_void_s_v{is_void_s&lt;T&gt;::value};</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true"></a></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true"></a></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, is_void_s)</span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true"></a>    {</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_s_v&lt;<span class="dt">int</span>&gt;);</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_s_v&lt;<span class="dt">void</span>&gt;);</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_s_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_0())&gt;);</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_s_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_1())&gt;);</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true"></a>    }</span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_6">演習-SFINAEを利用しないクラステンプレートの特殊化によるis_void</a>へ戻る。</li>
</ul>
<h3 id="解答例-sfinaeを利用した関数テンプレートの特殊化によるis_void">解答例-SFINAEを利用した関数テンプレートの特殊化によるis_void <a id="SS_20_11_7"></a></h3>
<div class="sourceCode" id="cb86"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/is_void.cpp 75</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true"></a>    <span class="co">// 下記の仕様を満たす関数テンプレートis_void_sfinae_f&lt;T&gt;と</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true"></a>    <span class="co">// 定数テンプレートis_void_sfinae_f&lt;T&gt;を作れ。</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidの場合、trueを返す</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidでない場合、falseを返す</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true"></a>    <span class="co">//    * std::is_sameを使わない</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true"></a>    <span class="co">//    * SFINAEを利用する</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true"></a>    <span class="co">//    * 下記の単体テストをパスする(#if 0を削除してもコンパイルできる)</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true"></a>    <span class="kw">namespace</span> Inner_ {</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true"></a>    <span class="co">// T == void</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> is_void_sfinae_f_detector(<span class="dt">void</span> <span class="at">const</span>* v, T <span class="at">const</span>* t) <span class="kw">noexcept</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true"></a>        -&gt; <span class="kw">decltype</span>(t = v, <span class="dt">bool</span>{})  <span class="co">// T != voidの場合、t = vはill-formed</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true"></a>                                    <span class="co">// T == voidの場合、well-formedでbool型生成</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true"></a>    {</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true"></a>        <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true"></a>    }</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true"></a></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="kw">auto</span> is_void_sfinae_f_detector(...) <span class="kw">noexcept</span>  <span class="co">// name lookupの順位は最低</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true"></a>    {</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true"></a>        <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true"></a>    }</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true"></a>    }  <span class="co">// namespace Inner_</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true"></a></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_void_sfinae_f() <span class="kw">noexcept</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true"></a>    {</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true"></a>        <span class="cf">return</span> Inner_::is_void_sfinae_f_detector(<span class="kw">nullptr</span>, <span class="kw">static_cast</span>&lt;T*&gt;(<span class="kw">nullptr</span>));</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true"></a>    }</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true"></a></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_void_sfinae_f_v{is_void_sfinae_f&lt;T&gt;()};</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true"></a></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true"></a></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, is_void_sfinae_f)</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true"></a>    {</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_sfinae_f_v&lt;<span class="dt">int</span>&gt;);</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_sfinae_f_v&lt;<span class="dt">void</span>&gt;);</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_sfinae_f_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_0())&gt;);</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_sfinae_f_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_1())&gt;);</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true"></a>    }</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_7">演習-SFINAEを利用した関数テンプレートの特殊化によるis_void</a>へ戻る。</li>
</ul>
<h3 id="解答例-sfinaeを利用したクラステンプレートの特殊化によるis_void">解答例-SFINAEを利用したクラステンプレートの特殊化によるis_void <a id="SS_20_11_8"></a></h3>
<div class="sourceCode" id="cb87"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/is_void.cpp 123</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true"></a>    <span class="co">// 下記の仕様を満たすクラステンプレートis_void_sfinae_s&lt;T&gt;と</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true"></a>    <span class="co">// 定数テンプレートis_void_sfinae_s_v&lt;T&gt;を作れ。</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidの場合、メンバvalueがtrueになる</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true"></a>    <span class="co">//    * 与えられたテンプレートパラメータがvoidでない場合、メンバvalueがtrueになる</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true"></a>    <span class="co">//    * std::is_sameを使わない</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true"></a>    <span class="co">//    * std::true_type/std::false_typeを利用する</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true"></a>    <span class="co">//    * SFINAEを利用する</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true"></a>    <span class="co">//    * 下記の単体テストをパスする(#if 0を削除してもコンパイルできる)</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true"></a></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true"></a>    <span class="kw">namespace</span> Inner_ {</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true"></a></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true"></a>    T*&amp; t2ptr();</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true"></a></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true"></a>    }  <span class="co">// namespace Inner_</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true"></a></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="kw">typename</span> = <span class="dt">void</span>*&amp;&gt;</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true"></a>    <span class="kw">struct</span> is_void_sfinae_s : <span class="bu">std::</span>false_type {</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true"></a>    };</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true"></a></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true"></a>    <span class="kw">struct</span> is_void_sfinae_s&lt;T, <span class="kw">decltype</span>(Inner_::t2ptr&lt;T&gt;() = Inner_::t2ptr&lt;<span class="dt">void</span>&gt;())&gt; : <span class="bu">std::</span>true_type {</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true"></a>    };</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true"></a></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_void_sfinae_s_v{is_void_sfinae_s&lt;T&gt;::value};</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true"></a></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true"></a></span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, is_void_sfinae_s)</span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true"></a>    {</span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_sfinae_s_v&lt;<span class="dt">int</span>&gt;);</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_sfinae_s_v&lt;<span class="dt">void</span>&gt;);</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_void_sfinae_s_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_0())&gt;);</span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_void_sfinae_s_v&lt;<span class="kw">decltype</span>(IsVoidTest::test_func_1())&gt;);</span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true"></a>    }</span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_8">演習-SFINAEを利用したクラステンプレートの特殊化によるis_void</a>へ戻る。</li>
</ul>
<h3 id="解答例-テンプレートテンプレートパラメータ">解答例-テンプレートテンプレートパラメータ <a id="SS_20_11_9"></a></h3>
<div class="sourceCode" id="cb88"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/template_template.cpp 5</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true"></a>    <span class="co">// 以下の仕様を満たすクラステンプレートを作れ。</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true"></a>    <span class="co">//  * 任意のSTLコンテナを唯一のテンプレートパラメータとする</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true"></a>    <span class="co">//  * そのコンテナを使用しint型のデータを格納する</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">template</span> &lt;<span class="kw">class</span>...&gt; <span class="kw">class</span> STL_CONTAINER&gt;</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true"></a>    <span class="kw">struct</span> IntContainer : STL_CONTAINER&lt;<span class="dt">int</span>&gt; {</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true"></a>        <span class="kw">using</span> STL_CONTAINER&lt;<span class="dt">int</span>&gt;::STL_CONTAINER;</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true"></a>    };</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, template_template)</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true"></a>    {</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true"></a>        <span class="kw">auto</span> vi = IntContainer&lt;<span class="bu">std::</span>vector&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>};</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true"></a>        <span class="kw">auto</span> vl = IntContainer&lt;<span class="bu">std::</span>list&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>};</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true"></a>        <span class="kw">auto</span> vs = IntContainer&lt;<span class="bu">std::</span>basic_string&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>};  <span class="co">// 意味は不明だがこれも可能</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true"></a></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}), vi);</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>list&lt;<span class="dt">int</span>&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}), vl);</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true"></a>        ASSERT_EQ((<span class="bu">std::</span>basic_string&lt;<span class="dt">int</span>&gt;{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}), vs);</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true"></a>    }</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_9">演習-テンプレートテンプレートパラメータ</a>へ戻る。</li>
</ul>
<h3 id="解答例-テンプレートパラメータを可変長にしたstdis_same">解答例-テンプレートパラメータを可変長にしたstd::is_same <a id="SS_20_11_10"></a></h3>
<div class="sourceCode" id="cb89"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/is_same.cpp 3</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true"></a>    <span class="co">// 以下の仕様を満たすクラステンプレートis_same_some_of&lt;T, U...&gt;と</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true"></a>    <span class="co">// 定数テンプレートis_same_some_of_v&lt;T, U...&gt;を作れ。</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true"></a>    <span class="co">//  * 2個以上のテンプレートパラメータを持つ</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true"></a>    <span class="co">//  * 第1パラメータと他のパラメータの何れかが同一の型であった場合、メンバvalueがtrueになる</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true"></a>    <span class="co">//  * 前行の条件が成立しなかった場合、メンバvalueがfalseになる</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true"></a>    <span class="co">//  * 型の同一性はstd::is_sameを使って判定する</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="kw">typename</span> U, <span class="kw">typename</span>... Us&gt;</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true"></a>    <span class="kw">struct</span> is_same_some_of {</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">bool</span> value{<span class="bu">std::</span>is_same_v&lt;T, U&gt; ? <span class="kw">true</span> : is_same_some_of&lt;T, Us...&gt;::value};</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true"></a>    };</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true"></a></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="kw">typename</span> U&gt;</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true"></a>    <span class="kw">struct</span> is_same_some_of&lt;T, U&gt; {</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true"></a>        <span class="at">static</span> <span class="kw">constexpr</span> <span class="dt">bool</span> value{<span class="bu">std::</span>is_same_v&lt;T, U&gt;};</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true"></a>    };</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true"></a></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="kw">typename</span> U, <span class="kw">typename</span>... Us&gt;</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_same_some_of_v{is_same_some_of&lt;T, U, Us...&gt;::value};</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true"></a></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true"></a></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, is_same_some_of)</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true"></a>    {</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_same_some_of_v&lt;<span class="dt">int</span>, <span class="dt">int8_t</span>, <span class="dt">int16_t</span>, <span class="dt">uint16_t</span>&gt;);</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_same_some_of_v&lt;<span class="dt">int</span>, <span class="dt">int8_t</span>, <span class="dt">int16_t</span>, <span class="dt">uint16_t</span>, <span class="dt">int32_t</span>&gt;);</span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_same_some_of_v&lt;<span class="dt">int</span>&amp;, <span class="dt">int8_t</span>, <span class="dt">int16_t</span>, <span class="dt">int32_t</span>&amp;, <span class="dt">int32_t</span>&gt;);</span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_same_some_of_v&lt;<span class="dt">int</span>&amp;, <span class="dt">int8_t</span>, <span class="dt">int16_t</span>, <span class="dt">uint32_t</span>&amp;, <span class="dt">int32_t</span>&gt;);</span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_same_some_of_v&lt;<span class="bu">std::</span>string, <span class="dt">int</span>, <span class="dt">char</span>*, <span class="bu">std::</span>string&gt;);</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_same_some_of_v&lt;<span class="bu">std::</span>string, <span class="dt">int</span>, <span class="dt">char</span>*&gt;);</span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true"></a>    }</span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_10">演習-テンプレートパラメータを可変長にしたstd::is_same</a>へ戻る。</li>
</ul>
<h3 id="解答例-メンバ関数の存在の診断">解答例-メンバ関数の存在の診断 <a id="SS_20_11_11"></a></h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/exists_func.cpp 5</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true"></a>    <span class="co">// テンプレートパラメータの型がメンバ関数c_str()を持つか否かを判定する</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true"></a>    <span class="co">// クラステンプレートhas_c_str&lt;T&gt;と定数テンプレートhas_c_str_v&lt;T&gt;を作れ。</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="kw">typename</span> U = <span class="dt">bool</span>&gt;</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true"></a>    <span class="kw">struct</span> has_c_str : <span class="bu">std::</span>false_type {</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true"></a>    };</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true"></a>    <span class="kw">struct</span> has_c_str&lt;T, <span class="kw">decltype</span>(<span class="bu">std::</span>declval&lt;T&gt;().c_str(), <span class="dt">bool</span>{})&gt; : <span class="bu">std::</span>true_type {</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true"></a>    };</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true"></a></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> has_c_str_v{has_c_str&lt;T&gt;::value};</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true"></a></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true"></a></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, has_c_str)</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true"></a>    {</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true"></a>        <span class="kw">static_assert</span>(has_c_str_v&lt;<span class="bu">std::</span>string&gt;);</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!has_c_str_v&lt;<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt;&gt;);</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true"></a>    }</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_11">演習-メンバ関数の存在の診断</a>へ戻る。</li>
</ul>
<h3 id="解答例-範囲for文のオペランドになれるかどうかの診断">解答例-範囲for文のオペランドになれるかどうかの診断 <a id="SS_20_11_12"></a></h3>
<div class="sourceCode" id="cb91"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/exists_func.cpp 31</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true"></a>    <span class="co">// 範囲for文は、</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true"></a>    <span class="co">//      for(auto a : obj ) { ... }</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true"></a>    <span class="co">// のような形式で表現される。</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true"></a>    <span class="co">// テンプレートパラメータから生成されたオブジェクトが、</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true"></a>    <span class="co">// このobjに指定できるか否かを判定するクラステンプレートis_range&lt;T&gt;</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true"></a>    <span class="co">// と定数テンプレートis_range_v&lt;T&gt;を作れ。</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true"></a>    <span class="co">// 解説</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true"></a>    <span class="co">// 上記objに指定できるための条件は、std::begin()、std::end()の引数になれることとした。</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true"></a>    <span class="co">// セマンティクス的に正しいstd::begin()、std::end()は、それぞれが最初と最後を表す</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true"></a>    <span class="co">// イテレータ(もしくはポインタ)でなければならないが、それはテンプレートでの判定の範囲外である。</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span>, <span class="kw">typename</span> = <span class="dt">bool</span>&gt;</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true"></a>    <span class="kw">struct</span> exists_begin : <span class="bu">std::</span>false_type {</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true"></a>    };</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true"></a></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true"></a>    <span class="kw">struct</span> exists_begin&lt;T, <span class="kw">decltype</span>(<span class="bu">std::</span>begin(<span class="bu">std::</span>declval&lt;T&amp;&gt;()), <span class="dt">bool</span>{})&gt; : <span class="bu">std::</span>true_type {</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true"></a>    };</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true"></a></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> exists_begin_v{exists_begin&lt;T&gt;::value};</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true"></a></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span>, <span class="kw">typename</span> = <span class="dt">bool</span>&gt;</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true"></a>    <span class="kw">struct</span> exists_end : <span class="bu">std::</span>false_type {</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true"></a>    };</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true"></a></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true"></a>    <span class="kw">struct</span> exists_end&lt;T, <span class="kw">decltype</span>(<span class="bu">std::</span>end(<span class="bu">std::</span>declval&lt;T&amp;&gt;()), <span class="dt">bool</span>{})&gt; : <span class="bu">std::</span>true_type {</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true"></a>    };</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true"></a></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> exists_end_v{exists_end&lt;T&gt;::value};</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true"></a></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true"></a>    <span class="kw">struct</span> is_range</span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true"></a>        : <span class="bu">std::</span>conditional_t&lt;exists_begin_v&lt;T&gt; &amp;&amp; exists_end_v&lt;T&gt;, <span class="bu">std::</span>true_type, <span class="bu">std::</span>false_type&gt; {</span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true"></a>    };</span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true"></a></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T&gt;</span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">bool</span> is_range_v{is_range&lt;T&gt;::value};</span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true"></a></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true"></a></span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, is_range)</span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true"></a>    {</span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_range_v&lt;<span class="bu">std::</span>string&gt;);</span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true"></a>        <span class="kw">static_assert</span>(is_range_v&lt;<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt;&gt;);</span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_range_v&lt;<span class="bu">std::</span>mutex&gt;);</span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true"></a>        <span class="kw">static_assert</span>(!is_range_v&lt;<span class="bu">std::</span>lock_guard&lt;<span class="bu">std::</span>mutex&gt;&gt;);</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true"></a>    }</span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_12">演習-範囲for文のオペランドになれるかどうかの診断</a>へ戻る。</li>
</ul>
<h3 id="解答例-配列の長さの取り出し">解答例-配列の長さの取り出し <a id="SS_20_11_13"></a></h3>
<div class="sourceCode" id="cb92"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/array_op.cpp 3</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true"></a>    <span class="co">// 配列を引数に取り、その長さを返す関数テンプレートarray_lengthを作れ。</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="dt">size_t</span> N&gt;</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">size_t</span> array_length(T <span class="at">const</span> (&amp;)[N]) <span class="kw">noexcept</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true"></a>    {</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true"></a>        <span class="cf">return</span> N;</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true"></a>    }</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, array_length)</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true"></a>    {</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true"></a>        <span class="dt">int</span>         i[<span class="dv">5</span>];</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true"></a>        <span class="bu">std::</span>string str[]{<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>};</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true"></a></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true"></a>        <span class="kw">static_assert</span>(array_length(i) == <span class="dv">5</span>);</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true"></a>        <span class="kw">static_assert</span>(array_length(str) == <span class="dv">3</span>);</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true"></a>    }</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_13">演習-配列の長さの取り出し</a>へ戻る。</li>
</ul>
<h3 id="解答例-配列の次元の取り出し">解答例-配列の次元の取り出し <a id="SS_20_11_14"></a></h3>
<div class="sourceCode" id="cb93"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/array_op.cpp 26</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true"></a>    <span class="co">// 配列を引数に取り、その次元を返す関数テンプレートarray_dimensionを作れ。</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">size_t</span> array_dimension(...) <span class="kw">noexcept</span> { <span class="cf">return</span> <span class="dv">0</span>; }</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> T, <span class="dt">size_t</span> N&gt;</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true"></a>    <span class="kw">constexpr</span> <span class="dt">size_t</span> array_dimension(T <span class="at">const</span> (&amp;t)[N]) <span class="kw">noexcept</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true"></a>    {</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true"></a>        <span class="cf">return</span> <span class="dv">1</span> + array_dimension(t[<span class="dv">0</span>]);</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true"></a>    }</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true"></a></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true"></a></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, array_dimension)</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true"></a>    {</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true"></a>        <span class="kw">constexpr</span> <span class="dt">int</span> i1[<span class="dv">5</span>]{};</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true"></a>        <span class="kw">constexpr</span> <span class="dt">int</span> i2[<span class="dv">5</span>][<span class="dv">2</span>]{};</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true"></a>        <span class="kw">constexpr</span> <span class="dt">int</span> i3[<span class="dv">5</span>][<span class="dv">2</span>][<span class="dv">3</span>]{};</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true"></a></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true"></a>        <span class="kw">static_assert</span>(array_dimension(i1) == <span class="dv">1</span>);</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true"></a>        <span class="kw">static_assert</span>(array_dimension(i2) == <span class="dv">2</span>);</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true"></a>        <span class="kw">static_assert</span>(array_dimension(i3) == <span class="dv">3</span>);</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true"></a>    }</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_14">演習-配列の次元の取り出し</a>へ戻る。</li>
</ul>
<h3 id="解答例-関数型のテンプレートパラメータを持つクラステンプレート">解答例-関数型のテンプレートパラメータを持つクラステンプレート <a id="SS_20_11_15"></a></h3>
<div class="sourceCode" id="cb94"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true"></a>    <span class="co">// @@@ exercise/template_a/scoped_guard.cpp 8</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true"></a>    <span class="co">// [A]</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true"></a>    <span class="co">// RAIIを行うための下記クラスscoped_guardをstd::functionを使わずに再実装せよ。</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true"></a>    <span class="kw">template</span> &lt;<span class="kw">typename</span> FUNC&gt;</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true"></a>    <span class="kw">class</span> scoped_guard {</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true"></a>    <span class="kw">public</span>:</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true"></a>        <span class="kw">explicit</span> scoped_guard(FUNC&amp;&amp; f) <span class="kw">noexcept</span> : <span class="va">f_</span>{f}</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true"></a>        {</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true"></a>            <span class="kw">static_assert</span>(<span class="bu">std::</span>is_nothrow_invocable_r_v&lt;<span class="dt">void</span>, FUNC&gt;, <span class="st">&quot;FUNC()() must return void&quot;</span>);</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true"></a>        }</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true"></a>        ~scoped_guard() { <span class="va">f_</span>(); }</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true"></a></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true"></a>        scoped_guard(scoped_guard <span class="at">const</span>&amp;)   = <span class="kw">delete</span>;   <span class="co">// copy禁止</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true"></a>        scoped_guard(scoped_guard&amp;&amp;)        = <span class="cf">default</span>;  <span class="co">// move</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true"></a>        <span class="dt">void</span> <span class="kw">operator</span>=(scoped_guard <span class="at">const</span>&amp;) = <span class="kw">delete</span>;   <span class="co">// copy代入禁止</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true"></a>        <span class="dt">void</span> <span class="kw">operator</span>=(scoped_guard&amp;&amp;)      = <span class="kw">delete</span>;   <span class="co">// move代入禁止</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true"></a></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true"></a>    <span class="kw">private</span>:</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true"></a>        FUNC <span class="va">f_</span>;</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true"></a>    };</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true"></a></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true"></a>    <span class="kw">namespace</span> {</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true"></a></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true"></a>    TEST(TemplateMetaProgrammingA, scoped_guard)</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true"></a>    {</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true"></a>        {</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true"></a>            <span class="kw">auto</span> demangled = abi::__cxa_demangle(<span class="kw">typeid</span>(<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt;).name(), <span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">nullptr</span>);</span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true"></a>            <span class="kw">auto</span> f         = [demangled]() <span class="kw">noexcept</span> { free(demangled); };</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true"></a>            <span class="kw">auto</span> sg        = scoped_guard&lt;<span class="kw">decltype</span>(f)&gt;{<span class="bu">std::</span>move(f)};  <span class="co">// C++14までの記法</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true"></a></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true"></a>            ASSERT_STREQ(<span class="st">&quot;std::vector&lt;int, std::allocator&lt;int&gt; &gt;&quot;</span>, demangled);</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true"></a>        }</span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true"></a>        {</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true"></a>            <span class="kw">auto</span> demangled = abi::__cxa_demangle(<span class="kw">typeid</span>(<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt;).name(), <span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">nullptr</span>);</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true"></a>            <span class="kw">auto</span> gs = scoped_guard{[demangled]() <span class="kw">noexcept</span> { free(demangled); }};  <span class="co">// C++17からの記法</span></span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true"></a></span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true"></a>            ASSERT_STREQ(<span class="st">&quot;std::vector&lt;int, std::allocator&lt;int&gt; &gt;&quot;</span>, demangled);</span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true"></a>        }</span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true"></a>        {</span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true"></a>            <span class="kw">auto</span> stream = popen(<span class="st">&quot;ls &quot;</span> <span class="ot">__FILE__</span>, <span class="st">&quot;r&quot;</span>);</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true"></a>            <span class="kw">auto</span> f      = [stream]() <span class="kw">noexcept</span> { fclose(stream); };</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true"></a>            <span class="kw">auto</span> sg     = scoped_guard&lt;<span class="kw">decltype</span>(f)&gt;{<span class="bu">std::</span>move(f)};  <span class="co">// C++14までの記法</span></span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true"></a></span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true"></a>            <span class="dt">char</span> buff[<span class="dv">256</span>]{};</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true"></a>            fgets(buff, <span class="kw">sizeof</span>(buff) - <span class="dv">1</span>, stream);</span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true"></a></span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true"></a>            ASSERT_STREQ(<span class="st">&quot;scoped_guard.cpp</span><span class="sc">\n</span><span class="st">&quot;</span>, buff);</span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true"></a>        }</span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true"></a>        {</span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true"></a>            <span class="kw">auto</span> stream = popen(<span class="st">&quot;ls &quot;</span> <span class="ot">__FILE__</span>, <span class="st">&quot;r&quot;</span>);</span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true"></a>            <span class="kw">auto</span> gs = scoped_guard{[stream]() <span class="kw">noexcept</span> { fclose(stream); }};  <span class="co">// C++17からの記法</span></span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true"></a></span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true"></a>            <span class="dt">char</span> buff[<span class="dv">256</span>]{};</span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true"></a>            fgets(buff, <span class="kw">sizeof</span>(buff) - <span class="dv">1</span>, stream);</span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true"></a></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true"></a>            ASSERT_STREQ(<span class="st">&quot;scoped_guard.cpp</span><span class="sc">\n</span><span class="st">&quot;</span>, buff);</span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true"></a>        }</span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true"></a>    }</span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true"></a>    }  <span class="co">// namespace</span></span></code></pre></div>
<ul>
<li><a href="exercise_q.html#SS_19_11_15">演習-関数型のテンプレートパラメータを持つクラステンプレート</a>へ戻る。</li>
</ul>
</body>
</html>
